<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaxC | Ebooks</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="icon" href="./favicon.ico">
    <link rel="manifest" href="./site.webmanifest">

    <link rel="stylesheet" href="styles/animations.css">

    <script src="https://js.paystack.co/v2/inline.js"></script>

  <style>

  .chat-clear {
  position: absolute;
  right: 44px; /* Moves it left of the X */
  top: 50%;
  transform: translateY(-50%);
  background: #dc3545; /* Red */
  color: #fff;
  border: none;
  font-size: 0.75rem; /* Smaller text */
  padding: 4px 8px; /* Smaller button */
  border-radius: 4px;
  cursor: pointer;
  opacity: 0.9;
}
.chat-clear:hover {
  opacity: 1;
  background: #c82333;
}

/* MOBILE FIX: Move Clear further left + smaller */
@media (max-width: 480px) {
  .chat-clear {
    right: 35px; /* Closer to center on mobile */
    font-size: 0.7rem; /* Even smaller text */
    padding: 2px 6px; /* Tighter padding */
  }
  .chat-header {
    padding: 10px 8px; /* Less padding on mobile */
    font-size: 0.9rem; /* Smaller title text */
  }
  .chat-close {
    right: 5px; /* X closer to edge */
    font-size: 1.2rem; /* Slightly smaller X */
  }
}

    :root {
  --green: #28A745;
  --dark-green: #218838;
  --soft: #F8F9FA;
  --muted: #6c757d;
  --card: #ffffff;
  --main-color: #28A745;
  --dark-text: #343A40;
}
    /* === GLOBAL & REUSED FROM INDEX.HTML === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #F8F9FA;
      color: #343A40;
      line-height: 1.6;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
    a { text-decoration: none; }
    button { font-family: inherit; }

    /* === HEADER === */
    .main-header {
      background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 5px 20px; display: flex; justify-content: space-between;
      align-items: center; position: sticky; top: 0; z-index: 100;
    }
    .logo { font-size: 1.8rem; font-weight: 700; color: #28A745; display: flex; align-items: center; gap: 8px; }
    .logo-icon { height: 24px; width: 24px; }
    .desktop-nav { display: none; }
    .desktop-nav a { color: #343A40; padding: 8px 15px; font-weight: 600; transition: color 0.3s; }
    .desktop-nav a:hover { color: #28A745; }

    .cta-small {
  background: var(--green);
  color: #fff;
  padding: 8px 14px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}
.cta-small:hover {
  background: var(--dark-green);
}
        /* === HAMBURGER MENU (FIXED & ANIMATED) === */
    #hamburger {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      z-index: 101;
    }

    .hamburger-box {
      width: 28px;
      height: 20px;
      display: inline-block;
      position: relative;
    }

    .hamburger-inner {
      display: block;
      top: 50%;
      margin-top: -1px;
    }

    .hamburger-inner,
    .hamburger-inner::before,
    .hamburger-inner::after {
      width: 28px;
      height: 2px;
      background-color: #343A40;
      border-radius: 2px;
      position: absolute;
      transition: transform 0.15s ease;
    }

    .hamburger-inner::before,
    .hamburger-inner::after {
      content: "";
      display: block;
    }

    .hamburger-inner::before { top: -8px; }
    .hamburger-inner::after { bottom: -8px; }

    /* === ACTIVE STATE → X === */
    .hamburger.is-active .hamburger-inner {
      transform: rotate(45deg);
      background-color: #28A745;
    }

    .hamburger.is-active .hamburger-inner::before {
      transform: translate3d(0, 8px, 0) rotate(-90deg);
      background-color: #28A745;
    }

    .hamburger.is-active .hamburger-inner::after {
      transform: translate3d(0, -8px, 0) rotate(-90deg);
      background-color: #28A745;
    }
    .mobile-menu { display: none; position: absolute; top: 100%; left: 0; right: 0;
      background: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-direction: column; z-index: 99; }
    .mobile-menu[open] { display: flex; }
    .mobile-menu a { padding: 12px 20px; border-bottom: 1px solid #eee; color: #343A40; font-weight: 600; }
    .mobile-menu a:hover { color: #28A745; }

    /* === HERO === */
    .hero-section {
      text-align: center; padding: 60px 20px; background: #fff;
      border-bottom: 5px solid #28A745; border-radius: 10px; margin: 20px;
    }
    .hero-section h1 { font-size: 2.8rem; color: #28A745; margin-bottom: 16px; font-weight: 700; }
    .hero-section p { font-size: 1.2rem; color: #555; max-width: 700px; margin: 0 auto 24px; }
    .cta-button {
      display: inline-block; padding: 14px 32px; background: #28A745; color: white;
      border-radius: 50px; font-weight: 600; transition: all 0.3s;
    }
    .cta-button:hover { background: #218838; transform: translateY(-2px); }

    /* === FILTER BAR === */
    .filter-bar {
      padding: 30px 0; display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
      border-bottom: 1px solid #eee; margin-bottom: 30px;
    }
    .filter-btn {
      padding: 8px 16px; border: 1px solid #28A745; border-radius: 50px;
      background: white; color: #28A745; font-weight: 600; cursor: pointer; transition: all 0.3s;
    }
    .filter-btn.active, .filter-btn:hover {
      background: #28A745; color: white;
    }
    .search-input {
      padding: 10px 16px; border: 1px solid #ddd; border-radius: 50px; flex: 1; min-width: 200px;
      font-size: 0.95rem;
    }

    .search-wrapper {
  position: relative;
  flex: 1;
  min-width: 200px;
  max-width: 100%;
}

.search-input {
  width: 100%;
  padding: 10px 40px 10px 16px; /* Extra right padding for X */
  border: 1px solid #ddd;
  border-radius: 50px;
  font-size: 0.95rem;
  outline: none;
  transition: border 0.3s;
}

.search-input:focus {
  border-color: #28A745;
  box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
}

.clear-search-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 1.4rem;
  color: #999;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.clear-search-btn:hover {
  background: #f1f1f1;
  color: #333;
}

.clear-search-btn:focus {
  outline: 2px solid #28A745;
}

    /* === EBOOK GRID === */
    .ebooks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
  margin-bottom: 40px;
  width: 100%;
  min-width: 0;
}

.ebook-card {
  background: white; border-radius: 12px; overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s;
  cursor: pointer;
  width: 100%;
  min-width: 0;
}
.ebook-card:hover {
  transform: translateY(-6px); box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}
    .ebook-card {
      background: white; border-radius: 12px; overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    .ebook-card:hover {
      transform: translateY(-6px); box-shadow: 0 12px 25px rgba(0,0,0,0.15);
    }
    .ebook-cover {
      height: 200px; object-fit: cover; width: 100%;
    }
    .ebook-body {
      padding: 20px;
    }
    .ebook-title {
      font-size: 1.15rem; font-weight: 700; margin-bottom: 8px; color: #28A745;
    }
    .ebook-author {
      font-size: 0.9rem; color: #666; margin-bottom: 12px;
    }
    .ebook-desc {
      font-size: 0.95rem; color: #444; margin-bottom: 16px; display: -webkit-box;
      -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
    }
    .ebook-badge {
      display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem;
      font-weight: 600; margin-bottom: 12px;
    }
    .badge-free { background: #e6ffe6; color: #28A745; }
    .badge-paid { background: #fff3cd; color: #d49b00; }
    .ebook-btn {
      width: 100%; padding: 12px; border: none; border-radius: 6px;
      font-weight: 600; cursor: pointer; transition: background 0.3s;
    }
    .btn-free { background: #28A745; color: white; }
    .btn-free:hover { background: #218838; }
    .btn-paid { background: #ffc107; color: #212529; }
    .btn-paid:hover { background: #e0a800; }

    /* === MY LIBRARY === */
    .library-section {
      background: white; border-radius: 12px; padding: 24px; margin-bottom: 40px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .library-header {
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
      padding-bottom: 12px; border-bottom: 1px solid #eee;
    }
    .library-title { font-size: 1.3rem; font-weight: 700; color: #28A745; }
    .library-toggle { font-size: 1.5rem; color: #28A745; }
    .library-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;
      margin-top: 20px; display: none;
    }
    .library-grid.open { display: grid; }
    .library-item {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      background: #f8f9fa; border-radius: 8px;
    }
    .library-cover { width: 50px; height: 70px; object-fit: cover; border-radius: 6px; }
    .library-info { flex: 1; }
    .library-name { font-weight: 600; font-size: 0.95rem; }
    .library-type { font-size: 0.8rem; color: #28A745; }
    .library-btn {
      padding: 6px 12px; background: #28A745; color: white; border: none;
      border-radius: 6px; font-size: 0.8rem; cursor: pointer;
    }

    /* === MODALS === */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal.open { display: flex; }
    .modal-content {
      background: white; border-radius: 16px; width: 90%; max-width: 500px;
      max-height: 90vh; overflow-y: auto; position: relative;
    }
    .modal-header {
      padding: 20px; text-align: center; border-bottom: 1px solid #eee;
    }
    .modal-header h3 { font-size: 1.4rem; color: #28A745; margin-bottom: 8px; }
    .modal-body { padding: 20px; }
    .modal-cover { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 16px; }
    .modal-bullets { margin: 16px 0; padding-left: 20px; }
    .modal-bullets li { margin-bottom: 8px; }
    .modal-price { font-size: 1.5rem; font-weight: 700; color: #28A745; text-align: center; margin: 16px 0; }
    .modal-btn {
      width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600;
      cursor: pointer; margin-top: 12px;
    }
    .btn-download { background: #28A745; color: white; }
    .modal-close {
      position: absolute; top: 12px; right: 16px; background: none; border: none;
      font-size: 1.5rem; color: #999; cursor: pointer;
    }

    /* === FLOATING CHAT (MESSAGE ICON + TOOLTIP) === */
#taxc-chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
}

/* ——— ANIMATED FLOATING AI ICON (Makes users KNOW they can click it!) ——— */
.chat-launcher {
  position: relative;
  width: 60px;
  height: 60px;
  background: #28A745;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
  transition: all 0.3s ease;
  animation: float 6s ease-in-out infinite, pulseGlow 2s ease-in-out infinite alternate;
  z-index: 10001;
}

/* Gentle floating up & down */
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}

/* Subtle glowing pulse */
@keyframes pulseGlow {
  from { box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4); }
  to { box-shadow: 0 8px 30px rgba(40, 167, 69, 0.7); }
}

/* Hover = bigger jump + brighter glow */
.chat-launcher:hover {
  transform: translateY(-16px) scale(1.1) !important;
  box-shadow: 0 12px 40px rgba(40, 167, 69, 0.8);
  background: #218838;
}

/* Optional: tiny bounce when page loads */
@keyframes bounceIn {
  0% { transform: scale(0.3); opacity: 0; }
  50% { transform: scale(1.1); }
  70% { transform: scale(0.95); }
  100% { transform: scale(1); opacity: 1; }
}

.chat-launcher {
  animation: bounceIn 1s ease-out, float 6s ease-in-out infinite 1s, pulseGlow 2s ease-in-out infinite alternate;
}

/* Mobile: slightly smaller but still animated */
@media (max-width: 480px) {
  .chat-launcher {
    width: 55px;
    height: 55px;
  }
  .chat-launcher svg { width: 24px; height: 24px; }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }
}

.chat-tooltip {
  position: absolute;
  right: 70px;
  top: 50%;
  transform: translateY(-50%);
  background: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  pointer-events: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.chat-tooltip::after {
  content: '';
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  border: 6px solid transparent;
  border-left-color: #333;
}

.chat-launcher:hover .chat-tooltip {
  opacity: 1;
  visibility: visible;
  right: 68px;
}

.chat-window {
  display: none;
  width: 340px;
  height: 520px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  flex-direction: column;
  overflow: hidden;
  border: 1px solid #eee;
}

.chat-header {
  background: #28A745;
  color: white;
  padding: 14px 90px 14px 40px; /* ⬅️ extra RIGHT padding */
  font-weight: 700;
  text-align: left;           /* ⬅️ important */
  position: relative;
}

.chat-header::before {
  content: "";
  display: inline-block;
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  margin-right: 8px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.chat-close {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: white;
  font-size: 1.4rem;
  cursor: pointer;
}

.chat-body {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  background: #f8f9fa;
}

.message {
  margin: 10px 0;
  padding: 10px 14px;
  border-radius: 18px;
  max-width: 80%;
  line-height: 1.5;
  font-size: 0.95rem;
}

.user {
  background: #28A745;
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.ai {
  background: white;
  color: #333;
  border: 1px solid #eee;
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.chat-input {
  display: flex;
  padding: 10px;
  border-top: 1px solid #eee;
  background: white;
}

.chat-input input {
  flex: 1;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 25px;
  font-size: 0.95rem;
}

.chat-input button {
  margin-left: 8px;
  background: #28A745;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
}

    /* === RESPONSIVE === */
    @media (min-width: 768px) {
      .desktop-nav { display: flex; }
      #hamburger { display: none; }
    }
    @media (max-width: 480px) {
      .hero-section h1 { font-size: 2.2rem; }
      .filter-bar { flex-direction: column; align-items: stretch; }
      .search-input { min-width: auto; }
      .chat-window { width: 306px; height: 480px; }
      .chat-launcher { width: 55px; height: 55px; font-size: 1rem; }
    }

    @media (max-width: 480px) {
  .search-wrapper {
    min-width: auto;
    width: 100%;
  }
  .search-input {
    padding: 12px 44px 12px 16px;
    font-size: 1rem;
  }
}

@media (max-width: 480px) {
  .chat-tooltip {
    display: none;
  }
  .chat-launcher {
    width: 55px;
    height: 55px;
  }
  .chat-launcher svg {
    width: 24px;
    height: 24px;
  }
}

/* Fix sticky header blocking content on anchor jump */
html {
  scroll-padding-top: 80px; /* Height of your header */
}

@media (max-width: 768px) {
  html {
    scroll-padding-top: 70px;
  }
}

.reset-library-btn {
  padding: 6px 12px;
  background: #a72828;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.8rem;
  cursor: pointer;
  font-weight: 600;
}
.reset-library-btn:hover {
  background: #c82333;
}

/* ——— LOGO + GREETING PERFECT ALIGNMENT (copy to all pages) ——— */
.logo-container {
  display: flex;
  align-items: center;
  gap: 12px;
  height: 40px;                  /* locks the height so everything aligns */
}

.logo-container .logo-icon {
  height: 28px;
  width: auto;
  vertical-align: middle;
  margin-bottom: -2px;           /* tiny nudge for favicons with whitespace */
}

#userDisplay {
  display: none;                 /* hidden when not logged in */
  color: #28A745;
  font-weight: 600;
  font-size: 1.1rem;
  line-height: 1;
  margin: 0;
  white-space: nowrap;
}

/* Optional: slightly smaller greeting on very small phones */
@media (max-width: 480px) {
  #userDisplay {
    font-size: 1rem;
  }
}

/* ==== FOOTER ==== */
.main-footer {
  margin-top: 48px;
  padding: 48px 20px 32px;
  background-color: #f9f9f9;
  border-top: 1px solid #eee;
  color: var(--muted);
  font-size: 14px;
}

.footer-container {
  max-width: 1200px;
  margin: 0 auto 40px auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 40px 60px;
  padding: 0 20px 0 70px;;           /* This line fixes the alignment perfectly */
}

.footer-section h4 {
  margin: 0 0 16px;
  font-size: 16px;
  font-weight: 600;
  color: #333;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.footer-section ul { list-style: none; padding: 0; margin: 0; }
.footer-section li { margin-bottom: 10px; }

.footer-section a {
  color: var(--muted);
  text-decoration: none;
  transition: color 0.2s ease;
}

.footer-section a:hover { color: var(--green); }

.footer-bottom {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 20px 0;      /* Matches the 20px side padding */
  border-top: 1px solid #eee;
  text-align: center;
  font-size: 13px;
}

.footer-legal-links {
  margin-top: 8px;
  font-size: 12px;
  color: var(--muted);
}

.footer-legal-links a {
  color: var(--muted);
  text-decoration: none;
}

.footer-legal-links a:hover {
  color: var(--green);
  text-decoration: underline;
}

.social-links {
  display: flex;
  gap: 16px;
  margin-top: 8px;
}

.social-links a {
  color: var(--muted);
  transition: all 0.2s ease;
  opacity: 0.8;
}

.social-links a:hover {
  color: var(--green);
  opacity: 1;
  transform: translateY(-2px);
}

@media (max-width: 768px) {
  .footer-container {
    grid-template-columns: 1fr;
    text-align: center;
    gap: 40px;                    /* slightly more breathing room */
    padding: 0 20px !important;   /* ← THIS IS THE KEY: reset the 70px to normal on mobile */
  }

  .social-links {
    justify-content: center;
  }

  .main-footer {
    padding: 48px 20px 32px;
  }

  /* Optional: make headings a bit smaller on mobile for cleaner look */
  .footer-section h4 {
    font-size: 15px;
  }
}

  </style>

</head>
<body>

  <audio id="ada-message-sound" preload="auto">
  <source src="taxcaiadamessage.mp3" type="audio/mpeg">
</audio>

  <!-- HEADER -->
  <header class="main-header">
    <div class="logo-container">
  <a class="logo" href="index.html">
    <img src="./favicon.ico" alt="TaxC Logo" class="logo-icon">
    TaxC
  </a>
  <span id="userDisplay" style="display:none; color:#28A745; font-weight:600; margin-left:15px; font-size:1rem;"></span>
</div>

    <nav class="desktop-nav">
      <a href="index.html">Home</a>
      <a href="ebooks.html">Tax Lawyer</a>
      <a href="faq.html">FAQ</a>
      <a href="index.html#calculator">Calculator</a>
      <button class="cta-small" id="auth-button"></button>
      
    </nav>
    <button id="hamburger" class="hamburger" aria-label="Menu" onclick="toggleMobileMenu()">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
    <nav id="menu" class="mobile-menu">
      <a href="index.html">Home</a>
      <a href="ebooks.html">Connect with a tax lawyer</a>
      <a href="faq.html">Frequently Asked Questions</a>
      <a href="index.html#calculator">Calculator</a>
      <button class="cta-small" id="auth-button-mobile"></button>

    </nav>
  </header>

  <div class="container">

    <!-- HERO -->
     <section class="hero-section fade-in" id="heroSection">
    
  <h1>TaxC Ebooks</h1>
  <p id="heroText">Get free and premium guides to help you understand, file, and save on taxes in Nigeria.</p>
  <a href="#ebooks" class="cta-button" onclick="activateAllFilter(event)">
  Browse All 20 Ebooks
</a>
</section>

    <!-- FILTER BAR -->
    <div class="filter-bar fade-in" style="transition-delay: 0.2s;">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="free">Free (5)</button>
      <button class="filter-btn" data-filter="paid">Paid (15)</button>
      <div class="search-wrapper">
  <input type="text" class="search-input" placeholder="Search ebooks by title, or topic..." id="searchInput">
  <button id="clearSearch" class="clear-search-btn" aria-label="Clear search">×</button>
</div>
    </div>

    <!-- EBOOK GRID -->
<section id="ebooks" class="ebooks-grid">

  <!-- === 5 FREE EBOOKS === -->
      <div class="ebook-card fade-in" data-type="free" data-title="Who Pays Tax in Nigeria?">
        <img src="./covers/who-pays-tax.png" alt="Who Pays Tax in Nigeria?" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-free">FREE</div>
          <h3 class="ebook-title">Who Pays Tax in Nigeria?</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Is it only salary earners? What about traders, landlords, and freelancers? Get the facts.</p>
          <button class="ebook-btn btn-free" onclick="downloadFree('Who Pays Tax in Nigeria?', 'Who_Pays_Tax_in_Nigeria_TaxC.pdf')">Download Free</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="free" data-title="What is Personal Income Tax (P.I.T.)?">
        <img src="./covers/what-is-pit.png" alt="What is Personal Income Tax (P.I.T.)?" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-free">FREE</div>
          <h3 class="ebook-title">What is Personal Income Tax (P.I.T.)?</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">The complete beginner’s guide to Nigeria’s income tax system.</p>
          <button class="ebook-btn btn-free" onclick="downloadFree('What is Personal Income Tax (P.I.T.)?', 'What_is_Personal_Income_Tax_TaxC.pdf')">Download Free</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="free" data-title="Am I Tax Eligible? (Quick Quiz)">
        <img src="./covers/am-i-tax-eligible.png" alt="Am I Tax Eligible? (Quick Quiz)" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-free">FREE</div>
          <h3 class="ebook-title">Am I Tax Eligible? (Quick Quiz)</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Answer 5 questions and know instantly if you should be paying tax.</p>
          <button class="ebook-btn btn-free" onclick="downloadFree('Am I Tax Eligible? (Quick Quiz)', 'Am_I_Tax_Eligible_TaxC.pdf')">Download Free</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="free" data-title="Top 5 Tax Myths Nigerians Believe">
        <img src="./covers/tax-myths.png" alt="Top 5 Tax Myths Nigerians Believe" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-free">FREE</div>
          <h3 class="ebook-title">Top 5 Tax Myths Nigerians Believe</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">“Tax is only for rich people”...and 4 other lies exposed.</p>
          <button class="ebook-btn btn-free" onclick="downloadFree('Top 5 Tax Myths Nigerians Believe', 'Top_5_Tax_Myths_Nigerians_Believe_TaxC.pdf')">Download Free</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="free" data-title="How Much Tax Should I Pay? (Mini Guide)">
        <img src="./covers/tax-pay.png" alt="How Much Tax Should I Pay? (Mini Guide)" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-free">FREE</div>
          <h3 class="ebook-title">How Much Tax Should I Pay? (Mini Guide)</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Manual formula to estimate your tax in 5 minutes.</p>
          <button class="ebook-btn btn-free" onclick="downloadFree('How Much Tax Should I Pay? (Mini Guide)', 'How_Much_Tax_Should_I_Pay_TaxC.pdf')">Download Free</button>
        </div>
      </div>

      <!-- === 15 PAID EBOOKS === -->
      <div class="ebook-card fade-in" data-type="paid" data-title="How to Legally Minimize Your Tax">
        <img src="./covers/minimize-tax.png" alt="How to Legally Minimize Your Tax" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦3,900</div>
          <h3 class="ebook-title">How to Legally Minimize Your Tax</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Proven strategies to reduce your tax bill <em>legally</em>.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('How to Legally Minimize Your Tax', 3900, 'minimize-tax.pdf')">Buy for ₦3,900</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="How Do I File My Tax by State IRS?">
        <img src="./covers/file-tax.png" alt="How Do I File My Tax by State IRS?" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦2,900</div>
          <h3 class="ebook-title">How Do I File My Tax by State IRS?</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">37 states + FCT: portals, forms, deadlines, penalties.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('How Do I File My Tax by State IRS?', 2900, 'file-tax-by-state.pdf')">Buy for ₦2,900</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="What is Tax Evasion? (Avoid Jail)">
        <img src="./covers/tax-evasion.png" alt="What is Tax Evasion? (Avoid Jail)" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,900</div>
          <h3 class="ebook-title">What is Tax Evasion? (Avoid Jail)</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Real cases, fines, jail time, and how to stay safe.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('What is Tax Evasion? (Avoid Jail)', 1900, 'tax-evasion.pdf')">Buy for ₦1,900</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Self-Employed Tax Guide">
        <img src="./covers/tax-guide.png" alt="Self-Employed Tax Guide" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦2,500</div>
          <h3 class="ebook-title">Self-Employed Tax Guide</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Register, file, and pay tax as a freelancer or gig worker.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Self-Employed Tax Guide', 2500, 'self-employed-tax.pdf')">Buy for ₦2,500</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Rental Income Tax for Landlords">
        <img src="./covers/rental-income.png" alt="Rental Income Tax for Landlords" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,900</div>
          <h3 class="ebook-title">Rental Income Tax for Landlords</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">10% WHT, filing, deductions. Everything landlords need.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Rental Income Tax for Landlords', 1900, 'rental-tax.pdf')">Buy for ₦1,900</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Salary Earner’s Tax Handbook 2025">
        <img src="./covers/handbook.png" alt="Salary Earner’s Tax Handbook 2025" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,900</div>
          <h3 class="ebook-title">Salary Earner’s Tax Handbook 2025</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">PAYE, reliefs, refunds. Updated for 2025.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Salary Earner’s Tax Handbook 2025', 1900, 'salary-tax-2025.pdf')">Buy for ₦1,900</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="How to Claim Tax Refunds">
        <img src="./covers/tax-refunds.png" alt="How to Claim Tax Refunds" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,900</div>
          <h3 class="ebook-title">How to Claim Tax Refunds</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Overpaid? Get your money back from FIRS/SIRS.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('How to Claim Tax Refunds', 1900, 'claim-refund.pdf')">Buy for ₦1,900</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="PIT vs CIT for Business Owners">
        <img src="./covers/pit-cit.png" alt="PIT vs CIT for Business Owners" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦5,900</div>
          <h3 class="ebook-title">PIT vs CIT for Business Owners</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Sole prop vs company. Which saves more tax?</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('PIT vs CIT for Business Owners', 2800, 'pit-vs-cit.pdf')">Buy for ₦2,800</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Pension & NHF Tax Reliefs">
        <img src="./covers/nhf-tax.png" alt="Pension & NHF Tax Reliefs" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,900</div>
          <h3 class="ebook-title">Pension & NHF Tax Reliefs</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">8% + 2.5% = huge tax savings. How to claim.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Pension & NHF Tax Reliefs', 1900, 'pension-nhf.pdf')">Buy for ₦1,900</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="How to Fill Form A (Annual Return)">
        <img src="./covers/form-a.png" alt="How to Fill Form A (Annual Return)" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,500</div>
          <h3 class="ebook-title">How to Fill Form A (Annual Return)</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Step-by-step with screenshots. No more confusion.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('How to Fill Form A (Annual Return)', 1500, 'form-a-guide.pdf')">Buy for ₦1,500</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Tax Audit Survival Guide">
        <img src="./covers/tax-audit.png" alt="Tax Audit Survival Guide" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦2,200</div>
          <h3 class="ebook-title">Tax Audit Survival Guide</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">What FIRS/SIRS looks for, and how to pass.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Tax Audit Survival Guide', 2200, 'tax-audit.pdf')">Buy for ₦2,200</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="WHT Credit Mastery">
        <img src="./covers/wht-credit.png" alt="WHT Credit Mastery" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,300</div>
          <h3 class="ebook-title">WHT Credit Mastery</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Turn 5%/10% withholding into tax savings.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('WHT Credit Mastery', 1300, 'wht-credit.pdf')">Buy for ₦1,300</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Tax for Digital Nomads">
        <img src="./covers/digital-nomads.png" alt="Tax for Digital Nomads" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦2,000</div>
          <h3 class="ebook-title">Tax for Digital Nomads</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Work for US/UK company? Here’s your tax rule.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Tax for Digital Nomads', 2000, 'digital-nomad-tax.pdf')">Buy for ₦2,000</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Marriage, Kids & Tax Reliefs">
        <img src="./covers/tax-reliefs.png" alt="Marriage, Kids & Tax Reliefs" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦1,400</div>
          <h3 class="ebook-title">Marriage, Kids & Tax Reliefs</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Child relief, spouse allowance. Save thousands.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Marriage, Kids & Tax Reliefs', 1400, 'family-tax.pdf')">Buy for ₦1,400</button>
        </div>
      </div>

      <div class="ebook-card fade-in" data-type="paid" data-title="Pay Zero Tax Legally (₦800K Exemption)">
        <img src="./covers/zero-tax.png" alt="Pay Zero Tax Legally (₦800K Exemption)" class="ebook-cover">
        <div class="ebook-body">
          <div class="ebook-badge badge-paid">₦4,900</div>
          <h3 class="ebook-title">Pay Zero Tax Legally (₦800K Exemption)</h3>
          <p class="ebook-author">TaxC Team</p>
          <p class="ebook-desc">Earn up to ₦800K/year? Pay ₦0 tax. Here’s how.</p>
          <button class="ebook-btn btn-paid" onclick="openPaidModal('Pay Zero Tax Legally (₦800K Exemption)', 4900, 'zero-tax.pdf')">Buy for ₦4,900</button>
        </div>
      </div>

    </section>

    <!-- MY LIBRARY -->
    <section class="library-section fade-in">
      <div class="library-header" onclick="toggleLibrary()">
        <h3 class="library-title">My Library (0)</h3>
        <span class="library-toggle">Show</span>
      </div>
      <button class="reset-library-btn" onclick="showResetWarning(event)">Reset</button>
      <div class="library-grid" id="libraryGrid"></div>
    </section>

<!-- ADD AFTER </div> of paidModal -->
<div id="resetModal" class="modal">
  <div class="modal-content" style="max-width:400px; text-align:center;">
    <button class="modal-close" onclick="closeModal('resetModal')">×</button>
    <div class="modal-header">
      <h3>Reset Library?</h3>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px; color:#d00;">
        This will <strong>remove all ebooks</strong> from your library.
      </p>
      <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">
        Only removes from this browser. Files stay in your Downloads.
      </p>
      <button class="modal-btn" style="background:#dc3545; margin-right:8px;" onclick="resetLibraryConfirm()">Yes, Clear All</button>
      <button class="modal-btn btn-download" onclick="closeModal('resetModal')">Cancel</button>
    </div>
  </div>
</div>

  <div id="paidModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('paidModal')">×</button>
    <div class="modal-header">
      <h3 id="paidTitle"></h3>
    </div>
    <div class="modal-body">
      <img id="paidCover" class="modal-cover" src="" alt="">
      <div class="modal-price" id="paidPrice"></div>

      <!-- THIS WAS MISSING — ADD THIS BLOCK -->
      <ul class="modal-bullets" style="margin: 20px 0; padding-left: 22px; line-height: 1.7;">
        <!-- Bullets will be injected here by JavaScript -->
      </ul>

      <button onclick="buyEbook()" class="ebook-btn" style="background:#28A745; color:white; font-weight:600;">
        Buy now
      </button>
    </div>
  </div>
</div>

  <!-- FLOATING CHAT -->
  <div id="taxc-chat-widget">
    <div class="chat-launcher" onclick="toggleChat()" aria-label="Chat with TaxC Assistant">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
  </svg>
  <div class="chat-tooltip">Chat with Ada</div>
</div>
    <div class="chat-window" id="chat-window">
      <div class="chat-header">
  Ada — TaxC Assistant
  <button class="chat-clear" onclick="clearChat()" title="Clear chat">Clear</button>
  <button class="chat-close" onclick="toggleChat()">×</button>
</div>
      <div class="chat-body" id="chat-body">
      </div>
      <div class="chat-input">
        <input type="text" id="chat-input" placeholder="Type here..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <footer class="main-footer fade-in">
  <div class="footer-container">

    <div class="footer-section">
      <h4>Product</h4>
      <ul>
        <li><a href="index.html#calculator">Calculator</a></li>
        <li><a href="ebooks.html">Ebooks & Guides</a></li>
        <li><a href="index.html#lawyer">Connect with a Tax Lawyer</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Support</h4>
      <ul>
        <li><a href="faq.html">FAQ</a></li>
        <li><a href="mailto:support@taxc.com.ng">support@taxc.com.ng</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Legal</h4>
      <ul>
        <li><a href="privacy.html">Privacy Policy</a></li>
        <!-- <li><a href="terms.html">Terms of Service</a></li> -->
      </ul>
    </div>

    <!-- Social Media Column -->
    <div class="footer-section">
      <h4>Follow Us</h4>
      <div class="social-links">
        <a href="https://instagram.com/taxc.com.ng" target="_blank" rel="noopener" aria-label="Instagram">
          <!-- Instagram SVG -->
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        </a>
        <a href="https://linkedin.com/company/taxc-com-ng" target="_blank" rel="noopener" aria-label="LinkedIn">
          <!-- LinkedIn SVG -->
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.761 0 5-2.239 5-5v-14c0-2.761-2.239-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
        </a>
      </div>
    </div>

  </div>

  <div class="footer-bottom">
    <p>© 2025 TaxC, All rights reserved.</p>
    <p class="footer-legal-links">
      <a href="privacy.html">Privacy</a> • 
      <a href="mailto:support@taxc.com.ng">Contact</a>
    </p>
  </div>
</footer>

  <script>
    
const Ada = {
  memory: { name: "", state: "" },

  init() {
    const savedName = localStorage.getItem('taxc_user_name');
    const savedState = localStorage.getItem('taxc_user_state');
    if (savedName) this.memory.name = savedName;
    if (savedState) this.memory.state = savedState;
  },

  saveName(name) {
    this.memory.name = name.trim();
    localStorage.setItem('taxc_user_name', this.memory.name);
  },

    saveState(state) {
    this.memory.state = state.trim();
    localStorage.setItem('taxc_user_state', this.memory.state);
  },

  logUnanswered(input) {
  if (!input || typeof input !== 'string') return;
  const l = input.toLowerCase().trim();
  if (l.length < 3) return;
  if (/^(hi|hello|hey|howfar|good morning|gm|fine|good|okay|my name is|call me|i am|i live in|my state)/i.test(input)) return;

  // FOR TESTING: show in console on localhost and GitHub Pages
  if (location.hostname === "localhost" || 
      location.hostname === "127.0.0.1" || 
      location.href.includes("ejayszn.github.io")) {
    console.log("UNANSWERED (test mode):", input.trim());
  }

  // ONLY SEND TO GOOGLE SHEET WHEN ON REAL DOMAIN
  if (location.hostname === "taxc.com.ng" || location.hostname === "www.taxc.com.ng") {
    fetch('https://script.google.com/macros/s/AKfycbzIC7c4nrfj-EDY9212GRlH0uG_0Y6xsKmaj9k73IcTHzD8BkKUl71-6jVj0BtQH0csUw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        message: input.trim(), 
        timestamp: new Date().toISOString(),
        page: location.href
      })
    }).catch(() => {});
  }
},

  randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  },

  greet() {
    return this.memory.name ? `Welcome back, ${this.memory.name}.` : "";
  },

  respond(input) {
    this.logUnanswered(input);
    let cleanQuestion = input.trim();
    const l = input.toLowerCase().trim();
    const name = this.memory.name || "there";

    // === 1. PROFESSIONAL GREETINGS ===
    if (/^(hi|hello|hey|howfar|good morning|gm|afternoon|evening|hi ada|hello ada)/i.test(input)) {
      return this.randomChoice([
        `Hello ${name}. How can I assist you with your taxes today?`,
        `Hi ${name}. Welcome. What would you like to know?`,
        `Good to see you${this.memory.name ? ", " + this.memory.name : ""}. How may I help?`
      ]);
    }

    // === 2. USER SAYS THEY'RE FINE ===
    if (/fine|good|okay|great|blessed|not bad/i.test(l)) {
      return `Excellent. How can I assist you today?`;
    }

    // === 3. ORIGINAL PROFESSIONAL FAQS (100% restored) ===
    const faqTriggers = {
      "what taxes does taxc calculate": "TaxC calculates your Personal Income Tax (PIT) based on Nigeria’s 2025/2026 Nigerian Tax Act (NTA) rules. This includes income from salary, self-employment, rental, investments, and other sources, factoring in allowable deductions like pension contributions and rent relief (up to ₦500,000).",
      "who needs to pay personal income tax": "Every Nigerian resident earning income above ₦800,000 annually (after deductions) is required to pay Personal Income Tax to their State Internal Revenue Service (IRS). This includes salaried employees, self-employed individuals, and those with rental or investment income.",
      "how does taxc handle deductions": "TaxC allows you to input pension contributions and annual rent paid. For salaried or self-employed individuals, rent relief is calculated as 20% of your rent, capped at ₦500,000. These deductions reduce your taxable income, lowering your tax liability. Other deductions may include life insurance, NHF, etc.",
      "what is withholding tax": "Withholding Tax (WHT) is a tax deducted at source on certain incomes, like rental income (10%), or investment income (10%). TaxC lets you input WHT paid or applies default rates, which are credited against your final tax liability to avoid double taxation.",
      "is my data safe": "Yes, TaxC prioritizes your privacy. We don’t store sensitive payment information. Payments are securely handled by Interswitch. Your input data is used only for calculations and report generation, and we adhere to strict data protection standards.",
      "what’s included in the pdf report": "The PDF report includes a step-by-step breakdown of your tax calculation, deduction summary (pension, rent relief, etc), tax band details, and filing guidance tailored to your state’s IRS. It’s perfect for keeping records or sharing with a tax lawyer.",
      "how do i file my taxes": "TaxC provides an estimate to guide you. To file, submit your tax details to your State IRS, either online via their portal or in person. Our ₦500 report includes specific filing guidance for your state.",
      "can taxc help with business taxes": "Currently, TaxC focuses on Personal Income Tax for individuals. For business or corporate taxes, consult a tax professional or contact your State IRS. Our eBooks may offer additional resources for business owners."
    };

    for (const [trigger, answer] of Object.entries(faqTriggers)) {
      const keywords = trigger.toLowerCase().split(" ").filter(w => w.length > 3);
      if (keywords.every(k => l.includes(k))) return answer;
    }

    // === ALL HIGH-PROBABILITY QUESTIONS RESTORED (Professional English) ===

    if (l.includes("am i tax eligible") || l.includes("who must pay tax") || l.includes("who pays tax") || l.includes("personal income tax") || l.includes("do I need to pay tax in nigeria") || l.includes("unemployed")) {
      return `You are required to pay Personal Income Tax if your total annual income exceeds ₦800,000 after deductions.<br><br>The first ₦800,000 is completely tax-free.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Check Your Eligibility</button>`;
    }

    if (l.includes("tax on gifts")) {
      return `No. Gifts received by individuals are fully exempt from Personal Income Tax under the 2026 Nigeria Tax Act.`;
    }

    if (l.includes("tax on allowance")) {
      return `Most allowances are taxable. However, medical reimbursements, leave allowance (up to limits), and certain transport subsidies may qualify for relief.`;
    }

    // Refined: Use regex for more precise matching
    if (/bank.*deduct.*tax/.test(l)) {
      return `No. Banks do not automatically deduct Personal Income Tax from accounts. They only report high-value transactions above ₦25 million monthly. PAYE is deducted by employers.`;
    }

    if (l.includes("minimum wage") && l.includes("tax") || l.includes("70k") && l.includes("tax")) {
      return `No. The ₦70,000 minimum wage (₦840,000/year) is mostly within the tax-free threshold of ₦800,000. Minimum wage earners pay little or no tax.`;
    }

    if (l.includes("pensioner") || l.includes("retiree") || l.includes("retired") || l.includes("pension tax")) {
      return `Pension income is taxable under PIT, but you get full relief on contributions during working years.<br><br>Tax-free elements: Lump-sum withdrawals up to limits, gratuity.<br><br>Many retirees pay minimal tax due to reliefs.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Pension Tax</button>`;
    }

    if (l.includes("capital gains") || l.includes("tax on profit") || l.includes("sell asset") || l.includes("stock tax") || l.includes("property sale tax")) {
      return `Capital Gains Tax (CGT) is 10% on profits from selling assets like shares, land, or vehicles (exempt for personal residence).<br><br>It's separate from PIT but reported in your annual filing.<br><br>Calculate your CGT liability here.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate CGT</button>`;
    }

    if (l.includes("refund") || l.includes("overpaid") || l.includes("get money back") || l.includes("excess tax")) {
      return `If you've overpaid (e.g., via excess PAYE or WHT), you can claim a refund when filing your annual return.<br><br>Process:<br>• Submit proof to your State IRS<br>• Refunds are issued via bank transfer or credit against future tax<br><br>Audit your payments with our calculator.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Check for Refund</button>`;
    }

    if (l.includes("audit") || l.includes("irs notice") || l.includes("tax investigation") || l.includes("what if audited")) {
      return `If audited, provide records like payslips, receipts, and bank statements.<br><br>Stay compliant by filing on time. Audits are random or triggered by discrepancies.<br><br>Our guides can help prepare.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Get Audit Guide</button>`;
    }

    if (l.includes("side hustle") || l.includes("gig") || l.includes("uber") || l.includes("bolt") || l.includes("online business") || l.includes("extra income tax")) {
      return `Income from side hustles is taxable as self-employment income under PIT.<br><br>Deduct business expenses (e.g., fuel, data) to reduce liability.<br><br>File quarterly if income > ₦25m/year.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Side Income Tax</button>`;
    }

    if (l.includes("crypto") || l.includes("bitcoin") || l.includes("usdt")) {
      return `Yes. Profit from selling cryptocurrency attracts 10% Capital Gains Tax. Income earned in crypto is taxed as regular income.`;
    }

    if (l.includes("non-resident") || l.includes("expat") || l.includes("foreigner") || l.includes("work in nigeria") || l.includes("tax for foreigner")) {
      return `Non-residents pay PIT only on Nigeria-sourced income.<br><br>If here >183 days, you're a resident and taxed on worldwide income.<br><br>Double taxation treaties may apply.<br><br>Consult a professional for your case.<br><br><button class="chat-btn" onclick="location.href='https://taxc.com.ng/lawyer'">Connect With Expert</button>`;
    }

    if (l.includes("vat") || l.includes("value added tax")) {
      return `TaxC specializes in Personal Income Tax. VAT is a separate 7.5% consumption tax handled by FIRS.<br><br>For PIT-related queries, I'm here. Otherwise, check our eBooks for basics.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Download VAT Guide</button>`;
    }

    if (l.includes("new law") || l.includes("tax change") || l.includes("2026 update") || l.includes("recent amendment")) {
      return `Key 2026 changes: Tax-free threshold raised to ₦800,000; rent relief capped at ₦500,000; progressive rates up to 25%.<br><br>Stay updated with our resources.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Get Latest Updates</button>`;
    } 

    if (l.includes("appeal") || l.includes("disagree") || l.includes("contest tax") || l.includes("wrong assessment")) {
      return `You can appeal to your State IRS within 30 days of assessment.<br><br>Provide evidence; escalate to Tax Appeal Tribunal if needed.<br><br>Our lawyers can assist.<br><br><button class="chat-btn" onclick="location.href='https://taxc.com.ng/lawyer'">Get Appeal Help</button>`;
    }

    if (l.includes("register tin") || l.includes("get tin") || l.includes("apply for tin")) {
      return `Apply for TIN via JTB website (jtb.gov.ng), USSD (*3322#), or State IRS office with your BVN/NIN and ID.<br><br>It's free and takes minutes online.`;
    }

    // === LANDLORD / RENTAL INCOME TAX (Fixes the "I am a landlord" bug) ===
    // Refined: More precise with regex
    if (l.includes("landlord") || l.includes("rental income") || l.includes("rent i collect") || /tenant.*tax/.test(l)) {
      return `
        Yes, as a landlord you must pay Personal Income Tax on rental income.<br><br>
        Key points:<br>
        • Rental income is taxed at your normal PIT rate<br>
        • Your tenant should deduct 10% Withholding Tax (WHT) and remit it — you get credit<br>
        • You still file annually and declare the full amount<br><br>
        Want to calculate your exact tax on rental income?<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Landlord Tax</button>
      `;
    }

    // Refined: Regex for employer not deduct
    if (/employer.*(deduct|paye|tax|withhold)|deduct.*(employer|paye)|already.*(deduct|paye)/i.test(l)) {
  return `Your employer is legally required to deduct PAYE monthly from your salary and remit it to the tax authority. If they are not doing it, you remain personally liable and must file/pay yourself before 31 March to avoid penalties.`;
}

    if (l.includes("paye") || l.includes("wetin be paye") || l.includes("payee")) {
      return `PAYE (Pay As You Earn) is tax your employer deducts monthly from your salary and remits to the government. You still need to file annually to reconcile.`;
    }

    if (/pay.*tax|tax.*pay|dont.*pay|not.*pay|fail.*pay|non.*pay|evade|avoid.*tax|consequence.*tax|what.*happen.*not.*pay/i.test(l)) {
  return `Not paying tax in Nigeria leads to penalties: 10% of the unpaid amount + 1.25% monthly interest. Serious cases can result in fines up to ₦1 million, asset seizure, or up to 3 years in prison under NTA 2025. Pay on time to avoid!`;
}

    if (l.includes("previous year") || l.includes("never filed") || l.includes("back tax")) {
      return `Yes, you can file for previous years now. Penalties apply, but voluntary filing reduces them. Many states offer waiver programmes.`;
    }

    if (l.includes("tin") || l.includes("tax identification number")) {
      return `Retrieve your TIN via verify.jtb.gov.ng, *3322#, old payslip, or any State IRS office with your BVN/NIN.`;
    }

    // Refined: Regex for landlord receipt
    if (/landlord.*receipt/.test(l)) {
      return `You can still claim rent relief using bank transfers, tenancy agreement + affidavit, or electronic receipts. TaxC accepts these.`;
    }

    if (l.includes("two states") || /which state.*pay/.test(l)) {
      return `You pay PIT to the state where you reside or work for more than 183 days per year.`;
    }

    // Refined: More precise
    if (/married|spouse|children.*relief/.test(l)) {
      return `Nigeria uses individual filing only. Consolidated relief: 20% of income + ₦200,000. Child allowance: ₦2,500 per child (max 4).`;
    }

    if (l.includes("lost job") || /unemployed.*file/.test(l)) {
      return `Yes, you should still file a Nil return to maintain a clean tax record.`;
    }

    if (l.includes("freelance") || l.includes("remote") || l.includes("self-employed")) {
      return `Freelancers and remote workers (basically people who do not work in a structured Nigerian organization) must register with their State IRS, file annually by 31 March, and may pay advance tax quarterly. TaxC guides you step by step.`;
    }

    // Refined: Regex
    if (/who.*collect.*tax|where.*pay.*tax|which.*irs|tax.*authority|fir.*state|state.*irs|tax.*collected.*(fir|state)/i.test(l)) {
      return `Pay via your State IRS portal or designated banks. Example: Lagos → paydirect.lirs.net`;
    }

    if (l.includes("installment") || l.includes("part payment")) {
      return `Some states allow installments with prior approval. Lagos does NOT permit PIT installments.`;
    }

    // Refined: Regex
    if (/arrest|jail.*tax/.test(l)) {
      return `No. Tax debt alone does not lead to arrest. Extreme cases may result in account restrictions.`;
    }

    if (l.includes("tcc") || l.includes("tax clearance")) {
      return `After filing and payment, apply on your State IRS portal. Usually issued instantly or within 48 hours.`;
    }

    // Refined: Regex
    if (/how often.*file/.test(l) || l.includes("file every month") || l.includes("monthly") || l.includes("yearly")) {
      return `You file Personal Income Tax returns once per year (by 31 March). PAYE is deducted monthly by employers automatically.`;
    }

    if (/when.*pay.*tax/.test(l) || l.includes("deadline")) {
      return `Deadline for annual filing and final payment: 31 March of the following year.`;
    }

    if (/student.*pay tax/.test(l) || /nysc.*tax/.test(l)) {
      return `Students in Nigeria pay no tax on scholarships, bursaries, or allowances, these are fully exempt under the Personal Income Tax Act. However, if a student earns other income (for example, from freelance work, a business, or employment) that exceeds ₦800,000 per annum after applying deductions, that portion becomes taxable. In practice, the vast majority of full-time students fall below this threshold and remain completely tax-free. NYSC allowance is mostly tax-free or attracts minimal PAYE.`;
    }

    if (l.includes("not pay tax") || l.includes("tax free") || l.includes("exempt")) {
      return `Tax-free items include: gifts, scholarships, inheritance, proceeds from personal residence sale, NYSC allowance (mostly), lottery winnings, life insurance payouts.`;
    }

    // Pidgin additions + typos
    if ((l.includes("calculate") || l.includes("how much tax") || l.includes("owe") || l.includes("how much tax i go pay") || l.includes("wetin i go pay")) && !l.includes("state")) {
      return `Let me calculate your exact tax liability.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Open Calculator</button>`;
    }

    if (l.includes("free") || l.includes("ebook") || l.includes("download")) {
      return `Free tax guides are available.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Download Now</button>`;
    }

    // === EXTRA QUERIES FROM OLD V2.0 (Now Clean & Professional) ===

    // 1. What is my tax band? + typos + pidgin
    if (l.includes("what band") || l.includes("which band") || l.includes("my band") || l.includes("what tax band do i fall") || l.includes("tax bannd") || l.includes("tax brackett") || l.includes("tax bracked") || l.includes("wetin be tax band") || l.includes("which tax band i dey")) {
      return `To determine your exact tax band, I need your total annual income (salary + other sources).<br><br>Please click on the button below, share an estimate, and get the PDF report(It contains the tax bands) and I will tell you immediately.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Now</button>`;
    }

    // 2. How was your night? / How are you? (already has pidgin "how you dey")
    if (l.includes("how was your night") || l.includes("how your night") || l.includes("how are you") || l.includes("how you dey")) {
      return `I'm functioning perfectly and ready to help you with your taxes. How may I assist you today?`;
    }

    // 3. Are you an AI or chatbot?
    if (l.includes("are you an ai") || l.includes("artificial intelligence") || l.includes("chat bot or ai") || l.includes("are you a chat bot?") || l.includes("are you ai?") || l.includes("bot?")) {
      return `I am a smart chatbot designed specifically to help Nigerians understand and calculate Personal Income Tax under the 2025/2026 rules. I provide accurate, instant answers based on the latest tax laws.`;
    }

    // 4. Who made you / Who created TaxC?
    if (l.includes("who made you") || l.includes("who created") || l.includes("creator") || l.includes("who made taxc")) {
      return `TaxC and I (Ada) were created by Emmanuel Oguibe, a Nigerian tax expert dedicated to making tax simple and accessible for everyone.`;
    }

    // 5. How can I save money on tax? / Reduce tax? + pidgin
    if ((l.includes("save money") && l.includes("tax")) || l.includes("reduce tax") || l.includes("pay less tax") || l.includes("how i fit save for tax") || l.includes("abeg how to reduce tax") || l.includes("rent reduce my")) {
      return `You can legally reduce your tax through:<br><br>
        • Rent relief (up to ₦500,000)<br>
        • Pension contributions<br>
        • NHF and NHIS (where applicable)<br>
        • Business expense deductions (self-employed)<br><br>
        Many Nigerians save ₦500,000–₦3 million annually by claiming these correctly.<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">See How Much You Can Save</button>`;
    }

    // 6. Simple explanations for key terms (WHT, PAYE, Rent Relief, etc.) + pidgin + typos
    if (l.includes("wht") || l.includes("withholding tax") || l.includes("wetin be wht") || l.includes("withholiding tax") || l.includes("witholding")) {
      return `Withholding Tax (WHT) is tax deducted at source before payment is made to you. Example: Tenant deducts 10% from rent and pays it directly to government. You get credit for it when filing.`;
    }
    if (l.includes("rent relief") || l.includes("wetin be rent relief") || l.includes("rent releif") || l.includes("rent relif")) {
      return `Rent relief allows you to deduct up to ₦500,000 from your taxable income if you pay house rent. This can save you tens or hundreds of thousands in tax.`;
    }

    // Consolidated Relief Allowance
if (/consolidated.*relief|relief.*allowance|CRA/i.test(l)) {
  return `Under the Nigeria Tax Act 2025 (effective January 1, 2026), the Consolidated Relief Allowance (CRA) has been abolished and replaced by a rent relief: 20% of annual rent paid, capped at ₦500,000 (for renters only). Homeowners get no equivalent relief. The first ₦800,000 of income remains tax-free via the new progressive bands, so most people earning ≤ ₦800k per year pay little or no tax.`;
}

    // 7. Off-topic / inappropriate redirection (clean version)
    if (/(love you|marry|boyfriend|girlfriend|date|send pic|nude|sexy|horny|sex)/i.test(l)) {
      return `Let's stay focused on helping you with your taxes. That's what I'm here for. How can I assist you today?`;
    }

    // What is your name? + pidgin
    if (l.includes("what is your name") || l.includes("whats your name") || l.includes("who are you") || l.includes("wetin be your name") || l.includes("who you be")) {
      return `My name is Ada. I am your dedicated digital tax assistant.`;
    }

    // Are the calculations accurate / correct?
    if (l.includes("accurate") || l.includes("correct") || l.includes("can i trust") || l.includes("calculations")) {
      return `Yes. All TaxC calculations strictly follow the official 2025/2026 Nigerian Tax Act.<br><br>For complex cases or extra peace of mind, you can connect with a verified tax lawyer here:<br><br>
        <button class="chat-btn" onclick="location.href='https://taxc.com.ng/lawyer'">Connect With Tax Lawyer</button>`;
    }

    // === WHAT ARE THE TAX BANDS? (2026 Nigerian PIT Rates – Clean & Beautiful) + typos + pidgin
    if (l.includes("tax band") || l.includes("tax rate") || l.includes("tax bracket") || l.includes("how much percent") || l.includes("tax table") || l.includes("pit rate") || l.includes("tax bannd") || l.includes("tax brackett") || l.includes("tax bracked") || l.includes("wetin be tax rate") || l.includes("how much percent tax")) {
      return `
        Here are the official 2026 Personal Income Tax rates in Nigeria:<br><br>
        • First ₦800,000 of taxable income → <strong>0% (completely tax-free)</strong><br>
        • Next ₦2,200,000 (₦800,001 – ₦3,000,000) → <strong>15%</strong><br>
        • Next ₦9,000,000 (₦3,000,001 – ₦12,000,000) → <strong>18%</strong><br>
        • Next ₦13,000,000 (₦12,000,001 – ₦25,000,000) → <strong>21%</strong><br>
        • Next ₦25,000,000 (₦25,000,001 – ₦50,000,000) → <strong>23%</strong><br>
        • Anything above ₦50,000,000 → <strong>25%</strong><br><br>

        <em>Example:</em> If your taxable income is ₦5 million:<br>
        → First ₦800k = ₦0 tax<br>
        → Next ₦2.2m = ₦330,000 tax<br>
        → Remaining ₦2m = ₦360,000 tax<br>
        <strong>Total tax = ₦690,000</strong><br><br>

        Want to know exactly how much you’ll pay?<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate My Tax Now</button>
      `;
    }

    // === IS STATE NEEDED IN TAX CALCULATION? (NOW CATCHES EVERYTHING) ===
    if (
      l.includes("state") && (
        l.includes("need") || 
        l.includes("require") || 
        l.includes("important") || 
        l.includes("necessary") ||
        l.includes("why") && l.includes("state") ||
        l.includes("do you") && l.includes("state") ||
        l.includes("matter")
      )
    ) {
      return `
        Yes, your state of residence is needed for an accurate and complete tax result.<br><br>
        Here’s why:<br>
        • Personal Income Tax is paid to your State Internal Revenue Service (not federal)<br>
        • The final PDF report TaxC generates must show the correct state so you can file properly<br>
        • Some states have small differences in approved deductions or filing rules<br><br>
        It only takes 2 seconds to select your state in the calculator — everything else is automatic.<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Start Calculation → Choose Your State</button>
      `;
    }

    // === NAME & STATE (Professional) ===
    if (l.includes("my name is") || l.includes("call me") || l.includes("i am")) {
      const match = input.match(/(?:my name is|call me|i'm|my name|name is )([\w\s]+)/i);
      if (match) {
        this.saveName(match[1]);
        return `Thank you, ${this.memory.name}. I have saved your name. How may I assist you?`;
      }
    }

    if (l.includes("what is my name") || l.includes("remember my name")) {
      return this.memory.name ? `Yes, your name is ${this.memory.name}.` : `You haven’t shared your name yet.`;
    }

    if (l.includes("my state") || l.includes("i live in") || l.includes("i stay in")) {
      const states = [
  "abuja", "fct", "abia", "adamawa", "akwa ibom", "anambra", "bauchi", "bayelsa",
  "benue", "borno", "cross river", "delta", "ebonyi", "edo", "ekiti", "enugu",
  "gombe", "imo", "jigawa", "kaduna", "kano", "katsina", "kebbi", "kogi",
  "kwara", "lagos", "nasarawa", "niger", "ogun", "ondo", "osun", "oyo",
  "plateau", "rivers", "sokoto", "taraba", "yobe", "zamfara"
];
      for (const s of states) {
        if (l.includes(s)) {
          this.saveState(s.charAt(0).toUpperCase() + s.slice(1));
          return `Noted. You are in ${this.memory.state}. Tax rules vary slightly by state.`;
        }
      }
    }

    // Edge case: Very short inputs like "tax?" or "tax"
    if (l === "tax" || l === "tax?" || l === "pit" || l === "pit?") {
      return `
        Hello${this.memory.name ? ", " + this.memory.name : ""}.<br><br>
        Personal Income Tax (PIT) is a tax on your earnings in Nigeria. How can I help you with it today?<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate My Tax</button>
      `;
    }

    // === SAFE LATE FILING / PENALTY (won’t eat normal questions anymore) ===
if (/penalty|late.*(filing|payment|file|submission)|file.*late|overdue|miss.*deadline/i.test(l)) {
  return `Late filing: ₦50,000 for individuals (may be ₦5,000 fine + ₦100/day depending on state/LGA)<br>Late payment: 10% penalty per annum + interest at the prevailing CBN rate<br>File on time to avoid these charges.`;
}

    // === FINAL FALLBACK ===
    
    let responseText = "";
    
    // Check if the user asked a question (cleanQuestion is the input)
    // 2. Access cleanQuestion, which is now defined.
    if (cleanQuestion) { // <--- The error happens if this runs before the line above
        // Option 1: Acknowledge the question specifically
        responseText = `
            Sorry, I couldn't find a direct answer to your inquiry about <strong>"${cleanQuestion}"</strong>.
        `;
    } else {
        // Option 2: Generic greeting if no question was asked
        responseText = `${this.greet() ? this.greet() : "Hello."}`;
    }

    // Now combine the custom response with the list of capabilities
    return `
        ${responseText}<br><br>
        However, I can definitely help if you have any other questions like tax calculation, deductions, etc.
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate My Tax</button>
        <button class="chat-btn" onclick="location.href='ebooks.html#free'">Download Free Guides</button>
    `;
} 
};

// === CHAT UI ===
let hasNewMessage = false;

function toggleChat() {
  const win = document.getElementById('chat-window');
  const launcher = document.querySelector('.chat-launcher');
  win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
  if (win.style.display === 'flex') {
    hasNewMessage = false;
    launcher.classList.remove('has-notification');
    // ⭐ NEW: Clear the unread status when the chat is opened/read
    localStorage.removeItem('taxc_ai_has_unread'); 

    setTimeout(() => document.getElementById('chat-input')?.focus(), 300);
    setTimeout(scrollToBottom, 100);
  }
}

// -------------------------------------------------
// SAVE CHAT HISTORY TO LOCALSTORAGE
// -------------------------------------------------
function saveChat() {
  const messages = [];
  document.querySelectorAll('#chat-body .message').forEach(msg => {
    messages.push({
      text: msg.innerHTML,
      type: msg.classList.contains('user') ? 'user' : 'ai'
    });
  });
  localStorage.setItem('taxc_chat_history', JSON.stringify(messages));
}

function scrollToBottom() {
  const body = document.getElementById('chat-body');
  if (body) {
    body.scrollTop = body.scrollHeight;
    body.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }
}

function addMessage(text, type, isInitialLoad = false) {
  const body = document.getElementById('chat-body');
  const div = document.createElement('div');
  div.className = `message ${type}`;
  div.innerHTML = text;
  body.appendChild(div);
  
  // Scroll to bottom
  scrollToBottom();

  // === PLAY SOUND ONLY FOR ADA'S REAL REPLY (not loading dots) ===
  if (type === 'ai' && window.adaSound && !text.includes('typing')) {
    window.adaSound.currentTime = 0;
    window.adaSound.play().catch(() => {});
  }

  // === NOTIFICATION BUBBLE (when chat is closed) ===
  // Trigger only if it's an AI message, NOT an initial load, and the chat is closed
  if (type === 'ai' && !isInitialLoad && document.getElementById('chat-window').style.display !== 'flex') {
    hasNewMessage = true;
    document.querySelector('.chat-launcher').classList.add('has-notification');
    // ⭐ NEW: Persist the unread status in localStorage
    localStorage.setItem('taxc_ai_has_unread', 'true'); 
  }
}

// -------------------------------------------------
// CLEAR CHAT + CONFIRM
// -------------------------------------------------
function clearChat() {
  if (confirm("Are you sure you want to clear chat?")) {
    document.getElementById('chat-body').innerHTML = '';
    localStorage.removeItem('taxc_chat_history');
  }
}

function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, 'user');
  input.value = '';
  addMessage('<i class="typing">•••</i>', 'ai');

  setTimeout(() => {
    const messages = document.querySelectorAll('.message');
    if (messages.length > 0) messages[messages.length - 1].remove();
    addMessage(Ada.respond(text), 'ai');
  }, 1000);
}

document.addEventListener('DOMContentLoaded', () => {
  Ada.init();
  
  // ⭐ NEW: Check and apply saved notification status immediately on page load
  const launcher = document.querySelector('.chat-launcher');
  if (localStorage.getItem('taxc_ai_has_unread') === 'true') {
    launcher.classList.add('has-notification');
  }

  // ==== LOAD PREVIOUS CHAT ====
  const savedChat = localStorage.getItem('taxc_chat_history');
  if (savedChat) {
    const messages = JSON.parse(savedChat);
    // Pass 'true' to ensure history re-load doesn't re-trigger notification
    messages.forEach(msg => addMessage(msg.text, msg.type, true)); 
    setTimeout(scrollToBottom, 100);
  }

  // === INIT ADA SOUND ===
  const adaSound = document.getElementById('ada-message-sound');
  if (adaSound) {
    adaSound.volume = 0.6;
    window.adaSound = adaSound;
  }

  // ==== FIRST-TIME WELCOME (if no name & no chat) ====
  if (!Ada.memory.name && !savedChat) {
    // Pass 'true' to prevent this greeting from triggering a notification
    addMessage("Hi! I'm <strong>Ada</strong>, your digital tax assistant. Ask me anything about taxes, filing, or ebooks!", 'ai', true); 
  }

  // === ONLY SHOW "WELCOME BACK" IF NO CHAT HISTORY ===
  if (Ada.memory.name) {
    const hasChat = localStorage.getItem('taxc_chat_history') && 
                    JSON.parse(localStorage.getItem('taxc_chat_history')).length > 0;
    
    if (!hasChat) {
      setTimeout(() => {
        // Pass 'true' to prevent this greeting from triggering a notification
        addMessage(`Welcome back, ${Ada.memory.name}! Howfar today?`, 'ai', true); 
      }, 800);
    }
  }
});

// === CSS: Notification Badge + Clean Numbers ===
const style = document.createElement('style');
style.textContent = `
  .chat-btn {
    background: #28A745; color: white; border: none; padding: 10px 18px;
    border-radius: 8px; cursor: pointer; font-weight: 600; margin: 8px 0;
    display: inline-block; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: all 0.2s;
  }
  .chat-btn:hover { background: #218838; transform: translateY(-1px); }

  .typing { animation: blink 1s infinite; }
  @keyframes blink { 0%,100% { opacity: 1 } 50% { opacity: 0.3 } }

  /* === FIXED: Clean Numbering === */
  .message ol {
    counter-reset: item;
    padding-left: 0;
    margin: 12px 0;
  }
  .message ol li {
    display: block;
    margin: 10px 0;
    padding-left: 30px;
    position: relative;
    line-height: 1.5;
  }
  .message ol li:before {
    content: counter(item);
    counter-increment: item;
    position: absolute;
    left: 0;
    background: #28A745;
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.85rem;
  }

  /* === NOTIFICATION BADGE === */
  .chat-launcher {
    position: relative;
  }
  .chat-launcher.has-notification::after {
    content: '';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background: #ff3b30;
    border-radius: 50%;
    border: 2px solid white;
    animation: pulse-badge 2s infinite;
  }
  @keyframes pulse-badge {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
`;
document.head.appendChild(style);

  // === FULL EBOOK DATA WITH INTRIGUING BULLETS ===
  const ebooks = [
  // FREE — NO MODAL
  { title: "Who Pays Tax in Nigeria?", price: 0, file: "Who_Pays_Tax_in_Nigeria_TaxC.pdf", cover: "./covers/who-pays-tax.png" },
  { title: "What is Personal Income Tax (P.I.T.)?", price: 0, file: "What_is_Personal_Income_Tax_TaxC.pdf", cover: "./covers/what-is-pit.png" },
  { title: "Am I Tax Eligible? (Quick Quiz)", price: 0, file: "Am_I_Tax_Eligible_TaxC.pdf", cover: "./covers/am-i-tax-eligible.png" },
  { title: "Top 5 Tax Myths Nigerians Believe", price: 0, file: "Top_5_Tax_Myths_Nigerians_Believe_TaxC.pdf", cover: "./covers/tax-myths.png" },
  { title: "How Much Tax Should I Pay? (Mini Guide)", price: 0, file: "How_Much_Tax_Should_I_Pay_TaxC.pdf", cover: "./covers/tax-pay.png" },

  // PAID — SAFE BULLETS
  {
    title: "How to Legally Minimize Your Tax",
    price: 3900,
    file: "minimize-tax.pdf",
    cover: "./covers/minimize-tax.png",
    desc: "Proven strategies to reduce your tax bill <em>legally</em>.",
    bullets: [
      "8 legal strategies to reduce your taxable income",
      "Claim business expenses: rent, data, equipment",
      "Use gift and donation reliefs to save more",
      "Printable checklist to track all deductions"
    ]
  },
  {
    title: "How Do I File My Tax by State IRS?",
    price: 2900,
    file: "file-tax-by-state.pdf",
    cover: "./covers/file-tax.png",
    desc: "37 states + FCT: portals, forms, deadlines, penalties.",
    bullets: [
      "Step-by-step guide for Lagos, Ogun, Kano, and more",
      "Official portal links and filing deadlines",
      "How to avoid late filing penalties",
      "Printable 2025 State Tax Calendar"
    ]
  },
  {
    title: "What is Tax Evasion? (Avoid Jail)",
    price: 1900,
    file: "tax-evasion.pdf",
    cover: "./covers/tax-evasion.png",
    desc: "Real cases, fines, jail time, and how to stay safe.",
    bullets: [
      "Difference between tax evasion and avoidance",
      "Common mistakes that trigger FIRS audit",
      "How to keep proper records for 6 years",
      "Printable compliance guide to stay safe"
    ]
  },
  {
    title: "Self-Employed Tax Guide",
    price: 2500,
    file: "self-employed-tax.pdf",
    cover: "./covers/tax-guide.png",
    desc: "Register, file, and pay tax as a freelancer or gig worker.",
    bullets: [
      "Register for TIN online in 48 hours",
      "File quarterly returns to avoid lump sum",
      "Track expenses: phone, data, laptop, rent",
      "Printable 12-month expense log"
    ]
  },
  {
    title: "Rental Income Tax for Landlords",
    price: 1900,
    file: "rental-tax.pdf",
    cover: "./covers/rental-income.png",
    desc: "10% WHT, filing, deductions. Everything landlords need.",
    bullets: [
      "10% Withholding Tax paid by tenant",
      "Deduct repairs, agent fees, insurance",
      "File annual return even if WHT is paid",
      "Printable landlord tax checklist"
    ]
  },
  {
    title: "Salary Earner’s Tax Handbook 2025",
    price: 1900,
    file: "salary-tax-2025.pdf",
    cover: "./covers/handbook.png",
    desc: "PAYE, reliefs, refunds. Updated for 2025.",
    bullets: [
      "2025 PAYE rates and reliefs explained",
      "Claim pension, NHF, and life insurance",
      "How to apply for tax refund",
      "Printable salary tax summary"
    ]
  },
  {
    title: "How to Claim Tax Refunds",
    price: 1900,
    file: "claim-refund.pdf",
    cover: "./covers/tax-refunds.png",
    desc: "Overpaid? Get your money back from FIRS/SIRS.",
    bullets: [
      "Step-by-step refund application process",
      "Required documents: payslips, Form H1",
      "Timeline: 30–90 days processing",
      "Printable refund tracker"
    ]
  },
  {
    title: "PIT vs CIT for Business Owners",
    price: 2800,
    file: "pit-vs-cit.pdf",
    cover: "./covers/pit-cit.png",
    desc: "Sole prop vs company. Which saves more tax?",
    bullets: [
      "PIT (sole prop) vs CIT (company) explained",
      "Tax rates, filing, and compliance costs",
      "When to register a limited company",
      "Printable business structure quiz"
    ]
  },
  {
    title: "Pension & NHF Tax Reliefs",
    price: 1900,
    file: "pension-nhf.pdf",
    cover: "./covers/nhf-tax.png",
    desc: "8% + 2.5% = huge tax savings. How to claim.",
    bullets: [
      "8% pension + 2.5% NHF = 10.5% relief",
      "How to open RSA and contribute",
      "Claim even if employer doesn’t pay",
      "Printable contribution tracker"
    ]
  },
  {
    title: "How to Fill Form A (Annual Return)",
    price: 1500,
    file: "form-a-guide.pdf",
    cover: "./covers/form-a.png",
    desc: "Step-by-step with screenshots. No more confusion.",
    bullets: [
      "Line-by-line guide with screenshots",
      "Fix common errors in minutes",
      "Submit online in 15 minutes",
      "Printable Form A checklist"
    ]
  },
  {
    title: "Tax Audit Survival Guide",
    price: 2200,
    file: "tax-audit.pdf",
    cover: "./covers/tax-audit.png",
    desc: "What FIRS/SIRS looks for, and how to pass.",
    bullets: [
      "What triggers a tax audit",
      "Documents to prepare in advance",
      "How to respond to FIRS query letter",
      "Printable audit prep checklist"
    ]
  },
  {
    title: "WHT Credit Mastery",
    price: 1300,
    file: "wht-credit.pdf",
    cover: "./covers/wht-credit.png",
    desc: "Turn 5%/10% withholding into tax savings.",
    bullets: [
      "Claim 5–10% WHT as tax credit",
      "How to get WHT receipt from client",
      "Use credit to reduce final tax",
      "Printable WHT credit log"
    ]
  },
  {
    title: "Tax for Digital Nomads",
    price: 2000,
    file: "digital-nomad-tax.pdf",
    cover: "./covers/digital-nomads.png",
    desc: "Work for US/UK company? Here’s your tax rule.",
    bullets: [
      "Tax rules for remote workers",
      "Avoid double taxation with DTAs",
      "File in Nigeria even if paid abroad",
      "Printable remote worker tax guide"
    ]
  },
  {
    title: "Marriage, Kids & Tax Reliefs",
    price: 1400,
    file: "family-tax.pdf",
    cover: "./covers/tax-reliefs.png",
    desc: "Child relief, spouse allowance. Save thousands.",
    bullets: [
      "₦2,500 per child relief (max 4 kids)",
      "Spouse allowance if not working",
      "Claim on PAYE or self-assessment",
      "Printable family relief worksheet"
    ]
  },
  {
    title: "Pay Zero Tax Legally (₦800K Exemption)",
    price: 4900,
    file: "zero-tax.pdf",
    cover: "./covers/zero-tax.png",
    desc: "Earn up to ₦800K/year? Pay ₦0 tax. Here’s how.",
    bullets: [
      "₦800,000 income exemption (2025 law)",
      "File Form A to claim exemption",
      "Submit payslip, ID, bank statement",
      "Printable zero-tax checklist"
    ]
  }
];

    // === LIBRARY, FILTER, MODALS, CHAT ===
  let library = []; // Start with an empty array. The real data comes from Firestore.
  let currentEbook = null;
  let currentUserId = null; // New variable to store the logged-in user ID
  const DB_COLLECTION = 'userLibraries'; // Matches your Firestore rule

  function updateLibraryCount() {
    document.querySelector('.library-title').textContent = `My Library (${library.length})`;
  }

  function renderLibrary() {
    const grid = document.getElementById('libraryGrid');
    grid.innerHTML = '';

    library = library.filter(item => item && item.cover && item.file && item.title);
    updateLibraryCount();

    library.forEach(item => {
      const div = document.createElement('div');
      div.className = 'library-item';
      div.innerHTML = `
        <img src="${item.cover}" class="library-cover" alt="${item.title}" onerror="this.src='https://via.placeholder.com/50x70/e6ffe6/28A745?text=Cover'">
        <div class="library-info">
          <div class="library-name">${item.title}</div>
          <div class="library-type">${item.price === 0 ? 'Free' : 'Purchased'}</div>
        </div>
        <button class="library-btn" onclick="window.open('${item.file}', '_blank')">Open</button>
      `;
      grid.appendChild(div);
    });
  }

  // === FREE DOWNLOAD: NO MODAL ===
  function downloadFree(title) {
    const ebook = ebooks.find(e => e.title === title);
    if (ebook) {
      addToLibrary(ebook);
      window.open(ebook.file, '_blank');
    }
  }

  // === PAID MODAL: DYNAMIC BULLETS ===
  function openPaidModal(title, price, file) {
  currentEbook = ebooks.find(e => e.title === title);
  if (!currentEbook) return;

  document.getElementById('paidTitle').textContent = title;
  document.getElementById('paidCover').src = currentEbook.cover;
  document.getElementById('paidPrice').textContent = `₦${price.toLocaleString()}`;

  // Safely populate bullets
  const bulletsContainer = document.querySelector('#paidModal .modal-bullets');
  if (bulletsContainer) {
    bulletsContainer.innerHTML = ''; // Clear previous
    (currentEbook.bullets || []).forEach(bullet => {
      const li = document.createElement('li');
      li.textContent = bullet;
      bulletsContainer.appendChild(li);
    });
  }

  document.getElementById('paidModal').classList.add('open');
}

  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
  }

  function isValidEmail(email) {
    email = email.trim().toLowerCase();
    const basicRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!basicRegex.test(email)) return false;
    const [local, domain] = email.split('@');
    if (!local || !domain) return false;
    if (local.startsWith('.') || local.endsWith('.') || local.includes('..')) return false;
    const domainParts = domain.split('.');
    if (domainParts.length < 2) return false;
    for (let part of domainParts) {
      if (!part || part.length > 63 || !/^[a-z0-9-]+$/i.test(part)) return false;
    }
    const tld = domainParts[domainParts.length - 1];
    if (!/^[a-z]{2,}$/i.test(tld)) return false;
    return true;
  }

  // === BUY EBOOK ===

async function buyEbook() {
  if (!currentEbook) return;

  const user = window.auth.currentUser;
  if (!user?.email) {
    alert("Login required");
    return;
  }

  const btn = document.querySelector('#paidModal .ebook-btn');
  const original = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Opening Paystack...";

  const reference = `EBK_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;

  const handler = PaystackPop.setup({
    key: 'pk_test_bc9c09e6d51c4e025bb44c6c57ad1c1144386b55',
    email: user.email,
    amount: currentEbook.price * 100,
    ref: reference,
    callback: async function(response) {
      btn.textContent = "Verifying...";

      try {
        const res = await fetch('https://us-central1-taxc-ebooks.cloudfunctions.net/generateEbookDownload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reference: response.reference,
            file: currentEbook.file
          })
        });

        const result = await res.json();

        if (result.success && result.downloadUrl) {
          alert("Payment verified! Download starting...");
          window.open(result.downloadUrl, '_blank');
          addToLibrary(currentEbook);
        } else {
          alert("Failed: " + (result.message || "Try again"));
        }
      } catch (err) {
        alert("Network error: " + err.message);
      }

      btn.textContent = original;
      btn.disabled = false;
      closeModal('paidModal');
    },
    onClose: () => {
      btn.textContent = original;
      btn.disabled = false;
    }
  });

  handler.openIframe();
}

  function addToLibrary(ebook) {
  if (!library.find(i => i.file === ebook.file)) {
    // Only push if not already present
    library.push(ebook);
    
    // Save to Firestore instead
    saveLibraryToFirestore(); 
    
    updateLibraryCount();
    renderLibrary();
  }
}

// Function to save the current library state to Firestore
async function saveLibraryToFirestore() {
  if (!currentUserId) return;
  
  // Only save essential data: file and title
  const dbData = library.map(item => ({ title: item.title, file: item.file, price: item.price, cover: item.cover }));
  
  try {
    const docRef = doc(window.db, DB_COLLECTION, currentUserId);
    await setDoc(docRef, { ebooks: dbData, lastUpdated: new Date() }, { merge: true });
    // console.log("Library saved to Firestore successfully.");
  } catch (e) {
    console.error("Error saving library to Firestore: ", e);
  }
}

// Function to load the library from Firestore
async function loadLibraryFromFirestore() {
  if (!currentUserId) return;
  try {
    const docRef = doc(window.db, DB_COLLECTION, currentUserId);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      library = docSnap.data().ebooks || [];
      // Also merge any old localStorage data if this is the first time syncing on this device
      // (Optional cleanup step: only run once)
      
    } else {
      library = [];
    }
    renderLibrary();
  } catch (e) {
    console.error("Error loading library from Firestore: ", e);
    library = [];
  }
}

  function toggleLibrary() {
    const grid = document.getElementById('libraryGrid');
    const toggle = document.querySelector('.library-toggle');
    if (grid.classList.contains('open')) {
      grid.classList.remove('open');
      toggle.textContent = 'Show';
    } else {
      grid.classList.add('open');
      toggle.textContent = 'Close';
    }
  }  

  function toggleMobileMenu() {
    const menu = document.getElementById('menu');
    const hamburger = document.getElementById('hamburger');
    if (menu.hasAttribute('open')) {
      menu.removeAttribute('open');
      hamburger.classList.remove('is-active');
    } else {
      menu.setAttribute('open', '');
      hamburger.classList.add('is-active');
    }
  }

  // === FILTER + SEARCH ===
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filterEbooks();
      updateHeroText();
    });
  });

  document.getElementById('searchInput').addEventListener('input', () => {
    const hasValue = document.getElementById('searchInput').value.trim();
    document.getElementById('clearSearch').style.display = hasValue ? 'block' : 'none';
    filterEbooks();
    updateHeroText();
  });

  document.getElementById('clearSearch').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    filterEbooks();
    updateHeroText();
  });

  function filterEbooks() {
    const filter = document.querySelector('.filter-btn.active').dataset.filter;
    const search = document.getElementById('searchInput').value.toLowerCase().trim();

    document.querySelectorAll('.ebook-card').forEach(card => {
      const type = card.dataset.type;
      const title = card.querySelector('.ebook-title').textContent.toLowerCase();
      const desc = card.querySelector('.ebook-desc').textContent.toLowerCase();
      const author = card.querySelector('.ebook-author').textContent.toLowerCase();
      const badge = card.querySelector('.ebook-badge').textContent.toLowerCase();

      const matchesFilter = filter === 'all' || type === filter;
      const matchesSearch = !search || title.includes(search) || desc.includes(search) || author.includes(search) || badge.includes(search);

      card.style.display = matchesFilter && matchesSearch ? 'block' : 'none';
    });
  }

  // === HERO TEXT UPDATE ===
  function updateHeroText() {
    const activeBtn = document.querySelector('.filter-btn.active');
    const filter = activeBtn.dataset.filter;
    const heroText = document.getElementById('heroText');

    if (filter === 'free') {
      heroText.textContent = "Download free guides instantly, no cost.";
    } else if (filter === 'paid') {
      heroText.textContent = "Premium tax guides: save thousands, avoid fines, file like a pro.";
    } else {
      heroText.textContent = "Get free and premium guides to understand, file, and save on taxes in Nigeria.";
    }
  }

  function activateAllFilter(event) {
    event.preventDefault();
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    const allBtn = document.querySelector('.filter-btn[data-filter="all"]');
    allBtn.classList.add('active');
    updateHeroText();
    filterEbooks();
    document.getElementById('ebooks').scrollIntoView({ behavior: 'smooth' });
  }

  // === IMAGE FALLBACK ===
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.ebook-cover').forEach(img => {
      img.onerror = function() {
        const card = this.closest('.ebook-card');
        const title = card.querySelector('.ebook-title').textContent;
        const clean = encodeURIComponent(title.replace(/[^a-zA-Z0-9]/g, ' ').trim().substring(0, 30));
        this.src = `https://via.placeholder.com/300x420/e6ffe6/28A745?text=${clean}`;
        this.style.objectFit = 'contain';
        this.style.background = '#fff';
      };
    });
  });

  // === RESET LIBRARY ===
  function showResetWarning() {
    if (library.length === 0) {
      alert("Your library is already empty!");
      return;
    }
    document.getElementById('resetModal').classList.add('open');
  }

  function resetLibraryConfirm() {
    library = [];
    updateLibraryCount();
    renderLibrary();
    closeModal('resetModal');
    alert("Library cleared! All ebooks removed.");
  }

  // === INIT ===
document.addEventListener('DOMContentLoaded', () => {
  // Library loading/rendering is now handled by the onAuthStateChanged listener
  updateHeroText();
});

window.addEventListener('beforeunload', saveChat);

</script>
<script src="scripts/scroll-animation.js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";
  
  // ⭐ NEW IMPORT: Firestore
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD59PBKVQ_ocfAxWHsMsG0a3SE143Yp5zo",
    authDomain: "taxc-ebooks.firebaseapp.com",
    projectId: "taxc-ebooks",
    storageBucket: "taxc-ebooks.firebasestorage.app",
    messagingSenderId: "542476707940",
    appId: "1:542476707940:web:591fd5d3d6fd51eff95771"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const functions = getFunctions(app);
  
  // ⭐ NEW INITIALIZATION: Firestore
  const db = getFirestore(app);
  
  window.auth = auth;
  window.db = db; // Expose db globally for your non-module script
  
  // 🛑 START OF REQUIRED ADDITIONS 🛑
  // Expose the callable function handler globally.
  // 'verifyEbookPurchase' must match the name in index.js
  window.verifyEbookPurchase = httpsCallable(functions, 'verifyEbookPurchase');
  // ⭐ FIX: Expose the helper functions globally so the main script can use them
window.doc = doc;
window.getDoc = getDoc;
window.setDoc = setDoc;
window.updateDoc = updateDoc; // updateDoc is good to have too, though maybe not used here

// 🛑 END OF REQUIRED ADDITIONS 🛑
  
  const $ = id => document.getElementById(id);

  // THIS IS THE REAL PROTECTION — NOBODY FIT FAKE AM
  onAuthStateChanged(auth, user => {
  if (!user) {
    // Not logged in → kick them go login page
    const redirectTo = encodeURIComponent(location.href);
    location.replace(`login.html?redirect=${redirectTo}`);
    
    // ⭐ NEW: Clear state if logged out
    currentUserId = null;
    library = [];
    renderLibrary();
    return;
  }

    // Logged in → show name + change button to Logout
    // Logged in
  currentUserId = user.uid; // ⭐ NEW: Set the user ID
  loadLibraryFromFirestore(); // ⭐ KEY ACTION: Load library data from Firestore
    if (user.displayName) {
      const firstName = user.displayName.split(' ')[0];
      const userDisplay = $('userDisplay');
      if (userDisplay) {
        userDisplay.textContent = `Hi, ${firstName}!`;
        userDisplay.style.display = 'inline';
      }
    }

    document.querySelectorAll('#auth-button, #auth-button-mobile').forEach(btn => {
      btn.innerHTML = 'Logout';
      btn.onclick = () => signOut(auth).then(() => location.reload());
    });
  });
</script>

<script>
const PAYSTACK_KEY = "pk_test_bc9c09e6d51c4e025bb44c6c57ad1c1144386b55"; // same as your PDF
let paymentInProgress = false;

async function verifyEbookPayment(reference) {
  try {
    const res = await fetch('https://us-central1-taxc-ebooks.cloudfunctions.net/verifyPayment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reference })
    });
    if (!res.ok) {
      const err = await res.json();
      console.error("Verification failed:", err);
      return { success: false, message: err.message || "Invalid payment" };
    }
    return await res.json(); // { success: true }
  } catch (err) {
    console.error(err);
    return { success: false };
  }
}

document.querySelectorAll('.ebook-buy-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    if (paymentInProgress) return;
    
    const title = this.dataset.title;
    const amount = Number(this.dataset.price); // in kobo
    const fileUrl = this.dataset.file;

    const email = prompt("Enter your email for receipt & future updates:", "");
    if (!email || !email.includes('@')) {
      alert("Please enter a valid email");
      return;
 and;
    }

    paymentInProgress = true;
    this.disabled = true;
    this.textContent = "Opening Paystack...";

    const ref = `EBOOK_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;

    const handler = PaystackPop.setup({
      key: PAYSTACK_KEY,
      email: email,
      amount: amount,
      currency: "NGN",
      ref: ref,
      metadata: { ebook_title: title },
      callback: async function(response) {
        btn.textContent = "Verifying payment...";
        
        const result = await verifyEbookPayment(response.reference);
        
        if (result.success) {
          btn.textContent = "Download Ready!";
          btn.style.background = "#28A745";
          
          // Trigger instant download
          const link = btn.parentElement.querySelector('.real-download-link');
          link.href = fileUrl;
          link.download = fileUrl.split('/').pop();
          link.click();
          
          // Optional: change button to "Download Again"
          btn.textContent = "Download Again";
          btn.onclick = () => link.click();
        } else {
          alert("Payment could not be verified. Contact support@taxc.com.ng quoting: " + response.reference);
          btn.textContent = "Try Again";
          btn.disabled = false;
        }
        paymentInProgress = false;
      },
      onClose: () => {
        btn.textContent = `Download Now (₦${amount/100})`;
        btn.disabled = false;
        paymentInProgress = false;
      }
    });
    
    handler.openIframe();
  });
});
</script>
</body>
</html>