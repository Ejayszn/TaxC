<!DOCTYPE html>
<html lang="en">
<head>
  <script>
        function isWebView() {
            const userAgent = navigator.userAgent;
            if (
                /FBAN|FBAV|Instagram|TikTok|Line|Puffin|KAKAOTalk|Twitter|Pinterest/i.test(userAgent) ||
                /wv/.test(userAgent)
            ) {
                return true;
            }
            return false;
        }

        function openInSystemBrowser(url) {
            // 1. Try standard window.open, which works well with user click
            const newWindow = window.open(url, '_blank');
            
            // 2. If it failed, try the intent method (Android)
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                if (navigator.userAgent.match(/Android/i)) {
                    // Android Intent to open in Chrome
                    window.location.href = 'intent://' + url.replace(/^https?:\/\//, '') + '#Intent;scheme=https;package=com.android.chrome;end';
                } else {
                    // Final fallback
                    window.location.href = url;
                }
            }
        }

        window.onload = function() {
            const redirectPrompt = document.getElementById('redirect-prompt');
            const openButton = document.getElementById('open-external-button');
            const currentUrl = window.location.href;

            if (isWebView() && redirectPrompt && openButton) {
                // Show the prompt, hide the main app content
                redirectPrompt.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevents scrolling behind the overlay

                // Attach the escape logic to the user's click
                openButton.onclick = function() {
                    openInSystemBrowser(currentUrl);
                };
            }
        };
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaxC - Nigerian Tax Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="icon" href="./favicon.ico">
    <link rel="manifest" href="./site.webmanifest">

    <link rel="stylesheet" href="styles/animations.css">

    <script src="https://js.paystack.co/v2/inline.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/5.0.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>

    .chat-clear {
  position: absolute;
  right: 44px; /* Moves it left of the X */
  top: 50%;
  transform: translateY(-50%);
  background: #dc3545; /* Red */
  color: #fff;
  border: none;
  font-size: 0.75rem; /* Smaller text */
  padding: 4px 8px; /* Smaller button */
  border-radius: 4px;
  cursor: pointer;
  opacity: 0.9;
}
.chat-clear:hover {
  opacity: 1;
  background: #c82333;
}

/* MOBILE FIX: Move Clear further left + smaller */
@media (max-width: 480px) {
  .chat-clear {
    right: 35px; /* Closer to center on mobile */
    font-size: 0.7rem; /* Even smaller text */
    padding: 2px 6px; /* Tighter padding */
  }
  .chat-header {
    padding: 10px 8px; /* Less padding on mobile */
    font-size: 0.9rem; /* Smaller title text */
  }
  .chat-close {
    right: 5px; /* X closer to edge */
    font-size: 1.2rem; /* Slightly smaller X */
  }
}
    
/* -------------------- Color Palette: Vibrant Primary Green #28A745 -------------------- */
:root {
    /* Mapped main app colors to colors for easier maintenance */
    --green: #28A745; 
    --dark-green: #218838;
    --soft: #F8F9FA; /* Light background */
    --muted: #6c757d;
    --card: #ffffff;
    --main-color: #28A745;
    --dark-text: #343A40;
}
/* -------------------- Global Reset & Typography -------------------- */
body {
    font-family: 'Inter', sans-serif;
    background-color: #F8F9FA;
    color: #343A40;
    line-height: 1.6;
    margin: 0;
    padding: 0;
    scroll-behavior: smooth;
}
.container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
}
.container {
  padding-top: 60px; /* Adjust to your header height (measure in dev tools, ~50-70px) */
}
h2.section-title {
    font-size: 2rem;
    color: #28A745; /* Primary Green */
    margin-bottom: 30px;
    text-align: center;
    font-weight: 700;
}
/* -------------------- Hero Section Styles -------------------- */
.hero-section {
    padding: 40px 20px; 
    text-align: center;
    background-color: #FFFFFF;
    border-bottom: 5px solid #28A745;
    margin-bottom: 40px;
    border-radius: 10px;
}
.hero-section h1 {
    font-size: 3rem;
    /* FIX HERE: Changed color from #343A40 (dark text) to #28A745 (Primary Green) */
    color: #28A745; 
    margin-bottom: 10px; 
    font-weight: 700;
}
.hero-section p {
    font-size: 1.25rem;
    color: #555;
    max-width: 800px;
    margin: 0 auto 20px; 
}

.cta-button {
    display: inline-block;
    padding: 12px 25px;
    background-color: #28A745; /* Primary Green */
    color: white;
    text-decoration: none;
    border-radius: 50px;
    font-weight: 600;
    transition: background-color 0.3s, transform 0.2s;
}
.cta-button:hover {
    background-color: #218838; /* Darker Green (Hover) */
    transform: translateY(-2px);
}

.cta-small { 
    background: var(--green); 
    color: #fff; 
    padding: 8px 14px; 
    border-radius: 6px; 
    border: none; 
    cursor: pointer; 
    font-weight: 600;
} 
.cta-small:hover { 
    background: var(--dark-green); 
}
/* ==================== DROPDOWN MENU STYLES ==================== */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            text-decoration: none;
            color: #343A40;
            padding: 8px 15px;
            transition: color 0.3s;
            font-weight: 600;
        }
        .desktop-nav .dropdown-toggle:hover,
        .mobile-menu .dropdown-toggle:hover {
            color: #28A745;
        }
        .dropdown-arrow {
            font-size: 0.8em;
            transition: transform 0.3s ease;
            display: inline-block;
        }
        .dropdown[open] .dropdown-arrow {
            transform: rotate(180deg);
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 280px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 1px solid #eee;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        .dropdown[open] .dropdown-content {
            display: block;
        }
        .dropdown-content ul {
            margin: 0;
            padding-left: 18px;
            color: #444;
        }
        .dropdown-content strong {
            color: #444;
        }

        /* Mobile dropdown adjustment */
        .mobile-menu .dropdown {
            width: 100%;
        }
        .mobile-menu .dropdown-toggle {
            justify-content: space-between;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
        }
        .mobile-menu .dropdown-content {
            position: static;
            box-shadow: none;
            border: none;
            border-top: 1px solid #eee;
            border-radius: 0;
            padding: 15px 20px;
            background-color: #f9f9f9;
            transform: none;
            left: auto;
        }

        /* PREVENT ACCIDENTAL CLICKS DURING SWIPE */
.mobile-menu .dropdown-content {
    pointer-events: none; /* Disable interaction on container */
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s ease;
    padding: 0 20px !important;
}

.mobile-menu .dropdown[open] .dropdown-content {
    pointer-events: auto;   /* Re-enable only when open */
    opacity: 1;
    max-height: 600px;      /* Large enough for content */
    padding: 15px 20px !important;
}

/* Make sure the toggle itself is clickable */
.mobile-menu .dropdown-toggle {
    pointer-events: auto !important;
    touch-action: manipulation;
}

/* Stop text selection & callouts during swipe */
.mobile-menu {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    touch-action: pan-y; /* Allows vertical scroll/swipe only */
}

/* -------------------- Header & Navigation (HEIGHT REDUCED) -------------------- */
.main-header {
  background: #fff; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  padding: 5px 20px; 
  display: flex; 
  justify-content: space-between;
  align-items: center; 
  position: fixed;    /* Change from sticky to fixed */
  top: 0;            /* Pin to top */
  left: 0;           /* Full width start */
  width: 100%;       /* Span full screen */
  z-index: 1000;     /* Above menu/backdrop */
  box-sizing: border-box; /* Include padding in width */
}

.logo {
    font-size: 1.8rem;
    font-weight: 700;
    color: #28A745; /* Primary Green */
    text-decoration: none;
    display: flex;
    align-items: center; 
    gap: 8px;
}
.logo-icon {
    height: 24px;
    width: 24px;
}
.desktop-nav a, .mobile-menu a {
    text-decoration: none;
    color: #343A40;
    padding: 8px 15px;
    transition: color 0.3s;
    font-weight: 600;
}
.desktop-nav a:hover, .mobile-menu a:hover {
    color: #28A745; /* Primary Green */
}
.desktop-nav {
    display: none; 
}

/* Hamburger Styles (Fixed) */
#hamburger {
    background: none;
    border: none;
    cursor: pointer;
    display: block; 
    padding: 0;
    width: 30px;
    height: 20px;
    position: relative;
    top: 0;
}
.hamburger-box {
    width: 100%;
    height: 100%;
    display: block;
    position: relative;
}
.hamburger-inner, .hamburger-inner::before, .hamburger-inner::after {
    position: absolute;
    height: 2px;
    width: 100%;
    background-color: #343A40;
    transition: transform 0.3s ease, opacity 0.3s ease;
    left: 0;
}
.hamburger-inner {
    top: 50%;
    transform: translateY(-50%);
}
.hamburger-inner::before { 
    content: '';
    top: -8px;
}
.hamburger-inner::after { 
    content: '';
    bottom: -8px;
}

/* Active state for animation */
.hamburger.is-active .hamburger-inner { 
    transform: translateY(-50%) rotate(45deg); 
}
.hamburger.is-active .hamburger-inner::before { 
    opacity: 0;
}
.hamburger.is-active .hamburger-inner::after { 
    transform: translateY(0) rotate(-90deg);
    top: 0;
}

/*Mobile menu hamburger*/
.mobile-menu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.15);
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px 0 40px;
    z-index: 999;
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
}

/* Backdrop (dark overlay) */
.menu-backdrop {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
    z-index: 998;
}

.menu-backdrop.active {
    opacity: 1;
    visibility: visible;
}

/* Handle bar at the top (like iOS bottom sheet) */
.menu-handle {
    width: 40px;
    height: 5px;
    background: #ddd;
    border-radius: 3px;
    margin: 0 auto 20px;
}

/* Bigger, cleaner menu items */
.mobile-menu a,
.mobile-menu .dropdown-toggle {
    padding: 16px 24px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Dropdown inside bottom sheet */
.mobile-menu .dropdown-content {
    background: #f8f9fa;
    padding: 16px 24px;
    margin: 0 24px;
    border-radius: 12px;
}

/* Prevent body scroll ONLY when menu is actually open */
body.menu-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
}

/* Make sure the menu is always on top and full height */
.mobile-menu[open] {
    transform: translateY(0) !important;
}

/* -------------------- General Card & Form Styles -------------------- */
.content-section {
    padding: 40px 0;
}
.card-form, .card-output {
    background-color: #FFFFFF;
    padding: 30px; 
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
}

/* PERFECT SECTION DIVIDER ‚Äî works on mobile & desktop, never overlaps */
.section-divider {
    position: relative;
    text-align: center;
    margin: 40px 0 25px;
    font-weight: 600;
    color: #28A745;
    line-height: 1.4;
}

.section-divider::before,
.section-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    height: 1px;
    background: #ddd;
    width: 50vw;           /* keep stretching with screen size */
    max-width: none;       /* ‚Üê CHANGE THIS LINE (remove the 100px cap) */
    transform: translateY(-50%);
}

.section-divider::before { left: 0; }
.section-divider::after  { right: 0; }

.section-divider span {
    background: #fff;
    padding: 0 20px;
    position: relative;
    z-index: 1;
}
/* Card Content Spacing & Centering */
.card-form .container-content { 
    max-width: 800px;
    margin: 0 auto;
    padding: 0 20px;
}
/* CRITICAL FIX: Ensure all fields are flush left */
.card-form .input-row,
.card-form .input-group,
.card-form .add-income-btn,
.card-form .calculate-btn,
.card-form .income-sources-list,
.card-form .section-divider {
    margin-left: 0; 
    margin-right: 0;
    max-width: 100%; 
}

/* -------------------- Input Groups -------------------- */
.input-group, .input-row {
    margin-bottom: 20px;
}
.input-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #555;
}
input[type="text"], input[type="email"], select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 1rem;
    transition: border-color 0.3s;
}
input:focus, select:focus {
    border-color: #28A745; /* Primary Green */
    outline: none;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25); /* Primary Green (with transparency) */
}

/* -------------------- Buttons -------------------- */
.calculate-btn {
    display: block;
    width: 100%;
    padding: 15px;
    background-color: #28A745; /* Primary Green */
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 30px;
}
.calculate-btn:hover {
    background-color: #218838; /* Darker Green (Hover) */
}
.add-income-btn {
    background: none;
    border: 1px dashed #28A745; /* Primary Green */
    color: #28A745; /* Primary Green */
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
    transition: background-color 0.3s, color 0.3s;
}
.add-income-btn:hover {
    background-color: #e6ffe6; /* Light green hover */
}
/* Reset Button Default (Black) */
.reset-btn {
    display: block;
    width: 100%;
    padding: 15px;
    background-color: #e5e5e5;
    color: rgb(0, 0, 0);             
    border: none;
    border-radius: 6px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 10px; /* Space it 10px below the Calculate button */
}

/* Reset Button Hover (Brighter Shade of Black / Dark Gray) */
.reset-btn:hover {
    background-color: #a4a4a4; /* Darker Grey for Hover */
}

/* -------------------- How It Works Section -------------------- */
.steps-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}
.step-card {
    background: #FFFFFF;
    padding: 25px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border-top: 5px solid #28A745; /* Primary Green */
}
.step-number {
    display: inline-block;
    width: 40px;
    height: 40px;
    line-height: 40px;
    border-radius: 50%;
    background-color: #28A745; /* Primary Green */
    color: white;
    font-weight: 700;
    margin-bottom: 10px;
}
.step-card h3 {
    color: #343A40;
    margin-top: 0;
}

/* -------------------- Income Source Block (Template Styling) -------------------- */
.income-source-block {
    border: 1px solid #ddd;
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 8px;
    position: relative;
    background-color: #fefefe;
}
/* Income Source Alignment Fix: Use flexbox and reset margins/paddings */
.income-source-block .input-row {
    display: flex;
    gap: 20px;
    margin-left: 0;
    margin-right: 0;
    padding: 0;
}
.income-source-block .input-row .input-group {
    flex: 1;
    margin-left: 0;
    margin-right: 0;
    padding: 0;
}
.gross-income-container {
    margin-left: 0; 
    margin-right: 0;
    padding: 0;
}
.income-source-block > * {
    margin-left: 0;
    margin-right: 0;
    padding-left: 0;
    padding-right: 0;
}
.income-source-block .income-header {
    margin-bottom: 15px;
    padding-bottom: 10px;
    margin-left: initial;
    margin-right: initial;
}
.income-source-block .remove-btn {
    padding-right: 0;
}
/* End of Income Source Alignment Fix */

.income-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}
.income-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #28A745; /* Primary Green */
}
.income-index {
    display: inline-block;
    background: #28A745; /* Primary Green */
    color: white;
    border-radius: 4px;
    padding: 2px 8px;
    margin-right: 10px;
    font-size: 0.9rem;
}
.remove-btn {
    background: none;
    border: none;
    color: #dc3545;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: color 0.3s;
    padding: 0;
}
.remove-btn:hover {
    color: #a71d2a;
}

/* Redefine grid for general input-rows */
.input-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: flex-start;
}
/* DEDUCTION FIELDS ALIGNMENT FIX */
.deductions-row { 
    display: flex; 
    gap: 20px;
    margin-left: 0; 
    margin-right: 0;
    margin-bottom: 20px; 
    padding: 0;
}
.deductions-row .input-group {
    flex: 1; 
    margin-bottom: 0;
    padding: 0;
}
.card-form .input-group:last-of-type {
    margin-left: 0;
    margin-right: 0;
}
/* End of Deduction Alignment Fix */

.gross-income-container, .wht-row {
    display: flex; 
    flex-direction: column;
}
/* Monthly Income Table Look (using your .monthly-income-row) */
.monthly-income-container {
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 6px;
    background-color: #fcfcfc;
}
.monthly-income-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 10px;
}
.monthly-income-row label {
    font-size: 0.85rem;
    margin-bottom: 5px;
    text-align: center;
}
.monthly-income-row input {
    text-align: center;
}
.monthly-total {
    text-align: right;
    font-weight: 700;
    color: #28A745; /* Primary Green */
    padding-top: 10px;
    border-top: 1px solid #eee;
    margin-top: 10px;
}
.tooltip {
    position: relative;
    display: inline-block;
    cursor: help;
}
.tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%; 
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.85rem;
}
.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}
.clickable-tooltip {
    position: relative;
    display: inline-block;
    width: 100%;
}
.clickable-tooltip .tooltip-popup {
    visibility: hidden;
    opacity: 0;
    width: 240px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 8px;
    position: absolute;
    z-index: 10;
    bottom: 125%;
    left: 50%;
    margin-left: -120px;
    transition: opacity .2s, visibility .2s;
    font-size: .85rem;
    pointer-events: none;
}
.clickable-tooltip.active .tooltip-popup {
    visibility: visible;
    opacity: 1;
}

/* -------------------- Output & Report Section -------------------- */
.message-area {
    padding: 10px;
    background-color: #e6ffe6; /* Light green for info/success messages */
    color: #218838; /* Darker green text */
    border: 1px solid #28A745; /* Primary Green border */
    border-radius: 5px;
    margin-bottom: 20px;
    font-weight: 600;
    text-align: center;
}
.tax-summary-box {
    background-color: #e9ecef; /* Light grey box for summary */
    padding: 20px;
    border-radius: 6px;
    font-size: 1.1rem;
    line-height: 1.8;
}
.tax-summary-box strong {
    color: #28A745; /* Primary Green */
}

#taxSummary table { border-collapse: collapse; width: 100%; }
#taxSummary th, #taxSummary td { border: 1px solid #ddd; padding: 8px; }
#taxSummary th { background-color: #f2f2f2; text-align: left; }

.report-section {
    margin-top: 25px;
    padding-top: 15px;
    border-top: 1px dashed #ddd;
}
.report-prompt {
    font-style: italic;
    color: #6c757d;
}
.input-group-inline {
    display: flex;
    gap: 10px;
}
.input-group-inline input[type="email"] {
    flex-grow: 1;
}
.report-btn {
    background-color: #28A745; /* Primary Green */
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: background-color 0.3s;
}
.report-btn:hover {
    background-color: #218838; /* Darker green on hover */
}

/* -------------------- Media Queries (Responsiveness) -------------------- */
@media (min-width: 768px) {
    .desktop-nav {
        display: flex;
    }
    #hamburger {
        display: none;
    }
    .content-section {
        padding: 50px 0;
    }
    /* Adjust card padding for larger screens */
    .card-form, .card-output {
        padding: 40px;
    }
    /* Ensure deduction fields are still side-by-side on desktop */
    .deductions-row {
        flex-direction: row; 
    }
}

@media (max-width: 576px) {
    .monthly-income-row {
        grid-template-columns: repeat(2, 1fr); 
    }
    .input-group-inline {
        flex-direction: column;
    }
    /* Income Source block fixes (stacking) */
    .income-source-block .input-row {
        flex-direction: column;
        gap: 0;
    }
    .income-source-block .input-row .input-group {
        margin-bottom: 20px;
    }
    /* Deduction fields must also stack on mobile */
    .deductions-row {
        flex-direction: column;
        gap: 0;
        margin-bottom: 0; 
    }
    .deductions-row .input-group {
        margin-bottom: 20px;
    }
    
    .card-form, .card-output {
        padding: 20px;
    }
    .card-form .container-content {
        padding: 0 10px;
    }
}
/* Your existing styles remain ‚Äî we ADD the chatbot */
    body { font-family: 'Inter', sans-serif; position: relative; }

   /* === FLOATING CHAT (MESSAGE ICON + TOOLTIP) === */
#taxc-chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
}

/* ‚Äî‚Äî‚Äî ANIMATED FLOATING AI ICON (Makes users KNOW they can click it!) ‚Äî‚Äî‚Äî */
.chat-launcher {
  position: relative;
  width: 60px;
  height: 60px;
  background: #28A745;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
  transition: all 0.3s ease;
  animation: float 6s ease-in-out infinite, pulseGlow 2s ease-in-out infinite alternate;
  z-index: 10001;
}

/* Gentle floating up & down */
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}

/* Subtle glowing pulse */
@keyframes pulseGlow {
  from { box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4); }
  to { box-shadow: 0 8px 30px rgba(40, 167, 69, 0.7); }
}

/* Hover = bigger jump + brighter glow */
.chat-launcher:hover {
  transform: translateY(-16px) scale(1.1) !important;
  box-shadow: 0 12px 40px rgba(40, 167, 69, 0.8);
  background: #218838;
}

/* Optional: tiny bounce when page loads */
@keyframes bounceIn {
  0% { transform: scale(0.3); opacity: 0; }
  50% { transform: scale(1.1); }
  70% { transform: scale(0.95); }
  100% { transform: scale(1); opacity: 1; }
}

.chat-launcher {
  animation: bounceIn 1s ease-out, float 6s ease-in-out infinite 1s, pulseGlow 2s ease-in-out infinite alternate;
}

/* Mobile: slightly smaller but still animated */
@media (max-width: 480px) {
  .chat-launcher {
    width: 55px;
    height: 55px;
  }
  .chat-launcher svg { width: 24px; height: 24px; }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }
}

.chat-tooltip {
  position: absolute;
  right: 70px;
  top: 50%;
  transform: translateY(-50%);
  background: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  pointer-events: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.chat-tooltip::after {
  content: '';
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  border: 6px solid transparent;
  border-left-color: #333;
}

.chat-launcher:hover .chat-tooltip {
  opacity: 1;
  visibility: visible;
  right: 68px;
}

.chat-window {
  display: none;
  width: 340px;
  height: 520px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  flex-direction: column;
  overflow: hidden;
  border: 1px solid #eee;
}

.chat-header {
  background: #28A745;
  color: white;
  padding: 14px 90px 14px 40px; /* ‚¨ÖÔ∏è extra RIGHT padding */
  font-weight: 700;
  text-align: left;           /* ‚¨ÖÔ∏è important */
  position: relative;
}


.chat-header::before {
  content: "";
  display: inline-block;
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  margin-right: 8px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.chat-close {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: white;
  font-size: 1.4rem;
  cursor: pointer;
}

.chat-body {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  background: #f8f9fa;
}

.message {
  margin: 10px 0;
  padding: 10px 14px;
  border-radius: 18px;
  max-width: 80%;
  line-height: 1.5;
  font-size: 0.95rem;
}

.user {
  background: #28A745;
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.ai {
  background: white;
  color: #333;
  border: 1px solid #eee;
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.chat-input {
  display: flex;
  padding: 10px;
  border-top: 1px solid #eee;
  background: white;
}

.chat-input input {
  flex: 1;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 25px;
  font-size: 0.95rem;
}

.chat-input button {
  margin-left: 8px;
  background: #28A745;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
}

/* Mobile */
@media (max-width: 480px) {
  .chat-window { width: 306px; height: 480px; }
  .chat-launcher { width: 55px; height: 55px; }
  .chat-launcher svg { width: 24px; height: 24px; }
  .chat-tooltip { display: none; }
}

/* Add inside <style> block */
.report-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

/* ‚Äî‚Äî‚Äî LOGO + GREETING PERFECT ALIGNMENT (copy to all pages) ‚Äî‚Äî‚Äî */
.logo-container {
  display: flex;
  align-items: center;
  gap: 12px;
  height: 40px;                  /* locks the height so everything aligns */
}

.logo-container .logo-icon {
  height: 28px;
  width: auto;
  vertical-align: middle;
  margin-bottom: -2px;           /* tiny nudge for favicons with whitespace */
}

#userDisplay {
  display: none;                 /* hidden when not logged in */
  color: #28A745;
  font-weight: 600;
  font-size: 1.1rem;
  line-height: 1;
  margin: 0;
  white-space: nowrap;
}

/* Optional: slightly smaller greeting on very small phones */
@media (max-width: 480px) {
  #userDisplay {
    font-size: 1rem;
  }
}

/* ==== FOOTER ==== */
.main-footer {
  margin-top: 48px;
  padding: 48px 20px 32px;
  background-color: #f9f9f9;
  border-top: 1px solid #eee;
  color: var(--muted);
  font-size: 14px;
}

.footer-container {
  max-width: 1200px;
  margin: 0 auto 40px auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 40px 60px;
  padding: 0 20px 0 70px;;           /* This line fixes the alignment perfectly */
}

.footer-section h4 {
  margin: 0 0 16px;
  font-size: 16px;
  font-weight: 600;
  color: #333;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.footer-section ul { list-style: none; padding: 0; margin: 0; }
.footer-section li { margin-bottom: 10px; }

.footer-section a {
  color: var(--muted);
  text-decoration: none;
  transition: color 0.2s ease;
}

.footer-section a:hover { color: var(--green); }

.footer-bottom {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 20px 0;      /* Matches the 20px side padding */
  border-top: 1px solid #eee;
  text-align: center;
  font-size: 13px;
}

.footer-legal-links {
  margin-top: 8px;
  font-size: 12px;
  color: var(--muted);
}

.footer-legal-links a {
  color: var(--muted);
  text-decoration: none;
}

.footer-legal-links a:hover {
  color: var(--green);
  text-decoration: underline;
}

.social-links {
  display: flex;
  gap: 16px;
  margin-top: 8px;
}

.social-links a {
  color: var(--muted);
  transition: all 0.2s ease;
  opacity: 0.8;
}

.social-links a:hover {
  color: var(--green);
  opacity: 1;
  transform: translateY(-2px);
}

@media (max-width: 768px) {
  .footer-container {
    grid-template-columns: 1fr;
    text-align: center;
    gap: 40px;                    /* slightly more breathing room */
    padding: 0 20px !important;   /* ‚Üê THIS IS THE KEY: reset the 70px to normal on mobile */
  }

  .social-links {
    justify-content: center;
  }

  .main-footer {
    padding: 48px 20px 32px;
  }

  /* Optional: make headings a bit smaller on mobile for cleaner look */
  .footer-section h4 {
    font-size: 15px;
  }
}


/* ==== HAMBURGER ATTENTION BADGE + PULSE ==== */
.hamburger-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 10px;
  height: 10px;
  background: #ff3b30;
  border: 2px solid white;
  border-radius: 50%;
  animation: pulse-badge 2s infinite;
}
.hamburger.is-new::after {
  content: '';
  position: absolute;
  top: -8px;
  right: -8px;
  width: 14px;
  height: 14px;
  background: var(--green);
  border-radius: 50%;
  animation: pulse-glow 2s infinite;
  pointer-events: none;
}
@keyframes pulse-glow {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.4); }
}

.user-greeting {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--green);
  font-size: 1rem;
  cursor: pointer;
  margin-left: 20px;
  position: relative;
}
.user-avatar {
  position: relative;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid var(--green);
}
.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.online-dot {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 10px;
  height: 10px;
  background: #28A745;
  border: 2px solid white;
  border-radius: 50%;
}
.dropdown-arrow {
  font-size: 0.7em;
  transition: transform 0.2s;
}

/* Mobile: make it smaller */
@media (max-width: 480px) {
  .user-greeting { font-size: 0.95rem; margin-left: 10px; }
  .user-avatar { width: 28px; height: 28px; }
}

/* Hide login buttons when user is logged in */
.auth-btn-hidden {
  display: none !important;
}

.profile-dropdown {
  position: absolute;
  top: 100%;
  right: -100px;
  background: white;
  min-width: 160px;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  padding: 8px 0;
  display: none;
  z-index: 1000;
  border: 1px solid #eee;
  margin-top: 8px;
}
.profile-dropdown a {
  display: block;
  padding: 12px 20px;
  color: #333;
  text-decoration: none;
  font-weight: 500;
}
.profile-dropdown a:hover {
  background: #f8fff8;
  color: var(--green);
}
/* Mobile fix ‚Äî tap works */
@media (max-width: 768px) {
  .user-greeting:active .profile-dropdown {
    display: block;
  }
}

.pdf-tooltip .tooltip-icon {
  cursor: pointer;
  position: relative;
  display: inline-block;
  width: 20px;
  height: 20px;
  background: #28A745;
  color: white;
  border-radius: 50%;
  text-align: center;
  font-weight: bold;
  font-size: 14px;
  line-height: 20px;
  margin-left: 6px;
  margin-right: 4px;

  /* ‚Üê‚Üê‚Üê SUPERCHARGED GLOW STARTS HERE ‚Üê‚Üê‚Üê */
  box-shadow: 
    0 0 12px rgba(40, 167, 69, 0.9),
    0 0 24px rgba(40, 167, 69, 0.6),
    inset 0 0 8px rgba(255,255,255,0.2);   /* tiny inner shine */
  animation: strongPulse 2.4s infinite ease-in-out;
  transition: all 0.25s;
  border: 1px solid rgba(40, 167, 69, 0.4); /* subtle border for extra pop */
}

.pdf-tooltip .tooltip-icon:hover,
.pdf-tooltip .tooltip-icon:active {
  background: #218838;
  box-shadow: 
    0 0 20px rgba(40, 167, 69, 1),
    0 0 40px rgba(40, 167, 69, 0.8),
    0 0 60px rgba(40, 167, 69, 0.4);
  transform: scale(1.25);
  animation: none; /* stop pulsing while hovered so it feels responsive */
}

/* Stronger, faster pulse ‚Äî really grabs attention */
@keyframes strongPulse {
  0%, 100% {
    box-shadow: 
      0 0 12px rgba(40, 167, 69, 0.9),
      0 0 24px rgba(40, 167, 69, 0.6),
      inset 0 0 8px rgba(255,255,255,0.2);
  }
  50% {
    box-shadow: 
      0 0 20px rgba(40, 167, 69, 1),
      0 0 40px rgba(40, 167, 69, 0.9),
      0 0 60px rgba(40, 167, 69, 0.5),
      inset 0 0 12px rgba(255,255,255,0.3);
  }
}

/* Hide on desktop by default */
.mobile-only-pdf-link {
  display: none;
}

/* Show only on mobile */
@media (max-width: 768px) {
  .mobile-only-pdf-link {
    display: inline;
  }
}

/* ‚Äî‚Äî‚Äî CHATBOT BUTTONS ‚Äî‚Äî‚Äî */
.ai .chat-btn {
    display: inline-block !important;
    margin: 10px 8px 4px 0 !important;
    padding: 11px 18px !important;
    background: #28A745 !important;
    color: white !important;
    border: none !important;
    border-radius: 50px !important;
    font-size: 0.95rem !important;
    font-weight: 600 !important;
    text-decoration: none !important;
    cursor: pointer !important;
    box-shadow: 0 3px 8px rgba(40,167,69,0.3) !important;
    transition: all 0.25s ease !important;
    line-height: 1.2 !important;
}

.ai .chat-btn:hover {
    background: #218838 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 16px rgba(40,167,69,0.4) !important;
}

/* Stack buttons nicely on mobile */
@media (max-width: 480px) {
    .ai .chat-btn {
        display: block !important;
        width: 90% !important;
        margin: 8px auto !important;
        text-align: center !important;
    }
}

/* ==================== NEW MULTI-LINE INPUT (replaces the old single-line input) ==================== */
.chat-input {
  display: flex;
  align-items: end; /* keeps send button at bottom even when textarea grows */
  gap: 8px;
  padding: 10px;
}

.chat-input textarea {
  flex: 1;
  min-height: 40px;
  max-height: 160px;           /* when it hits this height, scrollbar appears */
  padding: 12px 14px;
  border: 1px solid #ddd;
  border-radius: 25px;
  font-size: 0.95rem;
  font-family: inherit;
  line-height: 1.5;
  resize: none;                /* no resize handle */
  overflow-y: auto;            /* THIS IS THE KEY ‚Äî enables scrolling inside */
  box-sizing: border-box;
  background: white;
  field-sizing: content;       /* modern browsers: auto-grow until max-height */
  scrollbar-width: thin;       /* Firefox nice scrollbar */
}

/* Thin beautiful scrollbar for Chrome/Edge/Safari */
.chat-input textarea::-webkit-scrollbar {
  width: 6px;
}
.chat-input textarea::-webkit-scrollbar-thumb {
  background: rgba(40,167,69,0.5);
  border-radius: 3px;
}
.chat-input textarea::-webkit-scrollbar-thumb:hover {
  background: #28A745;
}

/* Send button stays same height as the single-line state */
.chat-input button {
  align-self: end; /* keeps it stuck to the bottom */
  margin-bottom: 0;
}

/* Mobile tweaks */
@media (max-width: 480px) {
  .chat-input textarea {
    font-size: 0.9rem;
  }
}

</style>
</head>
<body>

  <div id="redirect-prompt" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; text-align: center; padding-top: 20vh; box-sizing: border-box;">
        <h2>üö® Important: Payment Security</h2>
        <p>For a secure and successful payment, please open this page in your device's full browser.</p>
        <button id="open-external-button" style="padding: 15px 30px; margin-top: 20px; font-size: 1.1em; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Continue in Chrome / Safari
        </button>
    </div>

    <audio id="ada-message-sound" preload="auto">
  <source src="taxcaiadamessage.mp3" type="audio/mpeg">
</audio>

    <header class="main-header">
    <div class="logo-container">
  <a class="logo" href="index.html">
    <img src="./favicon.ico" alt="TaxC Logo" class="logo-icon">
    TaxC
  </a>

  <!-- This whole block only shows when logged in -->
  <div id="user-greeting" class="user-greeting" style="display:none;">
    <div class="user-avatar">
      <img id="user-photo" src="" alt="Profile">
      <span class="online-dot"></span>
    </div>
    <span id="userDisplay">Hi, Name!</span>
    <span class="dropdown-arrow">‚ñº</span>

    <!-- Dropdown MUST be inside user-greeting -->
    <div class="profile-dropdown">
      <a href="#" id="logout-link">Logout</a>
    </div>
  </div>
</div>
        
        <!-- DESKTOP NAV -->
        <nav class="desktop-nav">
            <div class="dropdown" id="desktop-dropdown">
                <span class="dropdown-toggle" onclick="toggleDropdown(event, 'desktop-dropdown')">
                    Detailed Report content
                    <span class="dropdown-arrow">‚ñº</span>
                </span>
                <div class="dropdown-content">
                    <ul>
                        <li><strong>Your tax summary explained clearly</strong></li>
                        <li>All your income sources listed</li>
                        <li>Step-by-step: How your tax was calculated (we do the math!)</li>
                        <li>How much tax you <em>really</em> owe</li>
                        <li>Monthly breakdown (so you can plan)</li>
                        <li>Tips on legally minimizing your tax next year</li>
                        <li>Any tax already paid</li>
                        <li><strong>Direct link to pay your state IRS</strong></li>
                        <li>How & when to file your tax</li>
                        <li>Print-ready PDF, keep it forever</li>
                    </ul>
                </div>
            </div>
            <a href="index.html">Tax lawyer</a>
            <a href="faq.html">FAQ</a>
            <a href="ebooks.html">Ebooks</a>
            <button class="cta-small" id="auth-button"></button>
        </nav>

        <button id="hamburger" class="hamburger is-new" onclick="toggleMobileMenu()" type="button" aria-label="Menu">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
  <!-- This little dot only shows the first time -->
  <span class="hamburger-badge"></span>
</button>

        <!-- BACKDROP -->
<div class="menu-backdrop" id="menu-backdrop" onclick="toggleMobileMenu()"></div>

<!-- MOBILE MENU (now bottom sheet) -->
<nav id="menu" class="mobile-menu">
    <div class="menu-handle"></div>
    
    <div class="dropdown" id="mobile-dropdown">
    <div class="dropdown-toggle" 
         onclick="toggleDropdown(event, 'mobile-dropdown')"
         style="cursor: pointer; -webkit-tap-highlight-color: transparent;">
        Detailed Report content
        <span class="dropdown-arrow">‚ñº</span>
    </div>
    <div class="dropdown-content" style="pointer-events: none; user-select: none;">
        <ul style="pointer-events: auto;">
            <li><strong>Your tax summary explained clearly</strong></li>
            <li>All your income sources listed</li>
            <li>Step-by-step: How your tax was calculated (we do the math!)</li>
            <li>How much tax you <em>really</em> owe</li>
            <li>Monthly breakdown (so you can plan)</li>
            <li>Tips on legally minimizing your tax next year</li>
            <li>Any tax already paid</li>
            <li><strong>Direct link to pay your state IRS</strong></li>
            <li>How & when to file your tax</li>
            <li>Print-ready PDF, keep it forever</li>
        </ul>
    </div>
</div>
    
    <a href="index.html">Connect with a tax lawyer</a>
    <a href="faq.html">Frequently Asked Questions</a>
    <a href="ebooks.html">Ebooks</a>
    <button class="cta-small" id="auth-button-mobile"></button>
</nav>
    </header>
    <main class="container">
        
        <section class="hero-section fade-in">
            <h1>Nigerian Tax Calculator (P.I.T)</h1>
            <p>Use this calculator to find out how much Personal Income Tax (P.I.T.) you should pay. It uses the latest tax rules (NTA 2025 reform) and includes all your deductions, like for your pension, rent, etc.</p>
            <a href="#calculator" class="cta-button">Start Calculation Now</a>
        </section>

        <section id="how-it-works" class="content-section fade-in">
            <h2 class="section-title">üí° How Our Tax Calculator Works</h2>
            <div class="steps-container">
                <div class="step-card fade-in">
                    <span class="step-number">1</span>
                    <h3>Input Income</h3>
                    <p>Enter all income sources (Salary, Rental, Self-Employed, etc.) and choose annual or monthly frequency.</p>
                </div>
                <div class="step-card fade-in">
                    <span class="step-number">2</span>
                    <h3>Apply Deductions</h3>
                    <p>Enter your Pension contributions, Annual Rent, etc, to automatically calculate reliefs based on current tax laws.</p>
                </div>
                <div class="step-card fade-in">
                    <span class="step-number">3</span>
                    <h3>Calculate Tax</h3>
                    <p>Click Calculate Tax to instantly see your estimated annual and monthly tax liability based on Nigerian P.I.T. Act.</p>
                </div>
            </div>
        </section>

        <hr>

        <section id="calculator" class="content-section card-form fade-in">
    <div class="container-content">  <h2 class="section-title">Tax Calculator</h2>
        
        <div id="income-sources-container" class="income-sources-list">
            </div>

        <button onclick="addIncomeSource()" class="add-income-btn">‚ûï Add Another Income Source</button>

        <div class="section-divider">
    <span>Allowable Deductions (2026 Rules)</span>
</div>
<div class="input-row">
    <div class="input-group">
        <label for="pension">Pension Contribution (8%) (‚Ç¶)</label>
        <input type="text" id="pension" oninput="updateFormattedValue(this)" placeholder="e.g. 600,000...Omit if unapplicable">
    </div>
    <div class="input-group">
        <label for="nhf">NHF Contribution (2.5%) (‚Ç¶)</label>
        <input type="text" id="nhf" oninput="updateFormattedValue(this)" placeholder="e.g. 187,500...Omit if unapplicable">
    </div>
</div>
<div class="input-row">
    <div class="input-group">
        <label for="nhis">NHIS Contribution (‚Ç¶)</label>
        <input type="text" id="nhis" oninput="updateFormattedValue(this)" placeholder="e.g. 90,000...Omit if unapplicable">
    </div>
    <div class="input-group">
        <label for="lifeinsurance">Life Insurance Premium (‚Ç¶)</label>
        <input type="text" id="lifeinsurance" oninput="updateFormattedValue(this)" placeholder="e.g. 120,000...Omit if unapplicable">
    </div>
</div>
<div class="input-row">
    <div class="input-group">
        <label for="mortgage">Mortgage Interest (Owner-Occupier) (‚Ç¶)</label>
        <input type="text" id="mortgage" oninput="updateFormattedValue(this)" placeholder="e.g. 800,000...Omit if unapplicable">
    </div>
    <div class="input-group">
        <label for="rent">Annual Rent Paid (‚Ç¶)</label>
        <input type="text" id="rent" oninput="updateFormattedValue(this)" placeholder="e.g. 2,400,000...Omit if unapplicable">
    </div>
</div>
        
        <div class="input-group">
            <label for="state">State of Residence (For P.I.T. purposes)</label>
    <select id="state" name="state" required aria-label="State of Residence">
        <option value="" disabled selected>Select your State...</option>
        <option value="FCT Abuja">FCT Abuja</option>
        <option value="Abia">Abia</option>
        <option value="Adamawa">Adamawa</option>
        <option value="Akwa Ibom">Akwa Ibom</option>
        <option value="Anambra">Anambra</option>
        <option value="Bauchi">Bauchi</option>
        <option value="Bayelsa">Bayelsa</option>
        <option value="Benue">Benue</option>
        <option value="Borno">Borno</option>
        <option value="Cross River">Cross River</option>
        <option value="Delta">Delta</option>
        <option value="Ebonyi">Ebonyi</option>
        <option value="Edo">Edo</option>
        <option value="Ekiti">Ekiti</option>
        <option value="Enugu">Enugu</option>
        <option value="Gombe">Gombe</option>
        <option value="Imo">Imo</option>
        <option value="Jigawa">Jigawa</option>
        <option value="Kaduna">Kaduna</option>
        <option value="Kano">Kano</option>
        <option value="Katsina">Kastina</option>
        <option value="Kebbi">Kebbi</option>
        <option value="Kogi">Kogi</option>
        <option value="Kwara">Kwara</option>
        <option value="Lagos">Lagos</option>
        <option value="Nasarawa">Nasarawa</option>
        <option value="Niger">Niger</option>
        <option value="Ogun">Ogun</option>
        <option value="Ondo">Ondo</option>
        <option value="Osun">Osun</option>
        <option value="Oyo">Oyo</option>
        <option value="Plateau">Plateau</option>
        <option value="Rivers">Rivers</option>
        <option value="Sokoto">Sokoto</option>
        <option value="Taraba">Taraba</option>
        <option value="Yobe">Yobe</option>
        <option value="Zamfara">Zamfara</option>
    </select>
</div>
        
        <button onclick="calculateTax()" class="calculate-btn">Calculate Tax</button>
        <button onclick="resetForm()" class="reset-btn">Reset Calculator</button>
    </div> </section>

        <hr>

        <section id="report" class="content-section card-output fade-in">
    <h2 class="section-title">Tax Summary & Report</h2>
    
    <div id="output" style="display: none;"> 
        <div id="msg" class="message-area"></div> 
        <div id="default-report-message" style="text-align: center; color: #777; padding: 20px 10px; margin: 20px auto; max-width: 600px; border: 1px dashed #ffffff; border-radius: 8px; background-color: #f9f9f9;">
            When you calculate your tax, the summary and breakdown of your estimated annual tax would appear here. You can also pay (optional) to get a detailed <a href="#" 
   class="mobile-only-pdf-link"
   onclick="scrollToWhyReport(event); return false;"
   style="color: #28A745; font-weight: 600; text-decoration: underline; cursor: pointer;">
  PDF report </a>of your tax for just ‚Ç¶900.
        </div>
        <div id="taxSummary"></div>
<div class="report-section">
  <p class="report-prompt" style="font-size:1.1rem; margin-bottom:18px;">
    Why pay ‚Ç¶900
    <span class="tooltip pdf-tooltip">
      
      <span class="tooltip-icon">?</span>
      <span class="tooltiptext pdf-tooltiptext">
        <strong>What‚Äôs different from the tax summary?</strong><br><br>
        The free result shows the number.
        The detailed report explains why, how, and what to do next.<br>
        Most users give feedback that they used the detailed report to understand their taxes from scratch, and can now file confidently without hiring an accountant. 
        <a href="#" 
   class="mobile-only-pdf-link"
   onclick="scrollToWhyReport(event); return false;"
   style="color: #28A745; font-weight: 600; text-decoration: underline; cursor: pointer;">
  PDF report content.
</a>

      </span>
    </span>
  </p>

  <div class="input-group-inline">
    <button id="paystack-btn" class="report-btn">Pay ‚Ç¶900 & Download PDF</button>
  </div>
</div>
    </div>
</section>
    </main>

    <template id="income-template">
  <div class="income-source-block" data-source-id="_INDEX">
    <div class="income-header">
      <h3>Income Source <span class="income-index">1</span></h3>
      <button type="button" class="remove-btn" onclick="removeIncomeSource(this)">Remove</button>
    </div>

    <div class="input-row">
      <div class="input-group">
        <label for="type_INDEX">Source Type</label>
        <select id="type_INDEX" class="income-type" onchange="handleIncomeTypeChange(this)">
          <option value="salary">Salary/Employment</option>
          <option value="self">Self-Employment/Business</option>
          <option value="rental">Rental Income</option>
          <option value="investment">Investment Income</option>
          <option value="other">Other Income</option>
        </select>
      </div>
      <div class="input-group">
        <label for="freq_INDEX">Frequency</label>
        <select id="freq_INDEX" class="income-frequency" onchange="toggleMonthlyInputs(this); handleIncomeTypeChange(document.getElementById('type_INDEX'))">
          <option value="annual">Annual Income (Gross)</option>
          <option value="monthly">Monthly Breakdown</option>
        </select>
      </div>
    </div>

    <!-- GROSS INCOME -->
    <div class="input-group gross-income-container">
      <label for="income_INDEX">Gross Annual Income (‚Ç¶)</label>
      <div class="tooltip">
        <input type="text" id="income_INDEX" class="gross-income" 
               oninput="updateFormattedValue(this)" 
               placeholder="e.g., 1,500,000">
        <span class="tooltiptext">Total income earned in the year before taxes and deductions.</span>
      </div>
    </div>

    <!-- MONTHLY BREAKDOWN -->
    <div class="monthly-income-container" style="display: none;">
      <div class="input-group">
        <label>Gross Monthly Income Breakdown (‚Ç¶)</label>
        <div class="monthly-income-row">
          <!-- JAN -->
      <div class="input-group">
        <label for="jan_INDEX">Jan</label>
        <div class="tooltip">
          <input type="text" 
                 id="jan_INDEX" 
                 data-month="Jan"
                 oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          <span class="tooltiptext">Total income earned in January before taxes and deductions.</span>
        </div>
      </div>
          <!-- FEB -->
          <div class="input-group">
            <label for="feb_INDEX">Feb</label>
            <input type="text" id="feb_INDEX" data-month="Feb" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- MAR -->
          <div class="input-group">
            <label for="mar_INDEX">Mar</label>
            <input type="text" id="mar_INDEX" data-month="Mar" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- APR -->
          <div class="input-group">
            <label for="apr_INDEX">Apr</label>
            <input type="text" id="apr_INDEX" data-month="Apr" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- MAY -->
          <div class="input-group">
            <label for="may_INDEX">May</label>
            <input type="text" id="may_INDEX" data-month="May" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- JUN -->
          <div class="input-group">
            <label for="jun_INDEX">Jun</label>
            <input type="text" id="jun_INDEX" data-month="Jun" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- JUL -->
          <div class="input-group">
            <label for="jul_INDEX">Jul</label>
            <input type="text" id="jul_INDEX" data-month="Jul" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- AUG -->
          <div class="input-group">
            <label for="aug_INDEX">Aug</label>
            <input type="text" id="aug_INDEX" data-month="Aug" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- SEP -->
          <div class="input-group">
            <label for="sep_INDEX">Sep</label>
            <input type="text" id="sep_INDEX" data-month="Sep" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- OCT -->
          <div class="input-group">
            <label for="oct_INDEX">Oct</label>
            <input type="text" id="oct_INDEX" data-month="Oct" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- NOV -->
          <div class="input-group">
            <label for="nov_INDEX">Nov</label>
            <input type="text" id="nov_INDEX" data-month="Nov" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
          <!-- DEC -->
          <div class="input-group">
            <label for="dec_INDEX">Dec</label>
            <input type="text" id="dec_INDEX" data-month="Dec" oninput="updateFormattedValue(this); updateMonthlyTotal(this); markManualEdit(this)">
          </div>
        </div>
        <div class="monthly-total">Total Annual Income: ‚Ç¶0</div>
      </div>
    </div>

    <!-- WHT CREDIT (only for rental/investment/other) -->
<div class="input-group wht-row" style="display:none;">
  <label for="wht_INDEX">WHT Already Deducted/Paid (‚Ç¶)</label>
  <div class="tooltip">
    <input type="text" id="wht_INDEX" class="wht-input" oninput="updateFormattedValue(this)" placeholder="e.g 200,000...Omit if unsure.">
    <span class="tooltiptext">This is tax already deducted by tenant/bank. It reduces your final tax.</span>
  </div>
</div>
  </div>
</template>
<!-- FLOATING CHAT -->
<div id="taxc-chat-widget">
  <div class="chat-launcher" onclick="toggleChat()" aria-label="Chat with TaxC Assistant">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <div class="chat-tooltip">Chat with Ada</div>
  </div>
  <div class="chat-window" id="chat-window">
    <div class="chat-header">
      Ada ‚Äî TaxC Assistant
      <button class="chat-clear" onclick="clearChat()" title="Clear chat">Clear</button>
      <button class="chat-close" onclick="toggleChat()">√ó</button>
    </div>
    <div class="chat-body" id="chat-body">
    </div>
    <div class="chat-input">
      <textarea 
  id="chat-input" 
  placeholder="Type here..." 
  rows="1"
  onkeypress="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendMessage();}"
></textarea>
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

    <footer class="main-footer fade-in">
  <div class="footer-container">

    <div class="footer-section">
      <h4>Product</h4>
      <ul>
        <li><a href="index.html#calculator">Calculator</a></li>
        <li><a href="ebooks.html">Ebooks & Guides</a></li>
        <li><a href="index.html#lawyer">Connect with a Tax Lawyer</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Support</h4>
      <ul>
        <li><a href="faq.html">FAQ</a></li>
        <li><a href="mailto:support@taxc.com.ng">support@taxc.com.ng</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Legal</h4>
      <ul>
        <li><a href="privacy.html">Privacy Policy</a></li>
        <li><a href="terms.html">Terms of Service</a></li>
      </ul>
    </div>

    <!-- Social Media Column -->
    <div class="footer-section">
      <h4>Follow Us</h4>
      <div class="social-links">
        <a href="https://instagram.com/taxc.com.ng" target="_blank" rel="noopener" aria-label="Instagram">
          <!-- Instagram SVG -->
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        </a>
        <a href="https://linkedin.com/company/taxc-com-ng" target="_blank" rel="noopener" aria-label="LinkedIn">
          <!-- LinkedIn SVG -->
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.761 0 5-2.239 5-5v-14c0-2.761-2.239-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
        </a>
      </div>
    </div>

  </div>

  <div class="footer-bottom">
    <p>¬© 2025 TaxC, All rights reserved.</p>
    <p class="footer-legal-links">
      <a href="privacy.html">Privacy</a> ‚Ä¢ 
      <a href="mailto:support@taxc.com.ng">Contact</a>
    </p>
  </div>
</footer>

    <script>
    
const Ada = {
  memory: { name: "", state: "" },

  init() {
    const savedName = localStorage.getItem('taxc_user_name');
    const savedState = localStorage.getItem('taxc_user_state');
    if (savedName) this.memory.name = savedName;
    if (savedState) this.memory.state = savedState;
  },

  saveName(name) {
    this.memory.name = name.trim();
    localStorage.setItem('taxc_user_name', this.memory.name);
  },

    saveState(state) {
    this.memory.state = state.trim();
    localStorage.setItem('taxc_user_state', this.memory.state);
  },

  logUnanswered(input) {
  if (!input || typeof input !== 'string') return;
  const l = input.toLowerCase().trim();
  if (l.length < 3) return;
  if (/^(hi|hello|hey|howfar|good morning|gm|fine|good|okay|my name is|call me|i am|i live in|my state)/i.test(input)) return;

  // FOR TESTING: show in console on localhost and GitHub Pages
  if (location.hostname === "localhost" || 
      location.hostname === "127.0.0.1" || 
      location.href.includes("ejayszn.github.io")) {
    console.log("UNANSWERED (test mode):", input.trim());
  }

  // ONLY SEND TO GOOGLE SHEET WHEN ON REAL DOMAIN
  if (location.hostname === "taxc.com.ng" || location.hostname === "www.taxc.com.ng") {
    fetch('https://script.google.com/macros/s/AKfycbzIC7c4nrfj-EDY9212GRlH0uG_0Y6xsKmaj9k73IcTHzD8BkKUl71-6jVj0BtQH0csUw/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        message: input.trim(), 
        timestamp: new Date().toISOString(),
        page: location.href
      })
    }).catch(() => {});
  }
},

  randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  },

  greet() {
    return this.memory.name ? `Welcome back, ${this.memory.name}.` : "";
  },

  respond(input) {
    this.logUnanswered(input);
    let cleanQuestion = input.trim();
    const l = input.toLowerCase().trim();
    const name = this.memory.name || "there";

    // === 1. PROFESSIONAL GREETINGS ===

    if (/(good ?night|gdnight|gn|night night|night o|oya sleep|sleep well|sleep tight|talk tomorrow|bye for now|later|going to bed)/i.test(l)) {
  return `Good night!
Sleep well and wake up refreshed. I go dey here whenever you need me tomorrow. Sweet dreams!`;
}

    if (/^(hi|hello|hey|howfar|good morning|gm|afternoon|evening|hi ada|hello ada)/i.test(input)) {
      return this.randomChoice([
        `Hello ${name}. How can I assist you with your taxes today?`,
        `Hi ${name}. Welcome. What would you like to know?`,
        `Good to see you${this.memory.name ? ", " + this.memory.name : ""}. How may I help?`
      ]);
    }

    // === 2. USER SAYS THEY'RE FINE ===
    if (/fine|good|okay|great|blessed|not bad/i.test(l)) {
      return `Excellent. How can I assist you today?`;
    }

    // === 3. ORIGINAL PROFESSIONAL FAQS (100% restored) ===
    const faqTriggers = {
      "what taxes does taxc calculate": "TaxC calculates your Personal Income Tax (PIT) based on Nigeria‚Äôs 2025/2026 Nigerian Tax Act (NTA) rules. This includes income from salary, self-employment, rental, investments, and other sources, factoring in allowable deductions like pension contributions and rent relief (up to ‚Ç¶500,000).",
      "who needs to pay personal income tax": "Every Nigerian resident earning income above ‚Ç¶800,000 annually (after deductions) is required to pay Personal Income Tax to their State Internal Revenue Service (IRS). This includes salaried employees, self-employed individuals, and those with rental or investment income.",
      "how does taxc handle deductions": "TaxC allows you to input pension contributions and annual rent paid. For salaried or self-employed individuals, rent relief is calculated as 20% of your rent, capped at ‚Ç¶500,000. These deductions reduce your taxable income, lowering your tax liability. Other deductions may include life insurance, NHF, etc.",
      "what is withholding tax": "Withholding Tax (WHT) is a tax deducted at source on certain incomes, like rental income (10%), or investment income (10%). TaxC lets you input WHT paid or applies default rates, which are credited against your final tax liability to avoid double taxation.",
      "is my data safe": "Yes, TaxC prioritizes your privacy. We don‚Äôt store sensitive payment information. Payments are securely handled by Interswitch. Your input data is used only for calculations and report generation, and we adhere to strict data protection standards.",
      "what‚Äôs included in the pdf report": "The PDF report includes a step-by-step breakdown of your tax calculation, deduction summary (pension, rent relief, etc), tax band details, and filing guidance tailored to your state‚Äôs IRS. It‚Äôs perfect for keeping records or sharing with a tax lawyer.",
      "how do i file my taxes": "TaxC provides an estimate to guide you. To file, submit your tax details to your State IRS, either online via their portal or in person. Our ‚Ç¶500 report includes specific filing guidance for your state.",
      "can taxc help with business taxes": "Currently, TaxC focuses on Personal Income Tax for individuals. For business or corporate taxes, consult a tax professional or contact your State IRS. Our eBooks may offer additional resources for business owners."
    };

    for (const [trigger, answer] of Object.entries(faqTriggers)) {
      const keywords = trigger.toLowerCase().split(" ").filter(w => w.length > 3);
      if (keywords.every(k => l.includes(k))) return answer;
    }

    // === ALL HIGH-PROBABILITY QUESTIONS RESTORED (Professional English) ===

    const lowerL = l.toLowerCase(); // Convert once to lowercase

if (
  lowerL.includes("am i tax eligible") ||
  lowerL.includes("who must pay tax") ||
  lowerL.includes("who pays tax") ||
  lowerL.includes("who then pays tax") ||
  lowerL.includes("personal income tax") ||
  lowerL.includes("do i need to pay tax") ||  // Add this simpler version
  lowerL.includes("need to pay tax") ||
  lowerL.includes("have to pay tax") ||
  lowerL.includes("do i pay tax") ||
  lowerL.includes("unemployed")
) {
  return `You are required to pay Personal Income Tax if you are tax eligible, and your total annual income exceeds ‚Ç¶800,000 after deductions.<br><br>The first ‚Ç¶800,000 is completely tax-free.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Check Your Eligibility</button>`;
}

    if (l.includes("tax on gifts")) {
      return `No. Gifts received by individuals are fully exempt from Personal Income Tax under the 2026 Nigeria Tax Act.`;
    }

    if (l.includes("tax on allowance")) {
      return `Most allowances are taxable. However, medical reimbursements, leave allowance (up to limits), and certain transport subsidies may qualify for relief.`;
    }

    // Refined: Use regex for more precise matching
    if (/bank.*deduct.*tax/.test(l)) {
      return `No. Banks do not automatically deduct Personal Income Tax from accounts. They only report high-value transactions above ‚Ç¶25 million monthly. PAYE is deducted by employers.`;
    }

    if (l.includes("minimum wage") && l.includes("tax") || l.includes("70k") && l.includes("tax")) {
      return `No. The ‚Ç¶70,000 minimum wage (‚Ç¶840,000/year) is mostly within the tax-free threshold of ‚Ç¶800,000. Minimum wage earners pay little or no tax.`;
    }

    if (l.includes("pensioner") || l.includes("retiree") || l.includes("retired") || l.includes("pension tax")) {
      return `Pension income is taxable under PIT, but you get full relief on contributions during working years.<br><br>Tax-free elements: Lump-sum withdrawals up to limits, gratuity.<br><br>Many retirees pay minimal tax due to reliefs.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Pension Tax</button>`;
    }

    if (l.includes("capital gains") || l.includes("tax on profit") || l.includes("sell asset") || l.includes("stock tax") || l.includes("property sale tax")) {
      return `Capital Gains Tax (CGT) is 10% on profits from selling assets like shares, land, or vehicles (exempt for personal residence).<br><br>It's separate from PIT but reported in your annual filing.<br><br>Calculate your CGT liability here.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate CGT</button>`;
    }

    if (l.includes("refund") || l.includes("overpaid") || l.includes("get money back") || l.includes("excess tax")) {
      return `If you've overpaid (e.g., via excess PAYE or WHT), you can claim a refund when filing your annual return.<br><br>Process:<br>‚Ä¢ Submit proof to your State IRS<br>‚Ä¢ Refunds are issued via bank transfer or credit against future tax<br><br>Audit your payments with our calculator.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Check for Refund</button>`;
    }

    if (l.includes("audit") || l.includes("irs notice") || l.includes("tax investigation") || l.includes("what if audited")) {
      return `If audited, provide records like payslips, receipts, and bank statements.<br><br>Stay compliant by filing on time. Audits are random or triggered by discrepancies.<br><br>Our guides can help prepare.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Get Audit Guide</button>`;
    }

    if (l.includes("side hustle") || l.includes("gig") || l.includes("uber") || l.includes("bolt") || l.includes("online business") || l.includes("extra income tax")) {
      return `Income from side hustles is taxable as self-employment income under PIT.<br><br>Deduct business expenses (e.g., fuel, data) to reduce liability.<br><br>File quarterly if income > ‚Ç¶25m/year.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Side Income Tax</button>`;
    }

    if (l.includes("crypto") || l.includes("bitcoin") || l.includes("usdt")) {
      return `Profit from selling cryptocurrency attracts 10% Capital Gains Tax. Income earned in crypto is taxed as regular income.`;
    }

    if (l.includes("non-resident") || l.includes("expat") || l.includes("foreigner") || l.includes("work in nigeria") || l.includes("tax for foreigner")) {
      return `Non-residents pay PIT only on Nigeria-sourced income.<br><br>If here >183 days, you're a resident and taxed on worldwide income.<br><br>Double taxation treaties may apply.<br><br>Consult a professional for your case.<br><br><button class="chat-btn" onclick="location.href='https://taxc.com.ng/lawyer'">Connect With Expert</button>`;
    }

    if (l.includes("vat") || l.includes("value added tax")) {
      return `TaxC specializes in Personal Income Tax. VAT is a separate 7.5% consumption tax handled by FIRS.<br><br>For PIT-related queries, I'm here. Otherwise, check our eBooks for basics.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Download VAT Guide</button>`;
    }

    if (l.includes("new law") || l.includes("tax change") || l.includes("2026 update") || l.includes("recent amendment")) {
      return `Key 2026 changes: Tax-free threshold raised to ‚Ç¶800,000; rent relief capped at ‚Ç¶500,000; progressive rates up to 25%.<br><br>Stay updated with our resources.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Get Latest Updates</button>`;
    } 

    if (l.includes("appeal") || l.includes("disagree") || l.includes("contest tax") || l.includes("wrong assessment")) {
      return `You can appeal to your State IRS within 30 days of assessment.<br><br>Provide evidence; escalate to Tax Appeal Tribunal if needed.<br><br>Our lawyers can assist.<br><br><button class="chat-btn" onclick="location.href='https://taxc.com.ng/lawyer'">Get Appeal Help</button>`;
    }

    if (l.includes("register tin") || l.includes("get tin") || l.includes("apply for tin")) {
      return `Apply for TIN via JTB website (jtb.gov.ng), USSD (*3322#), or State IRS office with your BVN/NIN and ID.<br><br>It's free and takes minutes online.`;
    }

    // === LANDLORD / RENTAL INCOME TAX (Fixes the "I am a landlord" bug) ===
    // Refined: More precise with regex
    if (l.includes("landlord") || l.includes("rental income") || l.includes("rent i collect") || /tenant.*tax/.test(l)) {
      return `
        As a landlord you must pay Personal Income Tax on rental income.<br><br>
        Key points:<br>
        ‚Ä¢ Rental income is taxed at your normal PIT rate<br>
        ‚Ä¢ Your tenant should deduct 10% Withholding Tax (WHT) and remit it ‚Äî you get credit<br>
        ‚Ä¢ You still file annually and declare the full amount<br><br>
        Want to calculate your exact tax on rental income?<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Landlord Tax</button>
      `;
    }

    // Refined: Regex for employer not deduct
    if (/employer.*(deduct|paye|tax|withhold)|deduct.*(employer|paye)|already.*(deduct|paye)/i.test(l)) {
  return `Your employer is legally required to deduct PAYE monthly from your salary and remit it to the tax authority. If they are not doing it, you remain personally liable and must file/pay yourself before 31 March to avoid penalties.`;
}

    if (l.includes("paye") || l.includes("wetin be paye") || l.includes("payee")) {
      return `PAYE (Pay As You Earn) is tax your employer deducts monthly from your salary and remits to the government. You still need to file annually to reconcile.`;
    }

    if (
  /student.*(pay|tax)/.test(l) ||
  /(nysc|allowance).*tax/.test(l) ||
  /tax.*(nysc|allowance)/.test(l) ||
  /(pay|deduct).*tax.*(nysc|allowance)/.test(l)
) {
  return `Students in Nigeria pay no tax on scholarships, bursaries, or allowances. These are fully exempt under the Personal Income Tax Act.<br><br>

NYSC allowance is also not taxable. The Federal Government classifies it as a stipend, not employment income. Most corps members pay zero tax on their monthly allawee.<br><br>

Although, students, NYSC corpers, and Nigerians as a whole only pay tax if you are tax eligible, and have separate income (business/job/freelance) that goes above ‚Ç¶800,000 per year.`;
}


    if (/(what can you do)|(how can you help)|(capabilities|expertise|specialize)|(help me)|(menu)/.test(l)) {
      return `I‚Äôm here to make Nigerian taxes simple for you.
        <br><br>
        I can explain:
        <ul>
            <li>PAYE (Pay-As-You-Earn)</li>
            <li>Freelance / Self-Employed Tax Rules</li>
            <li>Company Taxes and VAT</li>
            <li>Tax Clearance Certificates (TCC)</li>
            <li>Filing Deadlines and Procedures</li>
            <li>Student & NYSC Allowance Rules</li>
            <li>Tax implications for Side Hustles</li>
            <li>Or literally **any** Nigerian tax question you have... all in clear, straightforward English.</li>
        </ul>
        <br>
        Just ask anything!`;
    }

    // Check age/minor questions FIRST (more specific)
if (/(age|minimum age|age range|minor|under 18|below 18|child|kids).*?(tax|paye|pay tax|paying tax)/i.test(l) ||
    /(tax|paye).*?(age|minimum age|age range|minor|under 18|below 18|child|kids)/i.test(l)) {
  return `Under the new Nigeria Tax Act (NTA) 2025, effective January 1, 2026, the age range for being subject to personal income tax remains 18 and above. However, individuals are only liable for tax if their annual income exceeds a certain threshold (‚Ç¶800,000).`;
}

// Then check penalties (now narrower to avoid false matches)
if (/(dont pay|not pay|fail to pay|non-payment|evade|avoid tax|consequence|penalty|what happen if not pay|tax fine|tax jail)/i.test(l)) {
  return `Not paying tax in Nigeria leads to penalties: 10% of the unpaid amount + 1.25% monthly interest. Serious cases can result in fines up to ‚Ç¶1 million, asset seizure, or up to 3 years in prison under NTA 2025. Pay on time to avoid!`;
}

    if (l.includes("previous year") || l.includes("never filed") || l.includes("back tax")) {
      return `You can file for previous years now. Penalties apply, but voluntary filing reduces them. Many states offer waiver programmes.`;
    }

    if (l.includes("tin") || l.includes("tax identification number")) {
      return `Retrieve your TIN via verify.jtb.gov.ng, *3322#, old payslip, or any State IRS office with your BVN/NIN.`;
    }

    // Refined: Regex for landlord receipt
    if (/landlord.*receipt/.test(l)) {
      return `You can still claim rent relief using bank transfers, tenancy agreement + affidavit, or electronic receipts. TaxC accepts these.`;
    }

    if (l.includes("two states") || /which state.*pay/.test(l)) {
      return `You pay PIT to the state where you reside or work for more than 183 days per year.`;
    }

    // Refined: More precise
    if (/married|spouse|children.*relief/.test(l)) {
      return `Nigeria uses individual filing only. Consolidated relief: 20% of income + ‚Ç¶200,000. Child allowance: ‚Ç¶2,500 per child (max 4).`;
    }

    if (l.includes("lost job") || /unemployed.*file/.test(l)) {
      return `You should still file a Nil return to maintain a clean tax record.`;
    }

    if (l.includes("freelance") || l.includes("remote") || l.includes("self-employed")) {
      return `Freelancers and remote workers (basically people who do not work in a structured Nigerian organization) must register with their State IRS, file annually by 31 March, and may pay advance tax quarterly. TaxC guides you step by step.`;
    }

    // Refined: Regex
    if (/who.*collect.*tax|where.*pay.*tax|which.*irs|tax.*authority|fir.*state|state.*irs|tax.*collected.*(fir|state)/i.test(l)) {
      return `Pay via your State IRS portal or designated banks. Example: Lagos ‚Üí paydirect.lirs.net`;
    }

    if (l.includes("installment") || l.includes("part payment")) {
      return `Some states allow installments with prior approval. Lagos does NOT permit PIT installments.`;
    }

    // Refined: Regex
    if (/arrest|jail.*tax/.test(l)) {
      return `No. Tax debt alone does not lead to arrest. Extreme cases may result in account restrictions.`;
    }

    if (l.includes("tcc") || l.includes("tax clearance")) {
      return `After filing and payment, apply on your State IRS portal. Usually issued instantly or within 48 hours.`;
    }

    // Refined: Regex
    if (/how often.*file/.test(l) || l.includes("file every month") || l.includes("monthly") || l.includes("yearly")) {
      return `You file Personal Income Tax returns once per year (by 31 March). PAYE is deducted monthly by employers automatically.`;
    }

    if (/when.*pay.*tax/.test(l) || l.includes("deadline")) {
      return `Deadline for annual filing and final payment: 31 March of the following year.`;
    }

    if (l.includes("not pay tax") || l.includes("tax free") || l.includes("exempt")) {
      return `Tax-free items include: gifts, scholarships, inheritance, proceeds from personal residence sale, NYSC allowance (mostly), lottery winnings, life insurance payouts.`;
    }

    // Pidgin additions + typos
    if ((l.includes("calculate") || l.includes("how much tax") || l.includes("owe") || l.includes("how much tax i go pay") || l.includes("wetin i go pay")) && !l.includes("state")) {
      return `Let me calculate your exact tax liability.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Open Calculator</button>`;
    }

    if (l.includes("free") || l.includes("ebook") || l.includes("download")) {
      return `Free tax guides are available.<br><br><button class="chat-btn" onclick="location.href='ebooks.html#free'">Download Now</button>`;
    }

    // === EXTRA QUERIES FROM OLD V2.0 (Now Clean & Professional) ===

    // 1. What is my tax band? + typos + pidgin
    if (l.includes("what band") || l.includes("which band") || l.includes("my band") || l.includes("what tax band do i fall") || l.includes("tax bannd") || l.includes("tax brackett") || l.includes("tax bracked") || l.includes("wetin be tax band") || l.includes("which tax band i dey")) {
      return `To determine your exact tax band, I need your total annual income (salary + other sources).<br><br>Please click on the button below, share an estimate, and get the PDF report(It contains the tax bands) and I will tell you immediately.<br><br><button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate Now</button>`;
    }

    // 2. How was your night? / How are you? (already has pidgin "how you dey")
    if (l.includes("how was your night") || l.includes("how your night") || l.includes("how are you") || l.includes("how you dey")) {
      return `I'm functioning perfectly and ready to help you with your taxes. How may I assist you today?`;
    }

    // 3. Are you an AI or chatbot?
    if (l.includes("are you an ai") || l.includes("artificial intelligence") || l.includes("chat bot or ai") || l.includes("are you a chat bot?") || l.includes("are you ai?") || l.includes("bot?")) {
      return `I am a smart chatbot designed specifically to help Nigerians understand and calculate Personal Income Tax under the 2025/2026 rules. I provide accurate, instant answers based on the latest tax laws.`;
    }

    // 4. Who made you / Who created TaxC?
    if (l.includes("who made you") || l.includes("who created") || l.includes("creator") || l.includes("who made taxc")) {
      return `TaxC and I (Ada) were created by Emmanuel Oguibe, a Nigerian tax expert dedicated to making tax simple and accessible for everyone.`;
    }

    // 5. How can I save money on tax? / Reduce tax? + pidgin
    if ((l.includes("save money") && l.includes("tax")) || l.includes("reduce tax") || l.includes("pay less tax") || l.includes("how i fit save for tax") || l.includes("abeg how to reduce tax") || l.includes("rent reduce my")) {
      return `You can legally reduce your tax through:<br><br>
        ‚Ä¢ Rent relief (up to ‚Ç¶500,000)<br>
        ‚Ä¢ Pension contributions<br>
        ‚Ä¢ NHF and NHIS (where applicable)<br>
        ‚Ä¢ Business expense deductions (self-employed)<br><br>
        Many Nigerians save ‚Ç¶500,000‚Äì‚Ç¶3 million annually by claiming these correctly.<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">See How Much You Can Save</button>`;
    }

    // 6. Simple explanations for key terms (WHT, PAYE, Rent Relief, etc.) + pidgin + typos
    if (l.includes("wht") || l.includes("withholding tax") || l.includes("wetin be wht") || l.includes("withholiding tax") || l.includes("witholding")) {
      return `Withholding Tax (WHT) is tax deducted at source before payment is made to you. Example: Tenant deducts 10% from rent and pays it directly to government. You get credit for it when filing.`;
    }
    if (l.includes("rent relief") || l.includes("wetin be rent relief") || l.includes("rent releif") || l.includes("rent relif")) {
      return `Rent relief allows you to deduct up to ‚Ç¶500,000 from your taxable income if you pay house rent. This can save you tens or hundreds of thousands in tax.`;
    }

    // Consolidated Relief Allowance
if (/consolidated.*relief|relief.*allowance|CRA/i.test(l)) {
  return `Under the Nigeria Tax Act 2025 (effective January 1, 2026), the Consolidated Relief Allowance (CRA) has been abolished and replaced by a rent relief: 20% of annual rent paid, capped at ‚Ç¶500,000 (for renters only). Homeowners get no equivalent relief. The first ‚Ç¶800,000 of income remains tax-free via the new progressive bands, so most people earning ‚â§ ‚Ç¶800k per year pay little or no tax.`;
}

    // 7. Off-topic / inappropriate redirection (clean version)
    if (/(love you|marry|boyfriend|girlfriend|date|send pic|nude|sexy|horny|sex)/i.test(l)) {
      return `Let's stay focused on helping you with your taxes. That's what I'm here for. How can I assist you today?`;
    }

    // What is your name? + pidgin
    if (l.includes("what is your name") || l.includes("whats your name") || l.includes("who are you") || l.includes("wetin be your name") || l.includes("who you be")) {
      return `My name is Ada. I am your dedicated digital tax assistant.`;
    }

    // Are the calculations accurate / correct?
    if (l.includes("accurate") || l.includes("correct") || l.includes("can i trust") || l.includes("calculations")) {
      return `All TaxC calculations strictly follow the official 2025/2026 Nigerian Tax Act.<br><br>For complex cases or extra peace of mind, you can connect with a verified tax lawyer here:<br><br>
        <button class="chat-btn" onclick="location.href='https://taxc.com.ng/lawyer'">Connect With Tax Lawyer</button>`;
    }

    // === WHAT ARE THE TAX BANDS? (2026 Nigerian PIT Rates ‚Äì Clean & Beautiful) + typos + pidgin
    if (l.includes("tax band") || l.includes("tax rate") || l.includes("tax bracket") || l.includes("how much percent") || l.includes("tax table") || l.includes("pit rate") || l.includes("tax bannd") || l.includes("tax brackett") || l.includes("tax bracked") || l.includes("wetin be tax rate") || l.includes("how much percent tax")) {
      return `
        Here are the official 2026 Personal Income Tax rates in Nigeria:<br><br>
        ‚Ä¢ First ‚Ç¶800,000 of taxable income ‚Üí <strong>0% (completely tax-free)</strong><br>
        ‚Ä¢ Next ‚Ç¶2,200,000 (‚Ç¶800,001 ‚Äì ‚Ç¶3,000,000) ‚Üí <strong>15%</strong><br>
        ‚Ä¢ Next ‚Ç¶9,000,000 (‚Ç¶3,000,001 ‚Äì ‚Ç¶12,000,000) ‚Üí <strong>18%</strong><br>
        ‚Ä¢ Next ‚Ç¶13,000,000 (‚Ç¶12,000,001 ‚Äì ‚Ç¶25,000,000) ‚Üí <strong>21%</strong><br>
        ‚Ä¢ Next ‚Ç¶25,000,000 (‚Ç¶25,000,001 ‚Äì ‚Ç¶50,000,000) ‚Üí <strong>23%</strong><br>
        ‚Ä¢ Anything above ‚Ç¶50,000,000 ‚Üí <strong>25%</strong><br><br>

        <em>Example:</em> If your taxable income is ‚Ç¶5 million:<br>
        ‚Üí First ‚Ç¶800k = ‚Ç¶0 tax<br>
        ‚Üí Next ‚Ç¶2.2m = ‚Ç¶330,000 tax<br>
        ‚Üí Remaining ‚Ç¶2m = ‚Ç¶360,000 tax<br>
        <strong>Total tax = ‚Ç¶690,000</strong><br><br>

        Want to know exactly how much you‚Äôll pay?<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate My Tax Now</button>
      `;
    }

    // === IS STATE NEEDED IN TAX CALCULATION? (NOW CATCHES EVERYTHING) ===
    if (
      l.includes("state") && (
        l.includes("need") || 
        l.includes("require") || 
        l.includes("important") || 
        l.includes("necessary") ||
        l.includes("why") && l.includes("state") ||
        l.includes("do you") && l.includes("state") ||
        l.includes("matter")
      )
    ) {
      return `
        Your state of residence is needed for an accurate and complete tax result.<br><br>
        Here‚Äôs why:<br>
        ‚Ä¢ Personal Income Tax is paid to your State Internal Revenue Service (not federal)<br>
        ‚Ä¢ The final PDF report TaxC generates must show the correct state so you can file properly<br>
        ‚Ä¢ Some states have small differences in approved deductions or filing rules<br><br>
        It only takes 2 seconds to select your state in the calculator ‚Äî everything else is automatic.<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Start Calculation ‚Üí Choose Your State</button>
      `;
    }

    // === NAME & STATE (Professional) ===
    if (l.includes("my name is") || l.includes("call me") || l.includes("i am")) {
      const match = input.match(/(?:my name is|call me|i'm|my name|name is )([\w\s]+)/i);
      if (match) {
        this.saveName(match[1]);
        return `Thank you, ${this.memory.name}. I have saved your name. How may I assist you?`;
      }
    }

    if (l.includes("what is my name") || l.includes("remember my name")) {
      return this.memory.name ? `Your name is ${this.memory.name}.` : `You haven‚Äôt shared your name yet.`;
    }

    if (l.includes("my state") || l.includes("i live in") || l.includes("i stay in")) {
      const states = [
  "abuja", "fct", "abia", "adamawa", "akwa ibom", "anambra", "bauchi", "bayelsa",
  "benue", "borno", "cross river", "delta", "ebonyi", "edo", "ekiti", "enugu",
  "gombe", "imo", "jigawa", "kaduna", "kano", "katsina", "kebbi", "kogi",
  "kwara", "lagos", "nasarawa", "niger", "ogun", "ondo", "osun", "oyo",
  "plateau", "rivers", "sokoto", "taraba", "yobe", "zamfara"
];
      for (const s of states) {
        if (l.includes(s)) {
          this.saveState(s.charAt(0).toUpperCase() + s.slice(1));
          return `Noted. You are in ${this.memory.state}. Tax rules vary slightly by state.`;
        }
      }
    }

    // Edge case: Very short inputs like "tax?" or "tax"
    if (l === "tax" || l === "tax?" || l === "pit" || l === "pit?") {
      return `
        Hello${this.memory.name ? ", " + this.memory.name : ""}.<br><br>
        Personal Income Tax (PIT) is a tax on your earnings in Nigeria. How can I help you with it today?<br><br>
        <button class="chat-btn" onclick="location.href='index.html#calculator'">Calculate My Tax</button>
      `;
    }

    // === SAFE LATE FILING / PENALTY (won‚Äôt eat normal questions anymore) ===
if (/penalty|late.*(filing|payment|file|submission)|file.*late|overdue|miss.*deadline/i.test(l)) {
  return `Late filing: ‚Ç¶50,000 for individuals (may be ‚Ç¶5,000 fine + ‚Ç¶100/day depending on state/LGA)<br>Late payment: 10% penalty per annum + interest at the prevailing CBN rate<br>File on time to avoid these charges.`;
}

    // === FINAL FALLBACK ===
¬† ¬† 
    let responseText = "";
    
    // Check if the user asked a question (cleanQuestion is the input)
    // 2. Access cleanQuestion, which is now defined.
    if (cleanQuestion) { // <--- The error happens if this runs before the line above
        // Option 1: Acknowledge the question specifically
        responseText = `
            Sorry, I couldn't find a direct answer to your inquiry about <strong>"${cleanQuestion}"</strong>.
        `;
    } else {
        // Option 2: Generic greeting if no question was asked
        responseText = `${this.greet() ? this.greet() : "Hello."}`;
    }

    // Now combine the custom response with the list of capabilities
    return `
    ${responseText}<br><br>
    However, I can definitely help if you have any other questions like tax calculation, deductions, etc.
    <div style="margin-top:12px;">
        <a href="index.html#calculator" class="chat-btn">Calculate My Tax</a>
        <a href="ebooks.html#free" class="chat-btn">Download Free Guides</a>
    </div>
`;
} 
};

// === CHAT UI ===
let hasNewMessage = false;

function toggleChat() {
¬† const win = document.getElementById('chat-window');
¬† const launcher = document.querySelector('.chat-launcher');
¬† win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
¬† if (win.style.display === 'flex') {
¬† ¬† hasNewMessage = false;
¬† ¬† launcher.classList.remove('has-notification');
¬† ¬† // ‚≠ê NEW: Clear the unread status when the chat is opened/read
¬† ¬† localStorage.removeItem('taxc_ai_has_unread'); 

¬† ¬† setTimeout(() => document.getElementById('chat-input')?.focus(), 300);
    setTimeout(scrollToBottom, 100);
¬† }
}

// -------------------------------------------------
// SAVE CHAT HISTORY TO LOCALSTORAGE
// -------------------------------------------------
function saveChat() {
  const messages = [];
  document.querySelectorAll('#chat-body .message').forEach(msg => {
    messages.push({
      text: msg.innerHTML,
      type: msg.classList.contains('user') ? 'user' : 'ai'
    });
  });
  localStorage.setItem('taxc_chat_history', JSON.stringify(messages));
}

function scrollToBottom() {
  const body = document.getElementById('chat-body');
  if (body) {
    body.scrollTop = body.scrollHeight;
    body.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }
}
// Auto-grow the textarea as user types, stop growing at max-height ‚Üí scroll appears
function autoResizeTextarea() {
  const ta = document.getElementById('chat-input');
  ta.style.height = 'auto';                    // reset
  ta.style.height = ta.scrollHeight + 'px';    // grow to fit content
}

// Reset height after sending
function resetTextareaHeight() {
  const ta = document.getElementById('chat-input');
  ta.style.height = 'auto';
  ta.value = '';
  autoResizeTextarea();
}

function addMessage(text, type, isInitialLoad = false) {
  const body = document.getElementById('chat-body');
  const div = document.createElement('div');
  div.className = `message ${type}`;
  div.innerHTML = text;
  body.appendChild(div);
  
  // Scroll to bottom
  scrollToBottom();

¬† // === PLAY SOUND ONLY FOR ADA'S REAL REPLY (not loading dots) ===
¬† if (type === 'ai' && window.adaSound && !text.includes('typing')) {
¬† ¬† window.adaSound.currentTime = 0;
¬† ¬† window.adaSound.play().catch(() => {});
¬† }

¬† // === NOTIFICATION BUBBLE (when chat is closed) ===
¬† // Trigger only if it's an AI message, NOT an initial load, and the chat is closed
¬† if (type === 'ai' && !isInitialLoad && document.getElementById('chat-window').style.display !== 'flex') {
¬† ¬† hasNewMessage = true;
¬† ¬† document.querySelector('.chat-launcher').classList.add('has-notification');
¬† ¬† // ‚≠ê NEW: Persist the unread status in localStorage
¬† ¬† localStorage.setItem('taxc_ai_has_unread', 'true'); 
¬† }
}

// -------------------------------------------------
// CLEAR CHAT + CONFIRM
// -------------------------------------------------
function clearChat() {
  if (confirm("Are you sure you want to clear chat?")) {
    document.getElementById('chat-body').innerHTML = '';
    localStorage.removeItem('taxc_chat_history');
  }
}

function sendMessage() {
  const textarea = document.getElementById('chat-input');
  let text = textarea.value.trim();

  if (!text) return;

  // Show user's message (preserve line breaks)
  addMessage(text.replace(/\n/g, '<br>'), 'user');

  // Clear and shrink textarea
  textarea.value = '';
  autoResizeTextarea();

  // Show typing indicator
  addMessage('<i class="typing">‚Ä¢‚Ä¢‚Ä¢</i>', 'ai');

  // Reply after delay
  setTimeout(() => {
    const messages = document.querySelectorAll('.message');
    if (messages.length > 0) messages[messages.length - 1].remove();
    addMessage(Ada.respond(text), 'ai');
  }, 1000);
}

document.addEventListener('DOMContentLoaded', () => {
¬† Ada.init();
¬† 
¬† // ‚≠ê NEW: Check and apply saved notification status immediately on page load
¬† const launcher = document.querySelector('.chat-launcher');
¬† if (localStorage.getItem('taxc_ai_has_unread') === 'true') {
¬† ¬† launcher.classList.add('has-notification');
¬† }

¬† // ==== LOAD PREVIOUS CHAT ====
¬† const savedChat = localStorage.getItem('taxc_chat_history');
¬† if (savedChat) {
¬† ¬† const messages = JSON.parse(savedChat);
¬† ¬† // Pass 'true' to ensure history re-load doesn't re-trigger notification
¬† ¬† messages.forEach(msg => addMessage(msg.text, msg.type, true)); 
    setTimeout(scrollToBottom, 100);
¬† }

¬† // === INIT ADA SOUND ===
¬† const adaSound = document.getElementById('ada-message-sound');
¬† if (adaSound) {
¬† ¬† adaSound.volume = 0.6;
¬† ¬† window.adaSound = adaSound;
¬† }

¬† // ==== FIRST-TIME WELCOME (if no name & no chat) ====
¬† if (!Ada.memory.name && !savedChat) {
¬† ¬† // Pass 'true' to prevent this greeting from triggering a notification
¬† ¬† addMessage("Hi! I'm <strong>Ada</strong>, your digital tax assistant. Ask me anything about taxes, filing, or ebooks!", 'ai', true); 
¬† }

¬† // === ONLY SHOW "WELCOME BACK" IF NO CHAT HISTORY ===
¬† if (Ada.memory.name) {
¬† ¬† const hasChat = localStorage.getItem('taxc_chat_history') && 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† JSON.parse(localStorage.getItem('taxc_chat_history')).length > 0;
¬† ¬† 
¬† ¬† if (!hasChat) {
¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† // Pass 'true' to prevent this greeting from triggering a notification
¬† ¬† ¬† ¬† addMessage(`Welcome back, ${Ada.memory.name}! Howfar today?`, 'ai', true); 
¬† ¬† ¬† }, 800);
¬† ¬† }
¬† }
});

// === CSS: Notification Badge + Clean Numbers ===
const style = document.createElement('style');
style.textContent = `
  .chat-btn {
    background: #28A745; color: white; border: none; padding: 10px 18px;
    border-radius: 8px; cursor: pointer; font-weight: 600; margin: 8px 0;
    display: inline-block; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: all 0.2s;
  }
  .chat-btn:hover { background: #218838; transform: translateY(-1px); }

  .typing { animation: blink 1s infinite; }
  @keyframes blink { 0%,100% { opacity: 1 } 50% { opacity: 0.3 } }

  /* === FIXED: Clean Numbering === */
  .message ol {
    counter-reset: item;
    padding-left: 0;
    margin: 12px 0;
  }
  .message ol li {
    display: block;
    margin: 10px 0;
    padding-left: 30px;
    position: relative;
    line-height: 1.5;
  }
  .message ol li:before {
    content: counter(item);
    counter-increment: item;
    position: absolute;
    left: 0;
    background: #28A745;
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.85rem;
  }

  /* === NOTIFICATION BADGE === */
  .chat-launcher {
    position: relative;
  }
  .chat-launcher.has-notification::after {
    content: '';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background: #ff3b30;
    border-radius: 50%;
    border: 2px solid white;
    animation: pulse-badge 2s infinite;
  }
  @keyframes pulse-badge {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
`;
document.head.appendChild(style);

        // Placeholder functions for showTooltip and hideTooltip
        function showTooltip(element, text) {
            if (element) {
                element.textContent = text || element.textContent;
                element.style.visibility = 'visible';
                element.style.opacity = '1';
            }
        }
        function hideTooltip(element) {
            if (element) {
                element.style.visibility = 'hidden';
                element.style.opacity = '0';
            }
        }

        function scrollToSection(event) {
            event.preventDefault();
            const href = event.target.getAttribute('href');
            const targetId = href.substring(1); 
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            }
            toggleMobileMenu(); 
        }

        function getRawValue(inputElement) {
            if (!inputElement) return 0;
            const value = inputElement.value.replace(/[^0-9]/g, '');
            return Number(value) || 0;
        }

        function updateFormattedValue(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            const rawValue = Number(value);
            input.value = rawValue.toLocaleString('en-NG');
        }

        function updateMonthlyTotal(input) {
            const block = input.closest('.income-source-block');
            if (!block) return;
            
            const monthlyInputs = block.querySelectorAll('.monthly-income-row input');
            let total = 0;
            monthlyInputs.forEach(inp => {
                const value = getRawValue(inp);
                total += value;
            });
            const totalDisplay = block.querySelector('.monthly-total');
            if (totalDisplay) {
                totalDisplay.textContent = `Total Annual Income: ‚Ç¶${total.toLocaleString('en-NG')}`;
            }
        }

        function markManualEdit(input) {
            input.dataset.manual = 'true';
        }

        function handleMonthlySalaryAutoFill(block) {
    const monthlyInputs = block.querySelectorAll('.monthly-income-row input');
    const januaryInput = monthlyInputs[0];

    // 1. Remove existing handler to prevent duplicates
    if (januaryInput.autoFillHandler) {
        januaryInput.removeEventListener('input', januaryInput.autoFillHandler);
        januaryInput.autoFillHandler = null;
    }

    if (block.querySelector('.income-type').value === 'salary' && block.querySelector('.income-frequency').value === 'monthly') {
        const autoFillHandler = (e) => {
            // Prevent recursive calls when dispatching the event below
            if (e.isTrusted === false && e.type === 'input') return;

            const janValueRaw = getRawValue(januaryInput); // Get the raw number value
            const janFormattedValue = januaryInput.value; // Get the formatted string

            monthlyInputs.forEach((input, index) => {
                // Skip January (index 0)
                // Skip any month that has been manually edited by the user
                if (index !== 0 && input.dataset.manual !== 'true') {
                    
                    if (janValueRaw === 0) {
                        // FIX: Clear the input if January is empty/zero
                        input.value = '';
                    } else {
                        // FIX: Use the formatted string from Jan
                        input.value = janFormattedValue;
                    }
                    
                    // Manually trigger total update on these fields. 
                    // We don't dispatch an 'input' event because it can cause infinite loops
                    // due to the updateFormattedValue(this) and updateMonthlyTotal(this) calls.
                    // Instead, we just call updateMonthlyTotal once after the loop.
                }
            });
            
            // Recalculate the total annual income once after the loop finishes
            updateMonthlyTotal(januaryInput);
        };

        januaryInput.autoFillHandler = autoFillHandler;
        januaryInput.addEventListener('input', autoFillHandler);

        // If January already has a value when the function runs, trigger a fill
        if (januaryInput.value) {
            januaryInput.dispatchEvent(new Event('input'));
        }
    }
}

        function handleIncomeTypeChange(selectEl) {
            const block = selectEl.closest('.income-source-block');
            
            toggleWhtField(selectEl);
            
            const januaryInput = block.querySelector('.monthly-income-row input[data-month="Jan"]');
            if (januaryInput) {
                if (januaryInput.autoFillHandler) {
                    januaryInput.removeEventListener('input', januaryInput.autoFillHandler);
                    januaryInput.autoFillHandler = null;
                }
                if (selectEl.value === 'salary' && block.querySelector('.income-frequency').value === 'monthly') {
                    handleMonthlySalaryAutoFill(block);
                }
            }
        }

        function toggleMonthlyInputs(selectEl) {
            const block = selectEl.closest('.income-source-block');
            const monthlyContainer = block.querySelector('.monthly-income-container');
            const grossIncomeContainer = block.querySelector('.gross-income-container');
            const typeSelect = block.querySelector('.income-type');

            if (selectEl.value === 'monthly') {
                monthlyContainer.style.display = 'block';
                grossIncomeContainer.style.display = 'none';
                if (block.querySelector('.gross-income')) block.querySelector('.gross-income').value = '';
                
                handleIncomeTypeChange(typeSelect); 
                
                const firstMonthlyInput = block.querySelector('.monthly-income-row input');
                if(firstMonthlyInput) updateMonthlyTotal(firstMonthlyInput);
            } else {
                monthlyContainer.style.display = 'none';
                grossIncomeContainer.style.display = 'block';
                
                const januaryInput = block.querySelector('.monthly-income-row input[data-month="Jan"]');
                if (januaryInput && januaryInput.autoFillHandler) {
                    januaryInput.removeEventListener('input', januaryInput.autoFillHandler);
                    januaryInput.autoFillHandler = null;
                }

                block.querySelectorAll('.monthly-income-row input').forEach(input => {
                    input.value = '';
                    input.dataset.manual = 'false';
                });
                const monthlyTotal = block.querySelector('.monthly-total');
                if(monthlyTotal) monthlyTotal.textContent = 'Total Annual Income: ‚Ç¶0';
            }
        }

    function toggleWhtField(selectElement) {
    const type = selectElement.value;
    const block = selectElement.closest('.income-source-block');
    const whtRow = block.querySelector('.wht-row');
    const tooltip = block.querySelector('.wht-row .tooltiptext');
    if (!whtRow) return;

    // Show WHT field for Rental, Investment, AND Other
    if (type === 'rental' || type === 'investment' || type === 'other') {
        whtRow.style.display = 'flex';

        if (type === 'other') {
            tooltip.innerHTML = `
                Enter actual WHT paid (if any, e.g. 5-10% on consulting fees).<br>
                Students, gifts, personal sales? Leave blank (‚Ç¶0‚Äîno credit needed).
            `;
        } else {
            tooltip.innerHTML = `
                WHT = 10% tax your tenant/bank pays to govt BEFORE giving you the rest.<br>
                Leave blank ‚Üí we use standard 10%.
            `;
        }
    } else {
        // Hide only for Salary & Self-Employment
        whtRow.style.display = 'none';
        const input = block.querySelector('.wht-input');
        if (input) input.value = '';
    }
}

        function addIncomeSource() {
            const template = document.getElementById('income-template');
            const container = document.getElementById('income-sources-container');
            const newIndex = container.children.length;

            const clone = document.importNode(template.content, true);
            const block = clone.querySelector('.income-source-block');

            block.setAttribute('data-source-id', newIndex);
            block.querySelector('.income-index').textContent = newIndex + 1;
            
            let htmlContent = block.innerHTML;
            htmlContent = htmlContent.replace(/_INDEX/g, `_${newIndex}`);
            block.innerHTML = htmlContent;

            container.appendChild(clone);
            const newBlock = container.lastElementChild;

            const grossIncomeInput = newBlock.querySelector(`#income_${newIndex}`);
            const monthlyInputs = newBlock.querySelectorAll('.monthly-income-container input[type="text"]');
            const whtInput = newBlock.querySelector(`#wht_${newIndex}`);
            const typeSelect = newBlock.querySelector(`#type_${newIndex}`);
            const frequencySelect = newBlock.querySelector(`#freq_${newIndex}`);

            if (grossIncomeInput) {
                grossIncomeInput.addEventListener('input', () => updateFormattedValue(grossIncomeInput));
            }
            if (whtInput) {
                whtInput.addEventListener('input', () => updateFormattedValue(whtInput));
            }
            
            monthlyInputs.forEach(input => {
                input.addEventListener('input', () => updateFormattedValue(input));
                input.addEventListener('input', () => updateMonthlyTotal(input));
                input.addEventListener('input', () => markManualEdit(input));
            });

            typeSelect.addEventListener('change', () => handleIncomeTypeChange(typeSelect));
            frequencySelect.addEventListener('change', () => toggleMonthlyInputs(frequencySelect));
            
            const grossTooltip = newBlock.querySelector('.gross-income-container .tooltip .tooltiptext');
            if (grossIncomeInput) {
                grossIncomeInput.addEventListener('focus', () => showTooltip(grossTooltip, "Total income earned in the year before taxes and deductions."));
                grossIncomeInput.addEventListener('blur', () => hideTooltip(grossTooltip));
            }

            const whtTooltip = newBlock.querySelector('.wht-row .tooltip .tooltiptext');
            if (whtInput) {
                whtInput.addEventListener('focus', () => showTooltip(whtTooltip)); 
                whtInput.addEventListener('blur', () => hideTooltip(whtTooltip));
            }

            newBlock.querySelector('.remove-btn').addEventListener('click', (e) => {
                e.preventDefault();
                removeIncomeSource(e.currentTarget);
            });

            const allBlocks = document.querySelectorAll('.income-source-block');
            allBlocks.forEach(b => {
                b.querySelector('.remove-btn').style.display = allBlocks.length > 1 ? 'flex' : 'none';
            });

            toggleWhtField(typeSelect);
            toggleMonthlyInputs(frequencySelect);
        }

        function removeIncomeSource(button) {
            const blockToRemove = button.closest('.income-source-block');
            blockToRemove.remove();

            const container = document.getElementById('income-sources-container');
            const remainingBlocks = container.querySelectorAll('.income-source-block');
            
            remainingBlocks.forEach((block, index) => {
                block.setAttribute('data-source-id', index);
                block.querySelector('.income-index').textContent = index + 1;
                
                const oldIndexRegex = /_\d+/;
                
                block.querySelectorAll('[id*="_"], [for*="_"]').forEach(el => {
                    const attrName = el.hasAttribute('id') ? 'id' : 'for';
                    let value = el.getAttribute(attrName);
                    
                    const match = value.match(oldIndexRegex);
                    if (match) {
                        value = value.replace(match[0], `_${index}`);
                        el.setAttribute(attrName, value);
                    }
                });
                const typeSelect = block.querySelector('.income-type');
                if (typeSelect) handleIncomeTypeChange(typeSelect);

            });

            if (remainingBlocks.length === 1) {
                remainingBlocks[0].querySelector('.remove-btn').style.display = 'none';
            }
        }

        function validateForm() {
            const outputDiv = document.getElementById('output');
            const msgDiv = document.getElementById('msg');
            const taxSummary = document.getElementById('taxSummary');
            const defaultMessage = document.getElementById('default-report-message');
            msgDiv.textContent = '';
            taxSummary.innerHTML = ''; // Clear previous summary
            defaultMessage.style.display = 'none'; // Hide placeholder during validation
            outputDiv.style.display = 'none'; // Hide output by default

            const incomeBlocks = document.querySelectorAll('.income-source-block');
            if (incomeBlocks.length === 0) {
                msgDiv.textContent = 'Please add at least one income source.';
                outputDiv.style.display = 'block';
                return false;
            }

            let validationPassed = true;
            let totalGrossIncomeCheck = 0;

            for (const block of incomeBlocks) {
                const frequency = block.querySelector('.income-frequency').value;
                const blockIndex = block.getAttribute('data-source-id');
                let incomeInputs = [];

                if (frequency === 'monthly') {
                    incomeInputs = block.querySelectorAll('.monthly-income-container input[type="text"]');
                } else {
                    incomeInputs = [block.querySelector(`#income_${blockIndex}`)];
                }
                
                incomeInputs.forEach(input => {
                    const rawValue = getRawValue(input);
                    if (rawValue < 0) {
                        msgDiv.textContent = 'Income amounts cannot be negative. Please check your inputs.';
                        validationPassed = false;
                    }
                    totalGrossIncomeCheck += rawValue;
                });
                
                const whtRow = block.querySelector('.wht-row');
                if (whtRow && whtRow.style.display !== 'none') {
                    const whtInput = block.querySelector(`#wht_${blockIndex}`);
                    const whtValue = getRawValue(whtInput);
                    if (whtValue < 0) {
                        msgDiv.textContent = 'WHT paid cannot be negative. Please correct the amount.';
                        validationPassed = false;
                    }
                }
            }

            const pension = getRawValue(document.getElementById('pension'));
            const rent = getRawValue(document.getElementById('rent'));
            
            if (pension < 0 || rent < 0) {
                msgDiv.textContent = 'Deduction amounts (Pension/Rent) cannot be negative.';
                validationPassed = false;
            }
            
            if (totalGrossIncomeCheck <= 0) {
                msgDiv.textContent = 'Total annual income must be greater than zero to calculate.';
                validationPassed = false;
            }
            
                        if (!validationPassed) {
    document.getElementById('msg').textContent = 'üëÜ Please fill the above';
    document.getElementById('taxSummary').innerHTML = '';
    document.getElementById('default-report-message').style.display = 'block';
    document.getElementById('output').style.display = 'block';

    // ‚Üê ADD THIS LINE
    document.querySelector('#report').scrollIntoView({ behavior: 'smooth' });

    return false;
}
            
            return true;
        }

        const statePortals = {
    'FCT Abuja': { name: 'FCT Internal Revenue Service', url: 'https://fcttaxportal.fctirs.gov.ng/selfservice', filingTips: 'Login to file PIT returns online. Deadline: March 31.' },
    'Abia': { name: 'Abia State Internal Revenue Service', url: 'https://abia.tax/', filingTips: 'Use portal for e-filing and payments. Deadline: March 31.' },
    'Adamawa': { name: 'Adamawa State Internal Revenue Service', url: 'https://adirs.net/', filingTips: 'File annual returns online. Deadline: March 31.' },
    'Akwa Ibom': { name: 'Akwa Ibom State Internal Revenue Service', url: 'https://akirs.up-ng.com/', filingTips: 'PAYE, direct assessment, and payments portal. Deadline: March 31.' },
    'Anambra': { name: 'Anambra State Internal Revenue Service', url: 'https://airs.an.gov.ng/', filingTips: 'Online filing and payments available. Deadline: March 31.' },
    'Bauchi': { name: 'Bauchi State Internal Revenue Service', url: 'https://birs.bu.gov.ng/', filingTips: 'Self-service portal for payments and returns.' },
    'Bayelsa': { name: 'Bayelsa State Board of Internal Revenue', url: 'https://www.bir.by.gov.ng/', filingTips: 'Use eTax portal for assessments and payments. Deadline: March 31.' },
    'Benue': { name: 'Benue State Internal Revenue Service', url: 'https://birs.be.gov.ng/', filingTips: 'Portal for taxpayer services.' },
    'Borno': { name: 'Borno State Internal Revenue Service', url: 'https://birs.bo.gov.ng/', filingTips: 'Generate slips and pay online. Deadline: March 31.' },
    'Cross River': { name: 'Cross River Internal Revenue Service', url: 'https://www.crirs.ng/', filingTips: 'Join online community for tax payments.' },
    'Delta': { name: 'Delta State Internal Revenue Service', url: 'https://deltairs.com/', filingTips: 'Pay bills/assessments online. Deadline: March 31.' },
    'Ebonyi': { name: 'Ebonyi State Internal Revenue Service', url: 'https://www.irs.ebsgov.org/', filingTips: 'Pay taxes and verify receipts online. Deadline: March 31.' },
    'Edo': { name: 'Edo State Internal Revenue Service', url: 'https://eirs.gov.ng/', filingTips: 'Online payment and registration.' },
    'Ekiti': { name: 'Ekiti State Internal Revenue Service', url: 'https://www.ekitistaterevenue.com/', filingTips: 'Pay taxes and task your government. Deadline: March 31.' },
    'Enugu': { name: 'Enugu State Internal Revenue Service', url: 'https://irs.en.gov.ng/', filingTips: 'Log in for payments and returns. Deadline: March 31.' },
    'Gombe': { name: 'Gombe State Internal Revenue Service', url: 'https://irs.gm.gov.ng/', filingTips: 'Tax management portal. Deadline: March 31.' },
    'Imo': { name: 'Imo State Internal Revenue Service', url: 'https://iirs.im.gov.ng/', filingTips: 'Verify documents and pay online. Deadline: March 31.' },
    'Jigawa': { name: 'Jigawa State Internal Revenue Service', url: 'https://jsirs.org.ng/', filingTips: 'Direct assessment and payments. Deadline: March 31.' },
    'Kaduna': { name: 'Kaduna State Internal Revenue Service', url: 'https://kadirs.kdsg.gov.ng/', filingTips: 'Efficient revenue generation portal. Deadline: March 31.' },
    'Kano': { name: 'Kano State Internal Revenue Service', url: 'https://kirs.gov.ng/', filingTips: 'Secure online payments.' },
    'Katsina': { name: 'Katsina State Internal Revenue Service', url: 'https://irs.kt.gov.ng/', filingTips: 'Tax assessment and collection portal.' },
    'Kebbi': { name: 'Kebbi State Internal Revenue Service', url: 'https://irs.kb.gov.ng/etax/', filingTips: 'Harmonized e-tax portal. Deadline: March 31.' },
    'Kogi': { name: 'Kogi State Internal Revenue Service', url: 'https://irs.kg.gov.ng/', filingTips: 'Pay taxes and services online. Deadline: March 31.' },
    'Kwara': { name: 'Kwara State Internal Revenue Service', url: 'https://web.kwirs.site/home/', filingTips: 'Self-service portal for filings. Deadline: March 31.' },
    'Lagos': { name: 'Lagos State Internal Revenue Service', url: 'https://etax.lirs.net/', filingTips: 'File returns instantly online.' },
    'Nasarawa': { name: 'Nasarawa State Internal Revenue Service', url: 'https://www.irs.na.gov.ng/', filingTips: 'Secure tax payments.' },
    'Niger': { name: 'Niger State Internal Revenue Service', url: 'https://www.ngsirs.gov.ng/', filingTips: 'Pay taxes online. Deadline: March 31.' },
    'Ogun': { name: 'Ogun State Internal Revenue Service', url: 'https://portal.ogetax.ogunstate.gov.ng/', filingTips: 'Easy tax payments.' },
    'Ondo': { name: 'Ondo State Internal Revenue Service', url: 'https://www.odirs.ng/', filingTips: 'Verify receipts, obtain TIN.' },
    'Osun': { name: 'Osun State Internal Revenue Service', url: 'https://irs.os.gov.ng/', filingTips: 'Online payments and verifications. Deadline: March 31.' },
    'Oyo': { name: 'Oyo State Internal Revenue Service', url: 'https://oyostaterevenue.com/', filingTips: 'Self-service portal. Deadline: March 31.' },
    'Plateau': { name: 'Plateau State Internal Revenue Service', url: 'https://www.psirs.gov.ng/', filingTips: 'Pay your tax to develop Plateau. Deadline: March 31.' },
    'Rivers': { name: 'Rivers State Internal Revenue Service', url: 'https://rivtamis.riversbirs.gov.ng/', filingTips: 'RIVTAMIS tax management system. Deadline: March 31.' },
    'Sokoto': { name: 'Sokoto State Internal Revenue Service', url: 'https://itas.irs.sk.gov.ng/', filingTips: 'Pay taxes and file returns online. Deadline: March 31.' },
    'Taraba': { name: 'Taraba State Internal Revenue Service', url: 'https://www.tarababir.gov.ng/', filingTips: 'Pay taxes and services. Deadline: March 31.' },
    'Yobe': { name: 'Yobe State Internal Revenue Service', url: 'https://www.irs.yb.gov.ng/', filingTips: 'Verify certificates online. Deadline: March 31.' },
    'Zamfara': { name: 'Zamfara State Internal Revenue Service', url: 'https://irs.zm.gov.ng/', filingTips: 'Registration and payments portal. Deadline: March 31.' }
};

// Note: Verify/update with real URLs. Fallback if not in map: general advice.

function calculateTax() {
    const state = document.getElementById('state').value;

    // 1. FIRST check if income is missing ‚Üí show the generic red message
    if (!validateForm()) {
        // validateForm() already sets the correct red message + shows placeholder
        return;
    }

    // 2. NOW check state ‚Üí only if income is valid
    if (!state) {
        document.getElementById('msg').innerHTML = 'üëÜ Please select your State of Residence to proceed with the tax calculation.';
        document.getElementById('taxSummary').innerHTML = '';
        document.getElementById('default-report-message').style.display = 'block';
        document.getElementById('output').style.display = 'block';
        document.getElementById('state').scrollIntoView({ behavior: 'smooth' });
        return;
    }

    let totalGross = 0;
    let totalWhtCredit = 0;
    let incomeSources = [];

    // === Collect all income with details ===
    document.querySelectorAll('.income-source-block').forEach(block => {
        const index = block.getAttribute('data-source-id');
        const type = document.getElementById(`type_${index}`).value;
        const freq = document.getElementById(`freq_${index}`).value;
        let income = 0;
        let monthlyBreakdown = [];  // If monthly, store per month

        if (freq === 'monthly') {
            block.querySelectorAll('.monthly-income-row input').forEach(inp => {
                const monthValue = getRawValue(inp);
                income += monthValue;
                monthlyBreakdown.push({ month: inp.dataset.month, amount: monthValue });
            });
        } else {
            income = getRawValue(document.getElementById(`income_${index}`));
        }

        const whtInput = document.getElementById(`wht_${index}`);
let wht = getRawValue(whtInput);  // Always start with user input (0 if blank)

// Auto-apply 10% ONLY for Rental & Investment if user left blank
if (wht === 0 && (type === 'rental' || type === 'investment')) {
    wht = income * 0.10;  // Standard deduction at source
}

// For "Other": If blank, stays 0. No auto. (User enters actual if any)
if (type === 'other' && wht === 0) {
    wht = 0;  // Explicit: No default‚Äîperfect for students/gifts
}

totalWhtCredit += wht;

        incomeSources.push({
            type: type.charAt(0).toUpperCase() + type.slice(1),  // e.g., "Salary"
            frequency: freq,
            annualIncome: income,
            whtCredit: wht,
            monthlyBreakdown: freq === 'monthly' ? monthlyBreakdown : null
        });

        totalGross += income;
    });

    // === Deductions with details ===
    const pension = getRawValue(document.getElementById('pension') || {value: ''});
    const nhf = getRawValue(document.getElementById('nhf') || {value: ''});
    const nhis = getRawValue(document.getElementById('nhis') || {value: ''});
    const life = getRawValue(document.getElementById('lifeinsurance') || {value: ''});
    const mortgage = getRawValue(document.getElementById('mortgage') || {value: ''});
    const rentPaid = getRawValue(document.getElementById('rent') || {value: ''});
    const rentRelief = Math.min(500000, rentPaid * 0.2);

    const deductions = {  // NEW: Object for deductions
        pension: pension,
        nhf: nhf,
        nhis: nhis,
        lifeInsurance: life,
        mortgage: mortgage,
        rentRelief: rentRelief
    };
    const totalDeductions = pension + nhf + nhis + life + mortgage + rentRelief;
    const taxableIncome = Math.max(0, totalGross - totalDeductions);
    const chargeableIncome = Math.max(0, taxableIncome - 800000); // First 800k exempt


    // === Tax bands with details ===
    let tax = 0;
    let remaining = chargeableIncome;
    let bandDetails = [];  // NEW: Per-band breakdown
    const bands = [
    { limit: 2200000, rate: 0.15, desc: 'First NGN 2,200,000 @ 15%' },
    { limit: 9000000, rate: 0.18, desc: 'Next NGN 9,000,000 @ 18%' },
    { limit: 13000000, rate: 0.21, desc: 'Next NGN 13,000,000 @ 21%' },
    { limit: 25000000, rate: 0.23, desc: 'Next NGN 25,000,000 @ 23%' },
    { limit: Infinity, rate: 0.25, desc: 'Above NGN 49,200,000 @ 25%' }
];

    bands.forEach(band => {
        if (remaining > 0) {
            let taxableInBand = Math.min(remaining, band.limit);
            let taxInBand = taxableInBand * band.rate;
            tax += taxInBand;
            bandDetails.push({
                desc: band.desc,
                taxable: taxableInBand,
                rate: band.rate * 100 + '%',
                tax: taxInBand
            });
            remaining -= taxableInBand;
        }
    });

    const finalTax = Math.max(0, tax - totalWhtCredit);
    const effectiveRate = totalGross > 0 ? ((finalTax / totalGross) * 100).toFixed(1) : '0.0';
    const monthlyTax = finalTax / 12;

    // === Display ===
    document.getElementById('taxSummary').innerHTML = `
    <table style="width:100%; border-collapse: collapse;">
        <tr><th colspan="2">2026 Personal Income Tax (New Law)</th></tr>
        <tr><td>Gross Annual Income</td><td>‚Ç¶${totalGross.toLocaleString('en-NG')}</td></tr>
        <tr><td>Total Deductions</td><td>‚Ç¶${totalDeductions.toLocaleString('en-NG')}</td></tr>
        <tr><td>Taxable Income</td><td>‚Ç¶${taxableIncome.toLocaleString('en-NG')}</td></tr>
        <tr><td>Chargeable Income (after NGN 800k exemption)</td><td>‚Ç¶${chargeableIncome.toLocaleString('en-NG')}</td></tr>
        <tr><td>Tax Before WHT Credit</td><td>‚Ç¶${tax.toLocaleString('en-NG')}</td></tr>
        ${totalWhtCredit > 0 ? `<tr><td>WHT Credit</td><td>‚Ç¶${totalWhtCredit.toLocaleString('en-NG')}</td></tr>` : ''}
        <tr><td><strong>Final Tax Payable</strong></td><td><strong>‚Ç¶${Math.round(finalTax).toLocaleString('en-NG')}</strong></td></tr>
<tr><td><strong>Effective Tax Rate</strong></td><td><strong style="color:#28A745; font-size:1.1em;">${effectiveRate}%</strong><br><small>of your total income</small></td></tr>
<tr><td>Monthly PAYE (approx)</td><td>‚Ç¶${Math.round(monthlyTax).toLocaleString('en-NG')}</td></tr>
        <tr><td colspan="2"><em>Valid for income earned from January 2026</em></td></tr>
    </table>
`;

    document.getElementById('msg').textContent = 'Calculation complete (2026 rules applied)';
    document.getElementById('output').style.display = 'block';
    document.querySelector('#report').scrollIntoView({behavior: 'smooth'});
        document.getElementById('default-report-message').style.display = 'none';  // ‚Üê ADD THIS
    window.lastCalc = {
        state,
        incomeSources,
        deductions,
        totalGross,
        totalDeductions,
        taxableIncome,
        chargeableIncome,
        bandDetails,
        taxBeforeWht: tax,
        totalWhtCredit,
        finalTax: Math.round(finalTax),
        monthlyTax: Math.round(monthlyTax)
    };
}

async function generatePDFReport() {
    if (!window.lastCalc) {
        alert('Please calculate tax first!');
        return null;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FINAL BULLETPROOF PIE SLICE (2025) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
doc.pieSlice = function(cx, cy, r, startAngleDeg, endAngleDeg, style = 'F') {
    try {
        const degToRad = deg => deg * Math.PI / 180;

        const x1 = cx + r * Math.cos(degToRad(startAngleDeg));
        const y1 = cy + r * Math.sin(degToRad(startAngleDeg));
        const x2 = cx + r * Math.cos(degToRad(endAngleDeg));
        const y2 = cy + r * Math.sin(degToRad(endAngleDeg));

        // Start drawing
        this.moveTo(cx, cy);
        this.lineTo(x1, y1);
        this.arc(cx, cy, r, startAngleDeg, endAngleDeg);  // jsPDF arc uses DEGREES
        this.lineTo(cx, cy);
        this.close();

        if (style.includes('F')) this.fill();
        if (style.includes('S')) this.stroke();
    } catch (e) {
        console.warn('Pie slice failed (fallback to circle)', e);
        // Fallback: draw a full circle so PDF never dies
        this.setFillColor(34, 139, 34);
        this.circle(cx, cy, r, 'F');
    }
};
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 18;
    let y = 20;

    const data = window.lastCalc;
    const green = [34, 139, 34];  // Forest Green
    const lightGreen = [240, 255, 240];
    const gray = [100, 100, 100];

    const money = (amt) => {
    if (!amt) amt = 0;
    const num = Number(amt);
    if (isNaN(num)) return 'NGN 0';
    return 'NGN ' + num.toLocaleString('en-NG');
};

    // ADD LOGO (from your favicon folder)
    const logoPath = './favicon-32x32.png'; // You have this already
    try {
        doc.addImage(logoPath, 'PNG', margin, 10, 12, 12);
    } catch (e) {
        console.log("Logo not found, using text fallback");
    }

    // HEADER ON EVERY PAGE
    const addHeader = (title) => {
        doc.setFillColor(...green);
        doc.rect(0, 0, pageWidth, 35, 'F');
        try { doc.addImage(logoPath, 'PNG', margin, 8, 14, 14); } catch(e) {}
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('TaxC - Helping Nigerians stay Tax Compliant', margin + 18, 16);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text(title, margin + 18, 26);
        doc.setDrawColor(...green);
        doc.setLineWidth(1);
        doc.line(margin, 35, pageWidth - margin, 35);
        y = 45;
    };

    const addFooter = (pageNum) => {
        doc.setFontSize(9);
        doc.setTextColor(...gray);
        doc.text(`Generated on ${new Date().toLocaleDateString('en-NG')} | taxc.com.ng`, margin, pageHeight - 10);
        doc.text(`Page ${pageNum}`, pageWidth - margin - 20, pageHeight - 10);
    };

        // PAGE 1 - COVER
    addHeader('Your Personalized 2025/2026 Tax Report');
    doc.setTextColor(0);
    doc.setFontSize(13);
    doc.setFont('helvetica', 'normal');
    doc.text('Hey there! This is your custom tax estimate based on what you entered.', margin, y); y += 8;
    doc.text('We crunched the numbers using the latest 2026 Nigerian Tax Act (NTA) rules.', margin, y); y += 12;

    doc.setFontSize(11);
    doc.setTextColor(...gray);
    doc.text('Remember: This is just an estimate! Consult a tax pro at taxc.com.ng for official filing.', margin, y); y += 12;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NEW MOTIVATIONAL + FEATURES TEXT (CLEAN ENGLISH) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.setFont('helvetica', 'normal');
    doc.text('Staying on top of your taxes helps build Nigeria.', margin, y); y += 7;
    doc.text('Your contributions power better roads, schools, and hospitals, for a stronger nation we all benefit from!', margin, y); y += 7;

    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    const featureText = 'Dive in to explore your tax summary explained in clear detail, discover all your income sources with engaging visuals that bring everything to life, follow our step-by-step guide on how the calculations were done (we handled the math to make it effortless!), uncover exactly what you owe, get ahead with a practical monthly breakdown, factor in any WHT you\'ve already paid, and some deductions you can use to legelly minimize your tax, access a direct link to settle with your state IRS, and receive straightforward advice on how and when to file without any hassle.';

    const splitFeature = doc.splitTextToSize(featureText, pageWidth - margin * 2);
    doc.text(splitFeature, margin, y);
    y += splitFeature.length * 5.5 + 8; // line height + extra spacing

    // Back to original closing content
    doc.setTextColor(0);
    doc.setFontSize(12);
    doc.text(`State: ${data.state}`, margin, y); y += 8;
    const effectiveRate = data.finalTax && data.totalGross ? 
        ((data.finalTax / data.totalGross) * 100).toFixed(1) : '0';
    doc.text(`Effective Tax Rate: ${effectiveRate}% (of gross income)`, margin, y);

    addFooter(1);
    doc.addPage();

        // PAGE 2 - TAX SUMMARY
    addHeader('Your Tax Summary Explained Clearly');
    doc.setTextColor(0);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text('Here‚Äôs a quick overview of your calculated Personal Income Tax (PIT).', margin, y); y += 8;
    doc.text(`How much you really owe: ${money(data.finalTax)}`, margin, y); y += 15;

    const summary = [
        ['Gross Annual Income', money(data.totalGross)],
        ['Total Deductions', money(data.totalDeductions)],
        ['Taxable Income', money(data.taxableIncome)],
        ['Chargeable Income (after NGN 800k exemption)', money(data.chargeableIncome)],
        ['Tax Before WHT Credit', money(data.taxBeforeWht)],
        ['WHT Credit (Tax Already Paid)', money(data.totalWhtCredit)],
        ['Final Tax You Really Owe', money(data.finalTax)],
        ['Effective Tax Rate', `${effectiveRate}%`],
        ['Monthly PAYE (Approx - Plan Ahead!)', money(data.monthlyTax)]
    ];

    doc.autoTable({
        startY: y,
        head: [['Item', 'Amount']],
        body: summary,
        theme: 'grid',
        headStyles: { fillColor: green, textColor: [255,255,255], fontSize: 11, fontStyle: 'bold' },
        bodyStyles: { fontSize: 11, cellPadding: 6 },
        alternateRowStyles: { fillColor: lightGreen },
        columnStyles: { 
            1: { halign: 'right', fontStyle: 'bold', textColor: green } 
        },
        didParseCell: (d) => {
            if (d.row.raw[0] === 'Final Tax You Really Owe') {
                d.cell.styles.fillColor = green;
                d.cell.styles.textColor = [255, 255, 255];
                d.cell.styles.fontSize = 13;
                d.cell.styles.fontStyle = 'bold';
            }
        }
    });

    y = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(10);
    doc.setTextColor(...gray);
    doc.text('Valid for income from Jan 2026. If your details change, recalculate on taxc.com.ng.', margin, y);

    addFooter(2);
    doc.addPage();

    // PAGE 3 - INCOME SOURCES
addHeader('All Your Income Sources Listed');
doc.setTextColor(0);
doc.setFontSize(11);
doc.setFont('helvetica', 'normal'); // Explicitly set normal font
doc.text(`Here‚Äôs a breakdown of everything you entered. Total: ${money(data.totalGross)}.`, margin, y); y += 8;
doc.text(`Any tax already paid (WHT): ${money(data.totalWhtCredit)}.`, margin, y); y += 12;

doc.autoTable({
    startY: y,
    head: [['Type', 'Annual Amount', 'Frequency', 'WHT Credit']],
    body: data.incomeSources.map(s => [s.type, money(s.annualIncome), s.frequency === 'monthly' ? 'Monthly' : 'Annual', money(s.whtCredit)]),
    theme: 'grid',
    headStyles: { fillColor: green, textColor: [255,255,255] },
    columnStyles: { 1: { halign: 'right' }, 3: { halign: 'right' } },
    margin: { left: margin, right: margin }
});

// Calculate where the pie chart should start after the autoTable
y = doc.lastAutoTable.finalY;

// === ADD PIE CHART - INCOME SOURCES BREAKDOWN ===
// We only draw the chart if there is one or more source with income > 0
if (data.incomeSources.length > 1 || (data.incomeSources.length === 1 && data.incomeSources[0].annualIncome > 0)) {
    
    y += 15; // Space below the table
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0);
    doc.text('Income Sources Breakdown', margin, y);
    y += 8;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(...gray);
    doc.text('Visual representation of where your income comes from', margin, y);
    y += 10;

    // Prepare data for pie chart
    const pieData = data.incomeSources
        .filter(s => s.annualIncome > 0)
        .map(s => ({
            label: s.type,
            value: s.annualIncome,
            percent: ((s.annualIncome / data.totalGross) * 100).toFixed(1)
        }));

    // Colors for pie slices (beautiful & professional)
    const pieColors = [
        [34, 139, 34],     // Green
        [0, 128, 0],       // Darker green
        [50, 205, 50],     // Lime green
        [0, 100, 0],       // Deep green
        [144, 238, 144]    // Light green
    ];

    // Create a temporary canvas to draw the pie
    const canvas = document.createElement('canvas');
    const canvasSize = 600; // Increased for sharper quality
    canvas.width = canvasSize;
    canvas.height = canvasSize;
    const ctx = canvas.getContext('2d');

    // Center and radius for pie on canvas
    const centerX = canvasSize / 2;
    const centerY = canvasSize / 2;
    const radius = canvasSize / 2 - 10; // Padding

    let startAngle = 0;

    pieData.forEach((slice, i) => {
        const sliceAngle = (slice.value / data.totalGross) * 2 * Math.PI;
        const endAngle = startAngle + sliceAngle;

        // Skip tiny slices if needed
        if (sliceAngle < 0.01) { // ~0.5 degrees
            startAngle = endAngle;
            return;
        }

        // Draw slice
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = `rgb(${pieColors[i % pieColors.length].join(',')})`;
        ctx.fill();

        // White border
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 2;
        ctx.stroke();

                // Only show percentage label on the slice when there are MULTIPLE sources
        if (pieData.length > 1 && sliceAngle > Math.PI / 12) {
            const midAngle = startAngle + sliceAngle / 2;
            const labelX = centerX + (radius * 0.65) * Math.cos(midAngle);
            const labelY = centerY + (radius * 0.65) * Math.sin(midAngle);
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 18px Helvetica';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${slice.percent}%`, labelX, labelY);
        }

        startAngle = endAngle;
    });

    // For single slice (100%)
    if (pieData.length === 1) {
        ctx.fillStyle = '#FFFFFF';
        ctx.font = 'bold 24px Helvetica'; // Increased font for higher res
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${pieData[0].percent}%`, centerX, centerY);
    }

    // Add the canvas image to PDF (centered)
    const pdfChartWidthMm = 70; // Desired width in mm (adjust for PDF fit, e.g., ~2.75 inches)
    const scale = pdfChartWidthMm / (canvasSize / (72 / 25.4)); // Scale to fit while keeping high res
    const pdfCenterX = pageWidth / 2 - pdfChartWidthMm / 2;
    const pdfCenterY = y; // Current y
    doc.addImage(canvas.toDataURL('image/png'), 'PNG', pdfCenterX, pdfCenterY, pdfChartWidthMm, pdfChartWidthMm);

    // Update y after chart
    y = pdfCenterY + pdfChartWidthMm + 10;

    // === LEGEND (Below pie chart) ===
    doc.setFontSize(10);
    doc.setTextColor(0);
    pieData.forEach((slice, i) => {
        if (y > pageHeight - 40) {
            doc.addPage();
            y = 40;
            addHeader('All Your Income Sources Listed');
        }

        const color = pieColors[i % pieColors.length];
        doc.setFillColor(...color);
        doc.rect(margin, y - 5, 6, 6, 'F');

        doc.setTextColor(0);
        doc.setFont('helvetica', 'bold');
        doc.text(`${slice.label}: `, margin + 10, y);

        doc.setFont('helvetica', 'normal');
        doc.text(`${slice.percent}% (${money(slice.value)})`, margin + 45, y);

        y += 8;
    });

    y += 10; // Extra space after legend
}

addFooter(3);
doc.addPage();

        // PAGE 4 - DEDUCTIONS (Smart version: handles zero deductions beautifully)
    addHeader('Your Deductions: How You Can Save on Tax');

    doc.setTextColor(0);
    doc.setFontSize(13);
    doc.setFont('helvetica', 'bold');

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ZERO DEDUCTIONS CASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (data.totalDeductions == 0 || !data.totalDeductions) {
        doc.text('No deductions applied this year‚Ä¶', margin, y); y += 8;
        doc.text('But here‚Äôs how to Save Tax This Year, And How to Save WAY MORE Next Year!', margin, y);
        y += 15;
    }
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HAD DEDUCTIONS CASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else {
        doc.text('How You Saved Tax This Year, And How to Save WAY MORE Next Year!', margin, y);
        y += 10;

        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.text(`You already saved ${money(data.totalDeductions)} this year just because some money was removed before tax was calculated. Nice one!`, margin, y);
        y += 12;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ THE TIPS (same for everyone) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Here‚Äôs how to make next year even better (in plain English):', margin, y);
    y += 10;

    const tips = [
        '1. Put extra money inside your Pension (RSA):',
        '   The money you save for old age. Any extra money you add to this is like telling tax people ‚Äúdon‚Äôt touch this one‚Äù. The more you add, the less tax you pay. Simple!',

        '2. Join National Housing Fund (NHF):',
        '   Small money (2.5% of your salary) goes to government so that one day you can collect cheap loan to build or buy house. That small money is also removed before tax; double win!',

        '3. Pay for Life Insurance:',
        '   The money you pay every month or year so your family is safe if anything happens to you. Government says ‚Äúwe won‚Äôt tax that money‚Äù. Free tax break!',

        '4. Pay for Health Insurance',
        '   Money you pay so that hospital bills no go finish you. That money too is removed before tax. You stay healthy AND keep more money.',

        '5. If you pay house rent',
        '   In Lagos and some states, you can tell tax people ‚ÄúI pay rent o!‚Äù and they will remove small money from your tax. Ask your state tax office how.',

        '6. Give small money to real charity',
        '   If you dash approved charity or school, government fit remove that money from tax too.'
    ];

    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    tips.forEach(line => {
        const splitLine = doc.splitTextToSize(line, pageWidth - margin * 2);
        doc.text(splitLine, margin, y);
        y += splitLine.length * 5.8;
    });

    y += 8;

    addFooter(4);
    doc.addPage();

                // PAGE 5 - TAX BANDS + SUPER SIMPLE EXPLANATION (CLEAN, NO BACKGROUND BOX)
    addHeader('Step-by-Step: How Your Tax Was Calculated');

    doc.setTextColor(0);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text('We follow the official 2026 Nigerian Personal Income Tax rates. First NGN 800,000 is completely exempt,<br><br> then higher earnings are taxed at increasing rates (progressive tax).', margin, y);
    y += 15;

    // TAX BANDS TABLE (CORRECT 2026 BANDS)
    doc.autoTable({
        startY: y,
        head: [['Band Description', 'Taxable in Band', 'Rate', 'Tax Amount']],
        body: data.bandDetails.map(b => [b.desc, money(b.taxable), b.rate, money(b.tax)]),
        theme: 'grid',
        headStyles: { fillColor: green, textColor: [255,255,255] },
        columnStyles: { 1: { halign: 'right' }, 3: { halign: 'right' } },
        margin: { left: margin, right: margin }
    });

    y = doc.lastAutoTable.finalY + 18;

    // TOTAL TAX BEFORE CREDITS
    doc.setFontSize(13);
    doc.setFont('helvetica', 'bold');
    doc.text(`Total Tax Before Credits: ${money(data.taxBeforeWht)}`, margin, y);
    y += 25;

    // KID-FRIENDLY EXPLANATION ‚Äì CLEAN & BOX-FREE
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...green);
    doc.text('How Nigeria Taxes Your Money; Explained Like You‚Äôre 10 Years Old', margin, y);
    y += 12;

    doc.setFontSize(10.5);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0);

    const explanation = [
    'Imagine your yearly income is one huge bowl of jollof rice.',
    'The government says: "We will only take a little from the top, and the higher the bowl gets, the bigger the spoon we use."',
    'Here\'s exactly how it works in 2026:',
    '',
    '1. First NGN 800,000 -> Completely FREE!',
    '   Government says: "This part is yours forever. No tax at all."',
    '',
    '2. Next NGN 2,200,000 (NGN 800,001 - NGN 3,000,000) -> 15%',
    '   For every NGN 100 here, they take NGN 15.',
    '',
    '3. Next NGN 9,000,000 (NGN 3,000,001 - NGN 12,000,000) -> 18%',
    '   Now they take NGN 18 out of every NGN 100.',
    '',
    '4. Next NGN 13,000,000 (NGN 12,000,001 - NGN 25,000,000) -> 21%',
    '   NGN 21 from every NGN 100.',
    '',
    '5. Next NGN 25,000,000 (NGN 25,000,001 - NGN 50,000,000) -> 23%',
    '   NGN 23 out of every NGN 100.',
    '',
    '6. Everything above NGN 50,000,000 -> 25%',
    '   The biggest spoon - NGN 25 from every NGN 100.',
    '',
    'This system is called "progressive" because:',
    '‚Ä¢ Low earners pay little (or nothing at all)',
    '‚Ä¢ High earners pay more - but only on the money above each band',
    'That\'s the simple magic behind the table above'
];

    explanation.forEach(line => {
        if (line === '') { y += 5; return; }
        const split = doc.splitTextToSize(line, pageWidth - margin * 2);
        doc.text(split, margin, y);
        y += split.length * 5.6;
    });

    y += 10;

    addFooter(5);
    doc.addPage();

    // PAGE 6 ‚Äì FINAL VERSION: WORKS FOR ALL 36 STATES + FCT
addHeader('What to Do Next: How & When to File Your Tax');

doc.setTextColor(0);
doc.setFont('helvetica', 'bold');
doc.setFontSize(15);
doc.text('What to Do Next, Let‚Äôs Finish Strong!', margin, y);
y += 10;

doc.setFont('helvetica', 'normal');
doc.setFontSize(11.5);
doc.text('You‚Äôve seen everything: how much you owe, how it was calculated,', margin, y); y += 6;
doc.text('and how to pay less next year. Now just two simple things remain:', margin, y); y += 12;

doc.setFont('helvetica', 'bold');
doc.setFontSize(12);
doc.text('1. File your annual tax return', margin, y); y += 8;

doc.setFont('helvetica', 'normal');
doc.setFontSize(11);
doc.text('‚Ä¢ Salaried? Your office deducts PAYE monthly, but you still need to file by 31 March 2027.', margin + 5, y); y += 6;
doc.text('‚Ä¢ Self-employed / side hustle? File and pay the balance on or before 31 March 2027.', margin + 5, y); y += 10;

doc.setFont('helvetica', 'bold');
doc.text('Miss the deadline = 10% penalty + interest every month. No story.', margin, y); y += 12;

doc.setFontSize(12);
doc.text('2. Click the link below right now and settle am in 5 minutes', margin, y); y += 10;

// DYNAMIC STATE NAME & IRS LINK (works for all states)
const stateName = data.state || 'your state';
const stateIRS = {
    'Abia': 'https://irs.ab.gov.ng',
    'Adamawa': 'https://irs.ad.gov.ng',
    'Akwa Ibom': 'https://irs.ak.gov.ng',
    'Anambra': 'https://irs.an.gov.ng',
    'Bauchi': 'https://irs.ba.gov.ng',
    'Bayelsa': 'https://irs.by.gov.ng',
    'Benue': 'https://irs.be.gov.ng',
    'Borno': 'https://irs.bo.gov.ng',
    'Cross River': 'https://irs.cr.gov.ng',
    'Delta': 'https://irs.dt.gov.ng',
    'Ebonyi': 'https://irs.eb.gov.ng',
    'Edo': 'https://irs.ed.gov.ng',
    'Ekiti': 'https://irs.ek.gov.ng',
    'Enugu': 'https://irs.en.gov.ng',
    'Gombe': 'https://irs.go.gov.ng',
    'Imo': 'https://irs.im.gov.ng',
    'Jigawa': 'https://irs.ji.gov.ng',
    'Kaduna': 'https://irs.kd.gov.ng',
    'Kano': 'https://kirs.kn.gov.ng',
    'Katsina': 'https://irs.kt.gov.ng',
    'Kebbi': 'https://irs.ke.gov.ng',
    'Kogi': 'https://irs.kg.gov.ng',
    'Kwara': 'https://kirs.kw.gov.ng',
    'Lagos': 'https://lirs.lg.gov.ng',
    'Nasarawa': 'https://irs.ns.gov.ng',
    'Niger': 'https://irs.ng.gov.ng',
    'Ogun': 'https://irs.og.gov.ng',
    'Ondo': 'https://irs.od.gov.ng',
    'Osun': 'https://irs.os.gov.ng',
    'Oyo': 'https://irs.oy.gov.ng',
    'Plateau': 'https://irs.pl.gov.ng',
    'Rivers': 'https://irs.rv.gov.ng',
    'Sokoto': 'https://irs.so.gov.ng',
    'Taraba': 'https://irs.tr.gov.ng',
    'Yobe': 'https://irs.yo.gov.ng',
    'Zamfara': 'https://irs.zm.gov.ng',
    'FCT': 'https://firs.gov.ng'
}[stateName] || 'https://firs.gov.ng';  // fallback to FIRS

doc.setFont('helvetica', 'normal');
doc.setFontSize(11.5);
doc.text(`${stateName} people, this one na direct link:`, margin, y); y += 10;

doc.setFontSize(15);
doc.setTextColor(0, 102, 204);
doc.setFont('helvetica', 'bold');
doc.textWithLink(stateIRS, margin, y, { url: stateIRS });
doc.setDrawColor(0, 102, 204);
doc.setLineWidth(0.5);
doc.line(margin, y + 2, margin + doc.getTextWidth(stateIRS), y + 2);
y += 20;

doc.setTextColor(0);
doc.setFont('helvetica', 'bold');
doc.setFontSize(12);
doc.text('Quick reminder, don‚Äôt make these 3 classic mistakes:', margin, y); y += 9;

doc.setFont('helvetica', 'normal');
doc.setFontSize(11);
doc.text('‚Ä¢ Forget to claim WHT you‚Äôve already paid (free money left on table!)', margin, y); y += 6;
doc.text('‚Ä¢ Miss the March 31 deadline (penalty no dey smile)', margin, y); y += 6;
doc.text('‚Ä¢ Hide small income (if dem catch you, the fine no get mercy)', margin, y); y += 14;

doc.setFont('helvetica', 'normal');
doc.setFontSize(12);
doc.text('Do it today, sleep like baby tonight.', margin, y); y += 12;

doc.setFontSize(11.5);
doc.text('Thank you for doing the right thing.', margin, y); y += 7;
doc.text('Your small tax today = better roads, schools, and hospitals tomorrow.', margin, y); y += 12;

doc.setFont('helvetica', 'bold');
doc.setFontSize(13);
doc.setTextColor(...green);
doc.text('Na we we. Together we build Nigeria!', margin, y); y += 12;

doc.setFont('helvetica', 'normal');
doc.setTextColor(0);
doc.setFontSize(11);
doc.text('Team TaxC (with plenty love and cactus)', margin, y);

addFooter(6);

// SAVE

const pdfBlob = doc.output('blob');           // This creates the file in memory
    lastGeneratedPdfBlob = pdfBlob;               // Store it globally
    return pdfBlob;                               // Return it so the caller can download immediately
}

    function resetForm() {
    const outputDiv = document.getElementById('output');
    const msgDiv = document.getElementById('msg');
    const taxSummary = document.getElementById('taxSummary');
    const defaultMessage = document.getElementById('default-report-message');
    const stateSelect = document.getElementById('state');
    const pdfButton = document.querySelector('.report-btn');

    // Clear deduction fields
    document.getElementById('pension').value = '';
    document.getElementById('rent').value = '';

    // Clear state
    if (stateSelect) stateSelect.value = '';

    // Remove ALL income blocks
    document.querySelectorAll('.income-source-block').forEach(block => block.remove());

    // Add back exactly ONE clean income source
    addIncomeSource();

    // Reset output area
    outputDiv.style.display = 'block';
    msgDiv.textContent = 'Please fill the above';
    taxSummary.innerHTML = '';
    defaultMessage.style.display = 'block';

    // Clear any stored calculation
    window.lastCalc = null;

    // Reset PDF button to original state
    if (pdfButton) {
        pdfButton.textContent = "Pay ‚Ç¶900 & Download PDF";
        pdfButton.onclick = payWithPaystack;
        pdfButton.disabled = false;
    }

    // Scroll back to calculator
    document.getElementById('calculator').scrollIntoView({ behavior: 'smooth' });
}

document.addEventListener('DOMContentLoaded', () => {
    // 1. Add first income source
    addIncomeSource();

    // 2. Nav links (smooth scroll)
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', scrollToSection);
    });

    // 3. Format pension & rent
    ['pension', 'rent'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => updateFormattedValue(el));
    });

    // 4. SHOW TAX SUMMARY + PLACEHOLDER ON LOAD
    const output = document.getElementById('output');
    const msg = document.getElementById('msg');
    const defaultMsg = document.getElementById('default-report-message');

    output.style.display = 'block';
    msg.textContent = 'Please fill the above';
    defaultMsg.style.display = 'block';

    // 5. === DROPDOWN LOGIC (MERGED CLICK & HOVER) ===
    
    // Helper function to open a dropdown
    function openDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        
        // Close all other dropdowns
        document.querySelectorAll('.dropdown[open]').forEach(d => {
            if (d.id !== dropdownId) d.removeAttribute('open');
        });
        dropdown.setAttribute('open', '');
    }

    // Helper function to close a dropdown
    function closeDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) dropdown.removeAttribute('open');
    }

    // --- A. Click-to-Toggle Logic (Original) ---
    function toggleDropdown(event, dropdownId) {
        event.stopPropagation();
        const dropdown = document.getElementById(dropdownId);
        const isOpen = dropdown.hasAttribute('open');
        
        // Use helper functions to ensure closure logic is centralized
        if (isOpen) {
            closeDropdown(dropdownId);
        } else {
            openDropdown(dropdownId);
        }
    }

    // Attach click listener to dropdown buttons
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        const dropdownId = toggle.closest('.dropdown').id;
        // Keep the original click logic for touch/accessibility
        toggle.onclick = (e) => toggleDropdown(e, dropdownId);
    });

    // Close dropdown when clicking outside (Original)
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown[open]').forEach(d => {
                d.removeAttribute('open');
            });
        }
    });
    
    // --- B. Hover Logic (Added for Desktop) ---
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        const dropdownId = dropdown.id;
        
        // Attach mouseover to open only on desktop screens
        dropdown.addEventListener('mouseover', function(e) {
            if (window.innerWidth >= 768) { // Check for desktop screens (adjust breakpoint as needed)
                openDropdown(dropdownId);
            }
        });

        // Attach mouseout to close only on desktop screens
        dropdown.addEventListener('mouseout', function(e) {
            if (window.innerWidth >= 768) {
                 setTimeout(() => {
                     // Check if the mouse is truly outside the dropdown area
                     if (!dropdown.contains(e.relatedTarget)) {
                        closeDropdown(dropdownId);
                     }
                 }, 100); 
            }
        });
    });
    // === END DROPDOWN LOGIC ===
});
        // Toggle tooltip on click (click-away closes it)
document.addEventListener('click', function (e) {
    const container = e.target.closest('.clickable-tooltip');
    // close any open tooltips
    document.querySelectorAll('.clickable-tooltip.active').forEach(el => {
        if (el !== container) el.classList.remove('active');
    });
    // open the clicked one
    if (container) {
        container.classList.toggle('active');
    }
});
function scrollToWhyReport(event) {
    if (event) {
        event.stopPropagation(); // <-- ADD THIS LINE
    }
    // 1. Close any open mobile menu first
    const menu = document.getElementById('menu');
    const hamburger = document.getElementById('hamburger');
    if (menu.hasAttribute('open')) {
        menu.removeAttribute('open');
        hamburger.classList.remove('is-active');
    }

    // 2. Get dropdowns
    const desktopDropdown = document.getElementById('desktop-dropdown');
    const mobileDropdown = document.getElementById('mobile-dropdown');

    // 3. Open BOTH dropdowns
    if (desktopDropdown) desktopDropdown.setAttribute('open', '');
    if (mobileDropdown) mobileDropdown.setAttribute('open', '');

    // 4. Re-open mobile menu if on mobile
    if (window.innerWidth < 768 && menu && hamburger) {
        setTimeout(() => {
            menu.setAttribute('open', '');
            hamburger.classList.add('is-active');
        }, 100); // Tiny delay so it opens AFTER scroll
    }

    // 5. Scroll to the dropdown (desktop or mobile)
    const target = window.innerWidth >= 768 ? desktopDropdown : menu;
    if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

window.addEventListener('beforeunload', saveChat);

        </script>
        <script src="scripts/scroll-animation.js"></script>
  
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD59PBKVQ_ocfAxWHsMsG0a3SE143Yp5zo",
    authDomain: "taxc-ebooks.firebaseapp.com",
    projectId: "taxc-ebooks",
    storageBucket: "taxc-ebooks.firebasestorage.app",
    messagingSenderId: "542476707940",
    appId: "1:542476707940:web:591fd5d3d6fd51eff95771"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  onAuthStateChanged(auth, user => {
    const greeting     = document.getElementById('user-greeting');
    const userDisplay  = document.getElementById('userDisplay');
    const userPhoto    = document.getElementById('user-photo');
    const loginButtons = document.querySelectorAll('#auth-button, #auth-button-mobile');

    if (user && user.displayName) {
      // LOGGED IN ‚Üí show avatar + name, hide login buttons
      const firstName = user.displayName.split(' ')[0];
      userDisplay.textContent = `Hi, ${firstName}!`;
      userPhoto.src = user.photoURL || `https://ui-avatars.com/api/?name=${firstName}&background=28A745&color=fff&bold=true&size=64`;
      greeting.style.display = 'flex';
      loginButtons.forEach(btn => btn.classList.add('auth-btn-hidden'));
    } else {
      // NOT LOGGED IN ‚Üí hide greeting, show login buttons
      greeting.style.display = 'none';
      loginButtons.forEach(btn => {
        btn.classList.remove('auth-btn-hidden');
        btn.innerHTML = 'Login';
        btn.onclick = () => location.href = 'login.html?redirect=' + encodeURIComponent(location.href);
      });
    }
  });

  // Logout from the profile dropdown only
  document.getElementById('logout-link')?.addEventListener('click', e => {
    e.preventDefault();
    signOut(auth).then(() => location.reload());
  });
</script>
<script>
// FINAL: Click-to-toggle dropdown + arrow rotation (ONE script only!)
const userGreeting = document.getElementById('user-greeting');

if (userGreeting) {
  const dropdown = userGreeting.querySelector('.profile-dropdown');
  const arrow    = userGreeting.querySelector('.dropdown-arrow');

  userGreeting.addEventListener('click', function(e) {
    const isOpen = dropdown.style.display === 'block';
    dropdown.style.display = isOpen ? 'none' : 'block';
    arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    e.stopPropagation();
  });

  // Close + reset arrow when clicking outside
  document.addEventListener('click', () => {
    dropdown.style.display = 'none';
    arrow.style.transform = 'rotate(0deg)';
  });

  // Optional: close with Escape
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      dropdown.style.display = 'none';
      arrow.style.transform = 'rotate(0deg)';
    }
  });
}
</script>

<script>
// ====================== SECURE PAYSTACK + BACKEND VERIFICATION ======================
const PAYSTACK_PUBLIC_KEY = "pk_test_bc9c09e6d51c4e025bb44c6c57ad1c1144386b55";
let lastGeneratedPdfBlob = null;
let paymentInProgress = false;

function triggerDownload(blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TaxC_Report_${new Date().toISOString().slice(0,10)}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// index.html <script> - Refined verifyWithBackend function

async function verifyWithBackend(reference) {
    try {
        const response = await fetch('https://us-central1-taxc-ebooks.cloudfunctions.net/verifyPayment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reference })
        });

        // IMPORTANT: Check if the HTTP status is NOT OK (i.e., 400, 402, 403, 404, 500)
        if (!response.ok) {
            const errorBody = await response.json();
            console.error("Verification failed with status:", response.status, errorBody.message);
            // Return failure so the callback can handle the failed state
            return { success: false, message: errorBody.message || "Verification Failed." };
        }

        const result = await response.json();
        return result; // Should be { success: true }

    } catch (err) {
        console.error("Backend connection error:", err);
        return { success: false };
    }
}

function payWithPaystack() {
    if (!window.lastCalc) {
        document.getElementById('msg').textContent = 'Please calculate your tax first.';
        return;
    }
    if (paymentInProgress) return;

    const email = prompt("Enter your email for receipt:", "");
    if (!email || !email.includes('@') || !email.includes('.')) {
        alert("Put correct email abeg");
        return;
    }

    paymentInProgress = true;
    const btn = document.querySelector('.report-btn');
    btn.disabled = true;
    btn.textContent = "Opening Paystack...";

    const reference = 'TAXC_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();

    const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: email,
        amount: 90000,
        currency: "NGN",
        ref: reference,
        callback: async function(response) {
            btn.textContent = "Verifying payment...";
            document.getElementById('msg').innerHTML = "We dey confirm your payment...";

            const result = await verifyWithBackend(response.reference);

            if (result.success) {
                document.getElementById('msg').innerHTML = 'Payment confirmed! Generating your PDF...';
                btn.textContent = "Generating PDF...";
                const blob = await generatePDFReport();
                if (blob) {
                    triggerDownload(blob);
                    lastGeneratedPdfBlob = blob;
                    btn.textContent = "Download Again";
                    btn.onclick = () => lastGeneratedPdfBlob && triggerDownload(lastGeneratedPdfBlob);
                    document.getElementById('msg').innerHTML = 'Payment successful! Enjoy your report';
                }
            } else {
                document.getElementById('msg').innerHTML = 'Payment failed or invalid. Try again or contact support@taxc.com.ng';
                btn.textContent = "Try Again";
                btn.onclick = payWithPaystack;
            }
            paymentInProgress = false;
            btn.disabled = false;
        },
        onClose: () => {
            document.getElementById('msg').innerHTML = 'Payment cancelled. Click when ready.';
            btn.textContent = "Pay ‚Ç¶900 & Download PDF";
            btn.disabled = false;
            paymentInProgress = false;
        }
    });
    handler.openIframe();
}

// Attach once
document.querySelector('.report-btn').onclick = payWithPaystack;
</script>
<script>
// Remove the "new visitor" badge after they open the menu once
document.getElementById('hamburger')?.addEventListener('click', function() {
  this.classList.remove('is-new');
  // Optional: remember they‚Äôve seen it (so it doesn‚Äôt come back on refresh)
  localStorage.setItem('taxc_menu_seen', 'true');
});
// Hide the badge if they already opened the menu before
if (localStorage.getItem('taxc_menu_seen') === 'true') {
  document.getElementById('hamburger')?.classList.remove('is-new');
}
</script>

<script>
// FULL SWIPE-TO-CLOSE ‚Äî NOW 100% BUG-FREE (no more faint menu!)
let startY = 0;
let isDragging = false;
const menu = document.getElementById('menu');
const hamburger = document.getElementById('hamburger');

menu.addEventListener('touchstart', e => {
    if (!menu.hasAttribute('open')) return;
    startY = e.touches[0].clientY;
    isDragging = true;
    menu.style.transition = 'none';
});

menu.addEventListener('touchmove', e => {
    if (!isDragging) return;
    e.preventDefault(); // prevent scroll/page jump

    const currentY = e.touches[0].clientY;
    const diff = currentY - startY;

    if (diff > 0) { // only allow swipe down
        menu.style.transform = `translateY(${diff}px)`;
        menu.style.opacity = Math.max(0.3, 1 - diff / 400);
    }
});

menu.addEventListener('touchend', () => {
    if (!isDragging) return;
    isDragging = false;

    const diff = parseInt(menu.style.transform?.match(/-?\d+/g)?.[0] || 0);

    menu.style.transition = 'transform 0.42s cubic-bezier(0.22, 0.61, 0.36, 1), opacity 0.3s';

    if (diff > 120) {
        // User swiped enough ‚Üí close it
        toggleMobileMenu(); // this will also clean up body lock
        // Force reset styles in case of fast swipe
        setTimeout(() => {
            menu.style.transform = '';
            menu.style.opacity = '';
        }, 400); // Increased to match animation
    } else {
        // Not enough ‚Üí snap back
        menu.style.transform = 'translateY(0)';
        menu.style.opacity = '1'; // Add this to reset opacity
    }
});
</script>

<script>
// In case the page reloaded while menu was open ‚Üí clean up
window.addEventListener('load', () => {
    document.body.classList.remove('menu-open');
    document.body.style.overflow = '';
    const menu = document.getElementById('menu');
    if (menu) menu.removeAttribute('open');
});
</script>

<script>
// Emergency reset if page loads in broken state
window.addEventListener('pageshow', (e) => {
    if (e.persisted || window.performance?.type === 1) {
        document.body.classList.remove('menu-open');
        document.body.style.cssText = '';
        document.getElementById('menu')?.removeAttribute('open');
    }
});
</script>

<script>
let savedScrollY = 0; // Global variable to save scroll position

function toggleMobileMenu() {
    const menu      = document.getElementById('menu');
    const backdrop  = document.getElementById('menu-backdrop');
    const hamburger = document.getElementById('hamburger');
    const body      = document.body;

    const isCurrentlyOpen = menu.hasAttribute('open');

    if (isCurrentlyOpen) {
        // ‚îÄ‚îÄ‚îÄ CLOSING THE MENU ‚îÄ‚îÄ‚îÄ
        // Force animation to close position
        menu.style.opacity = '0';
        menu.style.transform = 'translateY(100%)';

        // Proceed with state changes
        menu.removeAttribute('open');
        backdrop.classList.remove('active');
        hamburger.classList.remove('is-active');

        // Unlock body with scroll restore
        body.classList.remove('menu-open');
        body.style.overflow = '';
        body.style.position = '';
        body.style.width = '';
        body.style.height = '';
        body.style.top = '';
        window.scrollTo(0, savedScrollY);

        // Clear inline styles after animation completes
        setTimeout(() => {
            menu.style.transform = '';
            menu.style.opacity = '';
            menu.style.transition = '';
        }, 400); // Matches your transition duration

    } else {
        // ‚îÄ‚îÄ‚îÄ OPENING THE MENU ‚îÄ‚îÄ‚îÄ
        // Save current scroll position
        savedScrollY = window.pageYOffset;
        body.style.top = `-${savedScrollY}px`;

        menu.setAttribute('open', '');
        backdrop.classList.add('active');
        hamburger.classList.add('is-active');

        // Lock the background page
        body.classList.add('menu-open');
        body.style.overflow = 'hidden';
        body.style.position = 'fixed';
        body.style.width = '100%';
        body.style.height = '100%';
    }

    // Remove the ‚Äúnew‚Äù badge forever
    hamburger.classList.remove('is-new');
    localStorage.setItem('taxc_menu_seen', 'true');
}
</script>
    </body>
</html>